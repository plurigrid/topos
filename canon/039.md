\title{
All Concepts are Cat $^{\sharp}$
}

Owen Lynch Brandon T. Shapiro David I. Spivak

\begin{abstract}
We show that the double category $\mathbf{C a}{ }^{\sharp}$ of comonoids in the category of polynomial functors (previously shown by Ahman-Uustalu and Garner to be equivalent to the double category of small categories, cofunctors, and prafunctors) contains several formal settings for basic category theory, provides an elegant description of Weber's nerve construction for generalized higher categories, and has subcategories equivalent to both the double category 0 rg of dynamic rewiring systems and the double category $\mathbb{P o l y ~}_{\mathscr{E}}$ of generalized polynomials in a finite limit category $\mathcal{E}$. Also serving as a natural setting for categorical database theory, $\mathrm{Cat}^{\sharp}$ at once hosts models of a wide range of concepts from the theory and applications of polynomial functors and higher categories.
\end{abstract}

\section*{Contents}
1 Introduction ..... 1
2 The Double Category Cat $^{\#}$ ..... 3
3 Basic Category Theory in Cat $^{\sharp}$ ..... 6
4 Generalized Polynomials in Cat $^{\#}$ ..... 8
5 Lawvere Theories and Nerves of Higher Categories in $C^{\#} t^{\#}$ ..... 9
6 Open dynamics and computational effects in $\mathrm{Cat}^{\#}$ ..... 11
References ..... 13
A Functoriality of $\mathbb{P o l y ~}_{\mathscr{E}} \rightarrow \mathbb{C a t}^{\sharp}$ ..... 14
B Structure of Theories and Nerves ..... 19
C Functoriality of $\mathbb{O} \mathrm{rg} \rightarrow \mathbb{E} \mathrm{ff} \rightarrow \mathbb{C a t}{ }^{\sharp}$ ..... 21

\section*{1 Introduction}

Mac Lane famously declared that "The notion of Kan extensions subsumes all the other fundamental concepts of category theory" referring to the fact that limits, colimits, adjunctions, and the Yoneda lemma can all be defined in terms of Kan extensions, and titled that section "All concepts are Kan extensions".

In the theory of polynomial functors, particularly as it has been explored by the authors, the main avenues of development have been the generalization from polynomials in the category Set to polynomials in other categories [GK12; Web15b; SS23] and applications to categorical database theory [Spi12; Spi21a], open dynamical systems [Spi21b; SS22], and algebraic higher category theory [Web07; Web15a; Sha22]. Recent results of Ahman-Uustalu [AU16; AU17] and Garner show that comonoids in the monoidal category Poly of polynomial endofunctors on Set, coincide with the usual notion of categories, comonoid homomorphisms correspond to cofunctors, and bicomodules between comonoids correspond to parametric right adjoint functors between their associated copresheaf categories (also called prafunctors). In [Spi21a], the author assembled these components into a double category $\mathrm{Cat}^{\sharp}$ and showed it to be a natural setting for categorical database theory. The author and Brown in [BS23] use Cat ${ }^{\sharp}$ as a formal semantics for rewriting protocols, and provide a graphical language for a fragment of it. The goal of the present work is to demonstrate
that $\mathbb{C a} t^{\sharp}$ in fact subsumes the other fundamental concepts of polynomial functor theory as well, and begin to describe how basic category theory, as well as notions in higher category theory, find a home (or many) in Cat ${ }^{\sharp}$.

While the objects of $\mathbb{C} \mathbf{t}^{\sharp}$ are categories and the vertical and horizontal morphisms (cofunctors and prafunctors) are fundamental to the study of their copresheaf categories, functors between the categories themselves are not explicitly present in the data of $\mathbb{C} \mathbf{t}^{\sharp}$, which would seem to limit the usefulness of this setting for modeling basic category theory. Several remedies have been proposed, including by upgrading $\mathbb{C a t}^{\sharp}$ to include higher dimensional data [SS23, Example 5.13] or finding functors in alternative places in $\mathbb{C a t}^{\sharp} .{ }^{1}$ We take the latter approach by considering both monads in the bicategory of spans and algebras for a certain monad on the category of graphs as notions of categories whose morphisms are functors. We show that they both exist in $\mathbb{C a t}^{\sharp}$ and can be recovered from categories regarded as objects in $\mathbb{C a t}^{\sharp}$. We also show that opposites of categories can be recovered using adjoint and monoidal dualization operations in $\mathrm{Cat}^{\sharp}$.

In [SS23], the authors establish the category Poly $_{\mathscr{E}}$ of polynomials in a finite limit category $\mathbb{E}$ and show that a wide range of structures and results previously known for polynomials in Set generalize to this setting. Much like Poly, Poly $_{8}$ is a duoidal category under composition and a generalization of the Dirichlet tensor product, and comonoids in Poly $\mathcal{E}_{\mathcal{E}}$ are precisely the categories internal to $\mathscr{E}$ whose source morphism is exponentiable. Theorem 4.2 shows that Poly $_{\mathcal{E}}$ has a faithful embedding into $\mathbb{C} \mathbf{a}^{\sharp}$, so that in order to study polynomials in any category $\mathscr{E}$ one need only consider structures based on polynomials in Set.

In [Web07], Weber defined a generalization of the Lawvere theory associated to an algebraic structure on sets, the nerve construction for categories, and generalizations of the nerve to various flavors of algebraic higher categories. For a class of monads $m$ including those whose underlying endofunctor is parametric right adjoint, there is a fully faithful "nerve" functor from $m$-algebras to presheaves on a category $\Theta_{m}$. We show in Theorem 5.7 that for any parametric right adjoint monad $m$ on a copresheaf category considered as a monad in $\mathbf{C a t}^{\sharp}$, the category $\Theta_{m}^{\text {op }}$ is the comonoid recovered by a right coclosure operation for composition in $\mathrm{Cat}^{\sharp}$, and the nerve construction is easily recovered using the universal property of the coclosure. This shows that $\Theta_{m}$ has a universal property relative to the monad $m$, and opens the door for the further study of higher category theory in the language of polynomials.

In [Spi21b; SS22], the authors explore how coalgebras for polynomial functors and algebraic structures built from such coalgebras provide a wide-reaching language for modeling dynamical systems which respond to external feedback, and construct the double category $O$ rg as a convenient setting for the study of such "open" dynamics which includes examples from machine learning and economics. Separately in [Lyn22], the author introduces "effects handlers," a mathematical object defined in terms of polynomials which models a way of incorporating side effects into the functional programming paradigm. In Theorem 6.2, we show that effects handlers form the horizontal morphisms of a sub-double category of $\mathbb{C} \mathbf{t}^{\sharp}$, and in Theorem 6.4 we show that $\operatorname{O}$ rg is a sub-double category of effects handlers, so that both effects handlers and coalgebras can be reasoned about in the language of $\mathrm{Cat}^{\sharp}$.

Of course, not all concepts in category theory are Kan extensions (for example, categories are not Kan extensions), and neither is every concept in category theory found in $\mathrm{Cat}^{\sharp}$. However, in both cases the exaggeration is worthwhile because the overwhelming ubiquity and power of the formalism makes it worthy of deep study. The position and function of $\mathbb{C a t ^ { \sharp }}$ within category theory is akin to the position and function of category theory within mathematics. In both cases, having a single unified and concise formalism-one which covers a broad swath of the larger subject and which has controlled notation and terminology, as well as a praxis of useful thought patternsfacilitates practitioners in finding interesting connections between different fields within the larger subject and concisely communicating their findings to others. Moreover, since $\mathrm{Cat}^{\sharp}$ is in some sense the language of data migration [Sch+17], everything in this paper can be implemented on a computer in a unified way.
\footnotetext{
${ }^{1}$ See for instance Todd Trimble's talk at the 2021 Workshop on Polynomial Functors.
}

\section*{Notation}

The symbol $\sum$ denotes an indexed coproduct, the symbol + denotes binary coproduct, and 0 denotes an initial object. For a morphisms $f: A \rightarrow B$ and $C \rightarrow B$ in a category, we will sometimes write $f^{*} C$ for the pullback $A \times_{B} C$.

\section*{Acknowledgments}

This material is based upon work supported by the Air Force Office of Scientific Research under award number FA9550-20-1-0348. We also appreciate the comments of our ACT2023 conference reviewers, in particular Reviewer uG3q.

\section*{2 The Double Category Cat $^{\#}$}

We begin by recalling the definition of the double category $\mathrm{Cat}^{\sharp}$ and the foundational results that make it so broadly applicable.

\subsection*{2.1 The category of polynomials}

Definition 2.1. A polynomial $p$ consists of a set $p(1)$ along with, for each element $I \in p(1)$, a set $p[I]$. We write

$$
p=\sum_{I \in p(1)} y^{p[I]}
$$

for such a polynomial, which is also the form of the associated polynomial functor Set $\rightarrow$ Set. A morphism $\phi$ of polynomials $p \rightarrow q$ is a natural transformation. It can be cast set-theoretically as consisting of a function $\phi_{1}: p(1) \rightarrow q(1)$ along with, for each $I \in p(1)$, a function $\phi_{I}^{\#}: p[I] \leftarrow q\left[\phi_{1} I\right]$. We write Poly for the category of polynomials.

Elements of the set $p(1)$ are called positions of a polynomial $p$, and for each $I \in p(1)$, elements of $p[I]$ are called directions of $p$. The set of all directions of $p$, or the disjoint union of all the sets $p[I]$, is denoted $p_{*}(1)$ and has a canonical function to $p(1)$. If each $p[I] \cong 1$ is singleton, we say that $p$ is linear. A morphism $\phi$ is called cartesian if each $\phi_{I}^{\#}$ is a bijection, and vertical if $\phi_{1}$ is a bijection.

Definition 2.2 ([Spi21a, Proposition 2.1.7]). We denote by $y$ the polynomial with a single position and a single direction. For polynomials $p, q$, their composition is the polynomial

$$
p \triangleleft q:=\sum_{\substack{I \in p(1) \\ J: p[I] \rightarrow q(1)}} y^{\sum_{i \in p l]} q[J i]}
$$

There is a monoidal structure on the category Poly given by $(y, \triangleleft)$, and there are three additional monoidal structures given by
- $(0,+)$, where 0 is the polynomial with no positions, $(p+q)(1):=p(1)+q(1),(p+q)[I]:=p[I]$ for $I \in p(1)$, and $(p+q)[J]:=q[J]$ for $J \in q(1)$;
- $(1, \times)$, where 1 is the polynomial with one position and no directions, $(p \times q)(1):=p(1) \times q(1)$, and $(p \times q)[I, J]:=p[I]+q[J]$; and
- $(y, \otimes)$, where $(p \otimes q)(1):=p(1) \times q(1)$ and $(p \otimes q)[I, J]:=p[I] \times q[J]$.

\subsection*{2.2 Comonoids and bicomodules}

Definition 2.3. A comonoid in Poly is a polynomial $c$ equipped with morphisms $\epsilon: c \rightarrow y$ (the counit) and $\delta: c \rightarrow c \triangleleft c$ (the comultiplication) satisfying unit and associativity equations. A comonoid homomorphism is a morphism of polynomials $c \rightarrow c^{\prime}$ which commutes with counits and comultiplications.

Definition 2.4. For comonoids $c$, $d$ in Poly, a $(c, d)$-bicomodule is a polynomial $p$, called the carrier, equipped with morphisms

$$
c \triangleleft p \stackrel{\lambda}{\leftarrow} p \xrightarrow{\rho} p \triangleleft d
$$

which commute with each other as well as the counits and comultiplications of $c$ and $d$, in the sense of [Spi21a, Definition 2.2.11]. We will often denote a $(c, d)$-bicomodule $p$ as $c \triangleleft \frac{p}{\triangleleft} d$.

In [Spi21a, Corollary 2.2.10], the author established using a theorem of Shulman [Shu08, Theorem 11.5] that there is a double category Comod(Poly) (in fact an equipment) whose objects are comonoids and horizontal morphisms are bicomodules.

Definition 2.5. Cat $^{\sharp}$ is the pseudo-double category Comod(Poly) which has
- as objects, the comonoids in Poly;
- as vertical morphisms, the comonoid homomorphisms;
- as horizontal morphisms from $c$ to $d$, the $(c, d)$-bicomodules;
- as squares between homomorphisms $\phi, \psi$ and bicomodules $p, p^{\prime}$, the morphisms of polynomials $\gamma: p \rightarrow p^{\prime}$ such that the diagram in (1) commutes;

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-04.jpg?height=185&width=480&top_left_y=978&top_left_x=866)
- as horizontal identities, the comultiplication bicomodules $c \triangleleft c \stackrel{\delta}{\leftarrow} \stackrel{\delta}{\rightarrow} c \triangleleft c$; and
- as composition of horizontal morphisms $c \triangleleft p \stackrel{p}{\triangleleft} d \_q u e$, the bicomodule $p \triangleleft_{d} q$ on the top row of (2),

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-04.jpg?height=301&width=702&top_left_y=1362&top_left_x=752)

where each object in the top row of (2) is computed as the equalizer of the column below it, using the fact that the functors $c \triangleleft-$ and $-\triangleleft e$ preserve connected limits, and the maps between them are induced by the underlying transformations between equalizer diagrams. This also shows how to horizontally compose squares, as a pair of adjacent squares provides the data of a transformation of equalizer diagrams which induces a map between the composite bicomodules.

\subsection*{2.3 Categories, cofunctors, and prafunctors}

The motivation for studying Cat $^{\sharp}$ comes from recent results of Ahman-Uustalu [ACU14] and Garner ${ }^{2}$ that, respectively, comonoids in Poly are precisely categories and that bicomodules between them are precisely parametric right adjoint functors (sometimes shortened to prafunctors) between their copresheaf categories. This makes $\mathbb{C a t}^{\sharp}$ a natural setting for categorical database theory [Spi12; Spi21a], where database schemas are categories, instances are copresheaves, and queries (along with more general data migration operations) are prafunctors.

Definition 2.6. For a polynomial comonoid $(c, \epsilon, \delta)$, its corresponding (small) category has
- as objects, elements of the set $c(1)$;
\footnotetext{
${ }^{2}$ We refer to Garner's HoTTEST video, where the proof was sketched; see also [Spi21a].
}
- as morphisms out of an object $C \in c(1)$, the set $c[C]$;
- as codomain assignment for morphisms out of $C$, the function $\delta_{1}(c): c[C] \rightarrow c(1)$;
- as composition of morphisms out of $C$, the function $\delta_{C}^{\sharp}: c[C] \times_{c(1)} c_{*}(1) \rightarrow c[C]$; and
- as the identity morphism at $C$, the function $\epsilon_{C}^{\#}: 1 \rightarrow c[C]$.

To go the other way, suppose given a small category $C$. For any object $C \in \operatorname{Ob}(C)$, let $\mathcal{C}[C]:=\sum_{C^{\prime} \in \mathrm{Ob}(\mathcal{C})} \mathcal{C}\left(C, C^{\prime}\right)$ denote the set of all morphisms emanating from $C$. Then the polynomial comonad for $E$ is carried by the polynomial $c:=\sum_{C \in \operatorname{Ob}(C)} y^{[[C]}$. The counit map $\epsilon: c \rightarrow y$ consists of a choice of morphism out of each object, which we take to be the identity. We leave the unpacking of the comultiplication map $\delta: c \rightarrow c \triangleleft c$-which handles codomains and composition-to the reader; see this video for an elementary unpacking.

So comonoids in Poly are (small) ${ }^{3}$ categories. Comonoid homomorphisms, however, correspond not to functors but to cofunctors.

Definition 2.7 ([Spi21a, Definition 2.2.2]). For categories $c$ and $d$ (regarded as polynomial comonoids), a cofunctor $c \rightarrow d$ is a function $\phi_{1}: c(1) \rightarrow d(1)$ along with, for each $C \in c(1)$, a function $d\left[\phi_{1} C\right] \rightarrow c[C]$ which preserves identities, codomains, and composites.

For $c$ a category, we write $c$-Set for the category of copresheaves on $c$, meaning functors $c \rightarrow$ Set. For $X$ a $c$-copresheaf and $C \in c(1)$ an object, we write $X_{C}$ for $X(C) \in$ Set.

Definition 2.8. A parametric right adjoint functor $F: d$-Set $\rightarrow c$-Set is a functor with the following form, for any $d$-copresheaf $X$ and object $C \in c(1)$,

$$
F(X)_{C}=\sum_{I \in p_{C}(1)} \operatorname{Hom}_{d-\operatorname{Set}}(p[I], X)
$$

where $p_{(-)}(1)$ is a functor $c \rightarrow$ Set, $p_{C}(1)$ is its evaluation at $C$, and $p[-]$ is a functor $\left(\int p_{(-)}(1)\right)^{\text {op }} \rightarrow$ $d$-Set from the dual of the category of elements of $p_{(-)}(1)$.

When $p$ is a $(c, d)$-bicomodule and $C \in c(1)$, we have $p(1) \cong \sum_{C \in c(1)} p_{C}(1)$, and we recover $p_{C}(1)$ as the preimage of $C$ under the function $p(1) \xrightarrow{\lambda(1)}(c \triangleleft p)(1) \xrightarrow{c \triangleleft!} c(1)$. Moreover, for $I \in p_{C}(1)$ and $D \in d(1)$, the set $p[I]_{D}$ is the preimage of $D$ under the function $p[I] \rightarrow d(1)$ given by the element

$1 \xrightarrow{I} p(1) \xrightarrow{\rho(1)}(p \triangleleft d)(1)$.

Based on this interpretation, we will often denote a $(c, d)$-bicomodule $p$ as

$$
\sum_{C \in c(1)} \sum_{I \in p_{C}(1)} y^{p[I]}
$$

where $p[I]$ is presumed to have the structure of a $d$-copresheaf.

Example 2.9. For any set $A$, the linear polynomial $A y$ has a unique comonoid structure; it corresponds to the discrete category on $A$. Cofunctors $A y \rightarrow B y$ are functions $A \rightarrow B$.

Example 2.10. For $c$ any category, a ( $c, 0$ )-bicomodule $p$ is a parametric right adjoint functor from 0 -Set, the terminal category, to $c$-Set. The particular copresheaf on $c$ this functor picks out is $p_{(-)}(1)$, whose elements are positions of $p$ and whose $c$-copresheaf structure is determined by the map $c \triangleleft p \stackrel{\gtrless}{\leftarrow}$. As there is also a map $p \rightarrow p \triangleleft 0$ which preserves the positions of $p$, and forces the polynomial $p$ to have an empty set of directions. The category of $(c, 0)$-bicomodules and maps between them as in (1) with $\phi, \psi$ identities is equivalent to the category $c$-Set.

The composition of a $(c, d)$-bicomodule and a $(d, 0)$-bicomodule is precisely the $c$-copresheaf given by applying the prafunctor $d$-Set $\rightarrow c$-Set to a $d$-copresheaf.
\footnotetext{
${ }^{3}$ From now on, we may refer to comonoids in Poly simply as categories, rather than emphasizing their smallness.
}

Example 2.11. More generally, a parametric right adjoint functor $d$-Set $\rightarrow c$-Set is a right adjoint precisely when it arises from a profunctor from $c$ to $d$ : a copresheaf on $c^{\text {op }} \otimes d$ induces a functor $c^{\mathrm{op}} \rightarrow d$-Set whose corresponding singular functor is a right adjoint $d$-Set $\rightarrow c$-Set. However, unlike when $d$ is discrete, the left adjoint of this prafunctor will not generally be a prafunctor itself.

\section*{3 Basic Category Theory in Cat $^{\sharp}$}

While cofunctors and prafunctors are interesting and useful branches of category theory, they are not the stuff of a category theorist's typical toolbox. However, traditional features of category theory can also be recovered in $\mathbb{C a t}^{\sharp}$ by various means which we now discuss.

\subsection*{3.1 Products and coproducts}

Both monoidal products $\otimes$ and + have a duoidal relationship with composition $\triangleleft$, meaning there are natural morphisms

$$
\begin{equation*}
(p \triangleleft q) \otimes(r \triangleleft s) \rightarrow(p \otimes r) \triangleleft(q \otimes s) \quad \text { and } \quad(p \triangleleft q)+(r \triangleleft s) \rightarrow(p+r) \triangleleft(q+s) \text {. } \tag{3}
\end{equation*}
$$

As a general consequence of duoidality, comonoids in Poly are closed under + and $\otimes$.

Theorem 3.1 ([Spi21a, Proposition 2.6.2]). For categories $c, d$ regarded as polynomial comonoids, $c+d$ corresponds to the usual coproduct and $c \otimes d$ to the usual product of $c$ and $d$ as categories. Similarly, 0 corresponds to the empty category and $y$ to the terminal category.

Example 3.2. For categories $c, d$, there is a bicomodule $c \otimes d \triangleleft \frac{c \times d}{\Delta} c+d$ where the set $(c \times d)(1)=$ $c(1) \times d(1)$ forms the elements of the terminal copresheaf on $c \otimes d$ and each direction set $(c \times d)[C, D]=$ $c[C]+d[D]$ forms the elements of the copresheaf $(c[C], d[D])$ in $(c+d)$-Set $\simeq c$-Set $\times d$-Set. The corresponding prafunctor sends the pair $(X, Y$ ) of copresheaves $X$ on $c$ and $Y$ on $d$ to the copresheaf $X \otimes Y$ on $c \otimes d$ with

$$
\begin{aligned}
(X \boxtimes Y)_{C, D} & =\operatorname{Hom}_{(c+d)-\operatorname{Set}}((c[C], d[D]),(X, Y)) \\
& \cong \operatorname{Hom}_{c-\text { Set }}(c[C], X) \times \operatorname{Hom}_{d-\operatorname{Set}}(d[D], Y) \cong X_{C} \times Y_{D}
\end{aligned}
$$

because $c[C]$ and $d[D]$ correspond to representable copresheaves. The prafunctor we have thus described is sometimes called the external product on copresheaves.

\subsection*{3.2 Three homes for categories}

We now show how categories live in $\mathbf{C a t}^{\sharp}$ in at least three different ways, and how to mediate between them. Categories are, simultaneously:
- comonoids in Poly, and hence objects in Cat ${ }^{\sharp}$ (Definition 2.6);
- algebras for the parametric right adjoint monad path on graphs (Definition 3.4) [Mac98, Section II.7]; and
- monads in the double subcategory of $\mathbf{C a t}^{\sharp}$ consisting of linear comonoids and linear bicomodules (spans) [Bén+67, p. 5.4.3].

Definition 3.3. We denote by $g$ the category $e \underset{t_{t}}{\stackrel{s}{\rightrightarrows}} v$ whose copresheaves are precisely graphs, and by $\vec{n}$ the graphs with vertices $0, \ldots, n$ and edges $i-1 \rightarrow i$ for all $1 \leq i \leq n$.

Definition 3.4. The bicomodule $g \stackrel{\text { path }}{\triangleleft} g$ has carrier given by $\{v\} y+\{e\} \sum_{n \in \mathbb{N}} y^{\vec{n}}$, where the labels $e, v$ indicate how the left coaction is defined on positions.

This is a monad in $\mathrm{Cat}^{\sharp}$ whose corresponding prafunctor is the free category monad on graphs: it is the identity on vertices and adds in formal associative composites for paths of edges with any length $n$, which are precisely the maps into a graph from $\vec{n}$ [Lei04, Example C.3.3]. A category is then precisely a graph $X$, which can be modeled as a $(g, 0)$-bicomodule, equipped with a left module structure of the form path $\triangleleft_{g} X \rightarrow X$.

Given a category $c$, there is a bicomodule $g \triangleleft \stackrel{\{v\} c+\{\ell\} c_{*}}{c} c$, where $c_{*}:=\sum_{C \in c(1)} c[C] y^{[C C]}$. The left $g$-comodule structure arises from the cartesian source and target morphisms $c_{*} \rightarrow c$, while the right $c$-comodule structure is given by the comultiplication $c \rightarrow c \triangleleft c$ and its composition with the source morphism $c_{*} \rightarrow c$.

The corresponding prafunctor $c$-Set $\rightarrow g$-Set sends a copresheaf $X$ on $c$ to the graph for which a vertex is an element of $X$ and an edge is a pair of a morphism in $c$ and an element of $X$ over its source object. This is precisely the underlying graph of the category of elements of $X$, and as such $c+c_{*}$ has a left path-module structure path $\triangleleft_{g}\left(c+c_{*}\right) \rightarrow c+c_{*}$ which induces by precomposition a left path-module on $\left(c+c_{*}\right) \triangleleft_{c} X$ for any copresheaf $X$ : this path-algebra is precisely X's category of elements. Applying this to the terminal copresheaf $c \stackrel{\text { c(1) }}{ } \triangleleft 0$ recovers the category $c$ itself as a path-algebra.

Furthermore, for any functor $f$ from $c$ to $d$, there is a bicomodule $c \triangleleft \stackrel{\Delta_{f}}{\triangle} d$, where $\Delta_{f}:=$ $\sum_{C \in c(1)} y^{d[f(C)]}$. It comes equipped with a canonical morphism $\left(c+c_{*}\right) \triangleleft_{c} \Delta_{f} \rightarrow d+d_{*}$ of $(c, d)$ bicomodules which commutes with the path-module structures of $c+c_{*}$ and $d+d_{*}$. As $\Delta_{f} \triangleleft_{d} d(1) \cong c(1)$ as ( $c, 0$ )-bicomodules, we have constructed in $\mathrm{Cat}^{\sharp}$ the morphism of path-algebras corresponding to the functor $f$.

We now describe how each object in $\mathbf{C a t}^{\sharp}$ also gives rise to a monad among spans, using the fact that for discrete categories $A y, B y$ an $(A y, B y)$-bicomodule $p$ can be summarized by a diagram

$B \stackrel{g}{\leftarrow} p_{*}(1) \rightarrow p(1) \xrightarrow{f} A$ of sets and functions. The left coaction $A y \triangleleft p \leftarrow p$ is cartesian and given on positions by $\langle f, \mathrm{id}\rangle: p(1) \rightarrow A \times p(1)$, and the right coaction $p \rightarrow p \triangleleft B y$ is also cartesian and on positions sends $I \in p(1)$ to $\left(I, g_{p[I]}: p[I] \rightarrow B\right)$.

For any category $c$, there is a bicomodule $c(1) y \triangleleft c$ c(1)y given by the diagram

$$
c(1) \stackrel{t}{\leftarrow} c_{*}(1) \xrightarrow{s} c(1) \xrightarrow{\text { id }} c(1)
$$

where the left and middle functions are respectively the target and source functions from the set $c_{*}(1)$ of morphisms in $c$ to the set of objects $c(1)$.

By [Spi21a, Proposition 2.5.4], a bicomodule between discrete categories whose rightmost function is an identity is always a right adjoint in $\mathbf{C a t}^{\sharp}$, whose left adjoint is the bicomodule given by the diagram

$$
c(1) \stackrel{s}{\leftarrow} c_{*}(1) \xrightarrow{\mathrm{id}} c_{*}(1) \xrightarrow{t} c(1) .
$$

By [Spi21a, Proposition 2.5.6] as $c(1) \triangleleft c$ c is a linear monad in $\mathbb{C} \mathbf{a t}^{\sharp}$, i.e. a monad in $\mathbb{S p a n}$, i.e. a category. This gives a third home for the category $c$. As desired, for categories $c, d$ a functor between them is a monad map between their corresponding left adjoint spans, so this provides another encoding of functors in $\mathrm{Cat}^{\sharp}$.

\subsection*{3.3 Opposites}

Representing categories as spans allows for a construction of dual categories using only universal constructions in Cat ${ }^{\sharp}$. In [Spi21a, Proposition 2.7.3], the author defines a closure for the category of $(c, d)$-bicomodules. When $c=A y$ and $d=B y$, this has the form

$$
A_{y}[p, q]_{B y}:=\sum_{\substack{a \in A \\ \phi: p_{a} \rightarrow q_{a}}} y^{\left[\in p_{a}(1)\right.} q\left[\phi_{1}(I)\right]
$$
where the maps $p_{a} \rightarrow q_{a}$ are morphisms of $(y, B y)$-bicomodules. We can then define a dualizing operation for $(A y, B y)$-bicomodules by setting

$$
p^{\vee}:=A_{A y}[p, A B y]_{B y}=\sum_{a \in A} \operatorname{Hom}\left(p_{a}, B y\right) y^{p_{a}(1)}
$$

In particular, this dual interpolates between left-adjoint bicomodules of the form $B \leftarrow C=C \rightarrow A$ and right-adjoint bicomodules of the form $B \leftarrow C \rightarrow A=A$.

This allows spans from $A$ to $A$, modeled as left-adjoint $(A y, A y)$-bicomodules, to be reversed using only adjunctions and duals: given a left adjoint $p$ represented by $A \stackrel{f}{\leftarrow} C=C \xrightarrow{g} A$, its adjoint $p+$ is represented by $A \stackrel{g}{\leftarrow} C \xrightarrow{f} A=A$ and its dual $p^{\vee}$ by $A \stackrel{f}{\leftarrow} C \xrightarrow{g} A=A$, so both $(p+)^{\vee}$ and $\left(p^{\vee}\right)+$ are represented by $A \stackrel{f}{\leftarrow} C=C \xrightarrow{g} A$, the reverse of $p$.

Theorem 3.5. For c a category regarded as a (c(1), c(1))-bicomodule, its opposite category $c^{\text {op }}$ is given by the $(c(1), c(1))$-bicomodule $\left(c^{\top}\right)^{\vee} \cong\left(c^{\vee}\right)+$.

\section*{4 Generalized Polynomials in $\mathbb{C a t}^{\sharp}$}

Much of the development of the theory of polynomials (for instance [GK12; Web15b; SS23]) is focused on generalizing the basic aspects of the theory to categories other than Set. We show that, in fact, these categories of polynomials embed fully faithfully into categories of bicomodules, so that the constructions in these contexts are in fact merely specializations of the analogous constructions for bicomodules in $C{ }^{\#}$.

\subsection*{4.1 Polynomials in a category $\mathcal{E}$}

Throughout this section, let $\mathcal{E}$ be a category with finite limits. Polynomials in $\mathcal{E}$ will generalize the definition of polynomials as morphisms $p_{*}(1) \rightarrow p(1)$ in Set.

Definition 4.1. A polynomial in $\mathscr{E}$ is an exponentiable morphism $p: P_{*} \rightarrow P$ in $\mathscr{E}$, and a morphism of polynomials $p \rightarrow q$ in $\mathscr{E}$ consists of a morphism $P \rightarrow Q$ and a morphism $P_{*} \leftarrow P \times_{Q} Q_{*}$. A typed polynomial from $D$ to $C$ in $\mathscr{E}$ is a diagram $D \leftarrow P_{*} \rightarrow P \rightarrow C$ such that $P_{*} \rightarrow P$ is exponentiable, with morphisms defined similarly (Definition A.1).

We denote by Poly $\mathscr{E}_{\mathscr{E}}$ the category of polynomials in $\mathscr{E}$. Typed polynomials form the horizontal morphisms of a double category $\mathbb{P o l y ~}_{\mathscr{E}}$ under composition (Definition A.1), and this makes Poly $\mathscr{E}_{\mathscr{E}}$ a monoidal category [SS23, Section 3.2]. As discussed in [SS23, proof of Theorem 3.15], the category Poly $_{\mathscr{E}}$ embeds fully faithfully into Poly ${ }_{a-S e t}$ for $F: a^{\text {op }} \rightarrow \mathcal{E}$ any fully faithful dense functor, e.g. $a:=\mathcal{E}^{\mathrm{op}}$. For such an $F$, let $F^{*}: \mathcal{E} \rightarrow a$-Set be given by $F^{*}(C)(A):=\mathcal{E}(F(A), C)$.

Theorem 4.2 (Proven as Theorem A.2). For a fully faithful dense functor $F: a^{\mathrm{op}} \rightarrow \mathcal{E}$, the category Poly $\mathcal{E}$ embeds fully faithfully and strong monoidally into the horizontal category $\mathbb{C a t}^{\sharp}(a, a)$. In particular, for a polynomial $P_{*} \rightarrow P$ in $\mathcal{E}$, the corresponding $(a, a)$-bicomodule is given by

$$
\sum_{A \in a(1)} \sum_{x: F(A) \rightarrow P} y^{F^{*}\left(x^{*} P_{*}\right)}
$$

More generally, there is a locally fully faithful double functor from $\mathbb{P o l y}_{\mathcal{E}}$ to $\mathbb{C a t}^{\sharp}$. It sends an object $C$ to the slice category $F / C \cong \int F^{*}(C)$, and a typed polynomial $D \leftarrow P_{*} \rightarrow P \rightarrow C$ to the $(F / C, F / D)$-bicomodule

$$
\sum_{\substack{A \in a(1) \\ F(A) \rightarrow C}} \sum_{x \in \operatorname{Hom}_{/ C}(F(A), P)} y^{F^{*}\left(x^{*} P_{*}\right)}
$$

\subsection*{4.2 Structures in Poly $\mathcal{\&}_{8}$ and $\mathbb{C a t}^{\sharp}$}

Following [Spi21a, Proposition 2.7.1], the category of $(c, d)$-bicomodules has a monoidal structure $\left(c(1) y^{d(1)},{ }_{c} \otimes_{d}\right)$ where the tensor product is given by

$$
p_{c} \otimes_{d} q:=\sum_{C \in c(1)} \sum_{(I, J) \in p_{c}(1) \times q_{c}(1)} y^{\left.p[I] \times_{d(1)} q[]\right]}
$$

where the fiber product $x_{d(1)}$ of directions is the product on $d$-copresheaves. The composition product $\triangle$ has a right coclosure $[-\underset{-}{-}]$ (Definition 5.1).

In [SS23, Chapter 4], a tensor product $\otimes$, closure for $\otimes$, and coclosure for $\triangle$ are defined in Poly ${ }_{\varepsilon}$, though the latter two require additional assumptions on the category $\mathcal{E}$.

Corollary 4.3 (Proven as Corollaries A. 3 and A.4). The monoidal functor of Theorem 4.2 is lax monoidal with respect to $\otimes$ and ${ }_{a} \otimes_{a}$, and preserves $\triangleleft$-coclosures up to coherent natural isomorphisms when they exist.

The failure of strong monoidality here arises from the fact that in the category $a$-Set, the fibers of a product of morphisms are given not by products of fibers but by fiber products.

\section*{5 Lawvere Theories and Nerves of Higher Categories in $\mathbb{C a t}^{\#}$}

The nerve functor from categories to simplicial sets allows the algebraic structure of a category to be modeled using only the geometric structure of combinatorial simplices. Variants of the nerve construction proliferate in the literature for various flavors of higher categories, such as 2categories, multicategories, and double categories, each landing in a presheaf category whose cell shapes correspond to the composable shapes in the higher category structure. Nerves are in fact a generalization of models for Lawvere theories, which also model algebraic structures on sets as presheaves.

Most of these structures, including all nerves and the Lawvere theories corresponding to $\sigma$-free symmetric operads (or in the multisorted case, multicategories), arise as algebras for a monad on a presheaf category whose underlying endofunctor is a parametric right adjoint: that is, a monad in Cat $^{\sharp}$. In fact, for any such monad we can define its (generalized) Lawvere theory and the corresponding nerve construction using only categorical operations in $\mathbb{C a t}^{\sharp}$.

\subsection*{5.1 Familial monads and theory categories}

The path monad on graphs (see Definition 3.4), whose algebras are categories, is an example of a "familial" monad: one whose underlying endofunctor is a parametric right adjoint on a presheaf category, and hence arises from a monad in $\mathbb{C} \mathbf{t}^{\sharp}$. There are many examples of such monads whose algebras are various types of higher and "lower" categories, such as:
- any $\Sigma$-free symmetric operad corresponds to a familial monad on sets [Lei04, Example C.2.5];
- the free $n$-category monad on $n$-graphs (also known as $n$-globular sets) [Lei04, Proposition F.2.3];
- the free double category monad on double graphs [Sha22, Example 1.14];
- the free (symmetric or nonsymmetric) multicategory monad on multigraphs ${ }^{4}$ [Web07, Example 2.14]; and
- the free symmetric monoidal category monad on graphs. ${ }^{5}$

In each case there is a category $c$ and a $(c, c)$-bicomodule

$$
m=\sum_{C \in c(1)} \sum_{M \in m_{C}(1)} y^{m[M]}
$$
\footnotetext{
${ }^{4}$ We use the category theorists' convention that graphs are by default directed with loops and multiple edges, so that the term "multigraph" may refer to the data underlying a multicategory.

${ }^{5}$ This example is explained in some detail at https:// youtu.be / u8XCiI-ZSHc?t=10.
}
where $c$-sets model the "cells" of the higher categories in question, and the arities $m[M]$ are the copresheaves on $c$ describing the arrangements of cells which can be composed into a $C$-cell, such as the graphs $\vec{n}$ which compose to a morphism in a category. The monad structure ensures that the operations $M \in m(1)$ are closed under identities and substitutions.

Much like categories, for which the nerve is a simplicial set with an $n$-simplex for each arrangement of $n$ adjacent edges in the category, higher categories also have nerves which are copresheaves on a theory category, whose objects are the operations and whose morphisms are given by maps between the free algebras generated by the arities. This category is typically defined as a full subcategory of free $m$-algebras, but Cat $^{\sharp}$ provides a definition in terms of universal properties via the right coclosure of the composition product.

Definition 5.1 ([Spi21a, Proposition 2.4.6]). For a $(d, e)$-bicomodule $q$, the functor $-\triangleleft_{d} q$ from $(c, d)$ bicomodules to $(c, e)$-bicomodules has a left adjoint $\left[\begin{array}{l}q \\ -\end{array}\right]$. For a $(c, e)$-bicomodule $p$ its carrier is defined to be

$$
\left[\begin{array}{l}
q  \tag{4}\\
p
\end{array}\right]:=\sum_{C \in c(1)} \sum_{I \in p c(1)} y^{q_{e} p[I]},
$$

where $p[I]$ is regarded as a $(e, 0)$-bicomodule.

The unit of this adjunction is a canonical morphism of $(c, e)$-bicomodules $p \rightarrow\left[\begin{array}{l}q \\ p\end{array}\right] \triangleleft_{d} q$. The coclosure from Eq. (4) corresponds to the left Kan extension
![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-10.jpg?height=178&width=768&top_left_y=1164&top_left_x=670)

Definition 5.2. For $m$ a monad on $c$ in Cat $^{\sharp}$, its theory category $\Theta_{m}$ is the opposite of the $(c, c)$ bicomodule $\left[\begin{array}{c}m \triangle_{c} m \\ m\end{array}\right]$, which by Lemma B. 1 has the structure of a comonoid in $\mathbb{C} \mathbf{t}^{\sharp}$ and whose carrier is by Lemma 5.3 a category.

Lemma 5.3 (Dual to [CS10, Remark 5.15]). For c a polynomial comonoid, given a (c,c)-bicomodule e with the structure of a $\left(c, \triangleleft_{c}\right)$-comonoid, the carrier polynomial e itself forms a comonoid equipped with a homomorphism to c.

Unwinding this definition, the category $\Theta_{m}$ has as objects $m(1)$, the set of operations of $m$, and as morphisms into $M$ the set $m \triangleleft_{c} m \triangleleft_{c} m[M]=\sum_{M^{\prime} \in m(1)} \operatorname{Hom}_{c \text {-Set }}\left(m\left[M^{\prime}\right], m \triangleleft_{c} m[M]\right)$ of Kleisli morphisms from $m\left[M^{\prime}\right]$ to $m[M]$ for the familial monad $m$ on $c$-Set. This agrees with Weber's category $\Theta_{T}$ [Web07, above Definition 4.4] when $T$ is taken to be the familial monad on $c$-Set corresponding to $m$, using the correspondence between Kleisli morphisms and maps between free algebras.

Example 5.4. For the monad path, the theory category $\Theta_{\text {path }}$ has as objects the set $\{0\}+\mathbb{N}$ of natural numbers with two distinct copies of 0 and as morphisms $k \rightarrow \ell$ Kleisli arrows $\vec{k} \rightarrow$ path $\triangleleft_{g} \vec{\ell}$, or equivalently functors path $\triangleleft_{g} \vec{k} \rightarrow$ path $\triangleleft_{g} \vec{\ell}$, where the domain and codomain are the ordinal categories $[k]$ and $[\ell]$. Thus $\Theta_{\text {path }}$ coincides with the simplex category $\Delta$, albeit with two isomorphic copies of the terminal category path $\triangle \overrightarrow{0},{ }^{6}$ corresponding to the nerve of a category being a simplicial set, equivalently a $\left[\begin{array}{c}\text { path } \\ \text { path path }\end{array}\right]$-comodule.

Example 5.5. This construction also recovers the appropriate type of presheaves for the nerves of various types of higher categories:
\footnotetext{
${ }^{6}$ This choice of category in the equivalence class of $\Delta$ admits a cofunctor from its opposite category to $g$, and is used in [Sha22, Section 6] as a convenient convention for general theory categories.
}
- the theory category for the free $n$-category monad is Joyal's category $\Theta_{n}$, whose objects are free pasting diagrams of globular cells up to dimension $n$ [Web07, Example 4.18];
- for the free double category monad it is $\Delta \times \Delta$ whose objects are finite grids; and
- for the free (symmetric/nonsymmetric) multicategory monad it is the (ordinary/planar) dendroid category $\Omega$ whose objects are planar trees (in the symmetric case equipped with a permutation on the leaves) [Web07, Example 2.14].

For some monads, such as $\Sigma$-free symmetric operads, it is desirable to have the objects of the theory category be indexed not by the operations of the monad itself, but rather by the operations of some other bicomodule. Given a monad $m$ on $c$ in $\mathrm{Cat}^{\sharp}$ and a ( $d, c$ )-bicomodule $p$, the coclosure $(d, d)$-bicomodule $\left[\begin{array}{c}p \triangle_{c} m \\ p\end{array}\right]$ forms a comonad on $d$ (Lemma B.1) and corresponds to the opposite of the full subcategory of the Kleisli category of $m$ spanned by the $c$-copresheaves of the form $p[I]$. We call the opposite of this category $\Theta_{m}^{p}$.

Example 5.6. For $O$ a $\Sigma$-free symmetric operad regarded as a polynomial monad and list the polynomial $\sum_{N \in \mathbb{N}} y^{\underline{N}}$ whose arity $\underline{N}$ is the finite set $\{1, \ldots, N\}$, the category $\left[\begin{array}{c}\text { listaO } \\ \text { list }\end{array}\right]$ is the opposite of the skeleton of the category of finitely generated free $O$-algebras. This is precisely the Lawvere theory corresponding to the finitary monad associated to $O$ [Web07, Example 4.15]. The theory category $\Theta_{0}$, by comparison, may have many more objects (one for each operation in $O$ rather than one for each finite arity) and does not necessarily include all finite arities as $O$ may have no $N$-ary operations for certain $N$.

\subsection*{5.2 Nerves}

Given a monad $m$ on $c$ in $\mathrm{Cat}^{\sharp}$ and a ( $d, c$ )-bicomodule $p$, to construct from an $m$-algebra a presheaf on $\Theta_{m}^{p}$, equivalently a $\left(\left[\begin{array}{c}c \triangle_{c} m \\ p\end{array}\right], 0\right)$-bicomodule, we use the fact that copresheaves on $\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right]$ are equivalent to left $\left[\begin{array}{c}p \varsigma_{c} m \\ p\end{array}\right]$-comodules among $(d, 0)$-bicomodules (Lemma B.2).

For an $m$-algebra $A$ then, modeled as a ( $c, 0$ )-bicomodule with a left module structure $m \triangleleft_{c} A \rightarrow A$, its nerve has as elements $p \triangleleft_{c} A$. This copresheaf on $c$ has the structure of a $\left[\begin{array}{c}p ⿰_{c} m \\ p\end{array}\right]$-comodule as constructed in (5), giving it the structure of a presheaf on $\Theta_{m}^{p}$.

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-11.jpg?height=192&width=588&top_left_y=1663&top_left_x=758)

Theorem 5.7 (Proved as Theorem B.3). This construction of the nerve of an $m$-algebra is a $\Theta_{m}^{p}$-presheaf which when $p=m$ agrees with the nerve given by Weber in [Web07, Definition 4.4].

Note that an element of $m \triangleleft_{c} A$ consists of an operation $M \in m_{C}(1)$ and a map of $c$-copresheaves $m[M] \rightarrow A$, equivalently a map of $m$-algebras from $m \triangleleft_{c} m[M]$ to $A$, precisely the definition of an $M$-cell in Weber's nerve of $A$ from [Web07, Definition 4.4].

\section*{6 Open dynamics and computational effects in $\mathbb{C a t}^{\sharp}$}

Algebraic effects and effect handlers are a popular way of working with side effects in functional programming languages and they have received much research and development in the last decade, both via new languages and integration into current functional languages like OCaml, Haskell, and Scala [Lei14; BP15; Pro22; Kin22; Ode22].

The idea is that instead of directly implementing side effects, an effectful program should instead signal that a side effect should be performed, and another program should "handle" that signal,
afterwards returning control flow to the original program along with the result of that effect. The advantage of this is that side effects can be handled in different ways. For instance, the side-effect of accessing a database could be implemented with an in-memory database, an on-file database, a dummy database, or a database distributed across the entire world. The application logic should be indifferent to this implementation.

We can model a program that uses effects as a polynomial coalgebra, i.e. a set of "states" $S$ along with a function $\vartheta: S \rightarrow p(S)$ for some polynomial $p$. The positions $I \in p(1)$ represent the different effects that can be "thrown", and then the directions $x \in p[I]$ represent the possible results of that effect returned to the program. Given a state $s \in S, \vartheta(s)$ represents running the program until the next effect is thrown, and then returning that effect $I$ along with a continuation function $p[I] \rightarrow S$ saying what the next state is given the result of the effect. A position $I \in p(1)$ with $p[I]=\emptyset$ signals termination of the program.

An effect handler is then something which "migrates" a $p$-coalgebra to a $q$-coalgebra. For instance, this could translate abstract database accesses into UNIX system calls to the network stack.

\subsection*{6.1 Effects handlers}

Definition 6.1. For polynomial comonoids $c, d$, a $(c, d)$-effects handler is a pair $(s, \varphi)$ where $s$ : Poly and $\varphi$ is a morphism $c \triangleleft S \stackrel{\varphi}{\leftarrow} s d$ which commutes with counits and comultiplications in the sense of Eq. (14). We say it is linear if $s=S y$ for some $S$ : Set.

For polynomials $p, q$, a $(p, q)$-effects handler is a polynomial $s$ equipped with a morphism $p \triangleleft s \stackrel{\varphi}{\leftarrow}$ $s \triangleleft q$. We refer to these as elementary effects handlers. As one might expect, elementary effects handlers can be regarded as effects handlers; see Proposition C.4.

For a $(c, d)$-effects handler $s$ and a $(d, e)$-effects handler $t$, we get a $(c, e)$-effects handler $s \triangleleft t$ given by the composite $c \triangleleft \triangleleft \triangleleft t \leftarrow s \triangleleft d \triangleleft t \leftarrow s \triangleleft t \triangleleft e$, and given comonoid homomorphisms $c \rightarrow c^{\prime}$ and $d \rightarrow d^{\prime}$ we can define a square from a $(c, d)$-effects handler $s$ to a $\left(c^{\prime}, d^{\prime}\right)$-effects handler $s^{\prime}$ as a morphism of polynomials $s \rightarrow s^{\prime}$ which commutes with the effects handler structure maps. In this way, comonoids, homomorphisms, effects handlers, and squares between them form a pseudo-double category $\mathbb{E f f}$. There is similarly a pseudo-double category $\mathbb{E} f{ }^{\mathrm{el}}$ of elementary effects handlers without the comonoid structure on objects or morphisms, which includes into $\mathbb{E f f}$ by the cofree comonoid functor $\mathrm{c}$ from Proposition C.1.

In fact, any $(c, d)$-effects handler $(s, \varphi)$ induces a $(c, d)$-bicomodule $c \varangle \Delta \_d \triangleleft d$ with left and right structure maps $(\varphi \triangleleft d) \circ\left(s \triangleleft \delta_{d}\right)$ and $s \triangleleft \delta_{d}$, as in (6)

$$
\begin{equation*}
c \triangleleft s \triangleleft d \stackrel{\varphi \triangleleft d}{\rightleftarrows} s \triangleleft d \triangleleft d \stackrel{s \triangleleft \delta_{d}}{\longleftrightarrow} s \triangleleft d \xrightarrow{s \triangleleft \delta_{d}} s \triangleleft d \triangleleft d . \tag{6}
\end{equation*}
$$

Theorem 6.2 (Proved as C.5). The pseudo-double category of effects handlers admits a pseudo-double functor $\mathbb{E} f f \rightarrow \mathbb{C a t}^{\sharp}$ which is the identity on objects and vertical morphisms and which is faithful on the category of horizontal morphisms between nonempty categories and squares between them. Moreover, every $(c, 0)$ - and $(c, y)$-bicomodule is in the essential image.

\subsection*{6.2 Polynomial coalgebras and the double category $\bigcirc$ rg}

Definition 6.3. The closure $[-,-]$ of the monoidal structure $(y, \otimes)$ on Poly is given by

$$
[q, p]:=\sum_{\phi: q \rightarrow p} y^{\sum_{\varepsilon q(1)} p\left[\phi_{1} I\right]}
$$

for polynomials $p, q$. A $[q, p]$-coalgebra is a set $S$ equipped with a function $S \rightarrow[q, p](S)$.

In [Spi21b; SS22], the authors describe a double category 0 rg whose vertical category is that of polynomials, whose horizontal morphisms from $q$ to $p$ are the $[q, p]$-coalgebras $S \rightarrow[q, p] \triangleleft S$, and whose squares are maps $S \rightarrow S^{\prime}$ satisfying a certain commutativity condition. Monoidal categories and operads enriched in $\bigcirc \mathbf{r g}$ include the process of training a deep learning system and running a prediction market.

It turns out that the category of $[q, p]$-coalgebras is equivalent to that of elementary $(p, q)$-effects handlers of the form $(S y, \varphi)$ for some $S$ : Set, i.e. whose carrier is linear, ${ }^{7}$ an assignment which furthermore extends to the entire structure of 0 rg.

Theorem 6.4 (Proved as Theorem C.9). There is a pseudo-double functor $\bigcirc \mathbf{r g} \rightarrow \mathbb{E f f l}^{\mathrm{el}}$ which is the identity on objects and vertical morphisms and fully faithful on the category of horizontal morphisms and squares, with essential image given by the linear elementary effects handlers.

We have now defined a string of locally fully faithful pseudo-double functors

$$
\mathbb{O} \mathrm{rg} \rightarrow \mathbb{E} \mathrm{ff}^{\mathrm{el}} \rightarrow \mathbb{E} \mathrm{ff} \rightarrow \mathbb{C a t}^{\sharp}
$$

which acts by c: Poly $\rightarrow$ Poly on the vertical category and sends a coalgebra $S \rightarrow[q, p](S)$ to the $\left(\mathfrak{c}_{p}, \mathfrak{c}_{q}\right)$-effects handler $\mathfrak{c}_{p} \triangleleft S y \leftarrow S y \triangleleft \mathfrak{c}_{q}$ sending a state $s_{0} \in S$ and a $q$-behavior tree $T$ to the behavior tree of $p$ obtained by running the coalgebra on $s_{0}$ and each state reached by the paths through $T$, labeled by the states reached along the way.

\section*{References}

[ACU14] Danel Ahman, James Chapman, and Tarmo Uustalu. "When is a container a comonad?" In: Logical Methods in Computer Science 10.3 (Sept. 2014). Ed. by LarsEditor Birkedal. IssN: 1860-5974 (cit. on p. 4).

[AU16] Danel Ahman and Tarmo Uustalu. “Directed Containers as Categories". In: EPTCS 207, 2016, pp. 89-98 (2016). eprint: arXiv: 1604.01187 (cit. on p. 1).

[AU17] Danel Ahman and Tarmo Uustalu. "Taking Updates Seriously." In: BX@ ETAPS. 2017, pp. 59-73 (cit. on p. 1).

[Bén+67] Jean Bénabou, R Davis, A Dold, J Isbell, S MacLane, U Oberst, J -E Roos, and Jean Bénabou. "Introduction to bicategories". In: Reports of the midwest category seminar. Springer. 1967, pp. 1-77 (cit. on p. 6).

[BP15] Andrej Bauer and Matija Pretnar. "Programming with Algebraic Effects and Handlers". In: Journal of Logical and Algebraic Methods in Programming 84.1 (Jan. 2015), pp. 108-123. issN: 23522208. DoI: 10 . 1016 / j . jlamp . 2014 . 02 . 001. arXiv: 1203 . 1539[cs]. URL: http://arxiv.org/abs/1203.1539 (visited on 05/02/2023) (cit. on p. 11).

[BS23] Kristopher Brown and David I. Spivak. Dynamic Tracing: a graphical language for rewriting protocols. 2023. arXiv: 2304.14950 [cs.LO] (cit. on p. 1).

[CS10] G.S.H. Cruttwell and Michael Shulman. "A unified framework for generalized multicategories". In: Theory and Applications of Categories 24 (2010), Paper No. 21, 580-655 (cit. on p. 10).

[GH18] Richard Garner and Tom Hirschowitz. "Shapely monads and analytic functors". In: Journal of Logic and Computation 28.1 (2018), pp. 33-83 (cit. on p. 16).

[GK12] Nicola Gambino and Joachim Kock. "Polynomial functors and polynomial monads". In: Mathematical Proceedings of the Cambridge Philosophical Society 154.1 (Sept. 2012), pp. 153192 (cit. on pp. 1, 8, 14).

[Kin22] Alexis King. !7942: Native, first-class, delimited continuations. GitLab. Apr. 5, 2022. urL: https: / gitlab . haskell . org / ghc/ghc/ - /merge_requests / 7942 (visited on 05/02/2023) (cit. on p. 11).
\footnotetext{
${ }^{7}$ Note that this is not a contravariant assignment, as a $(p, q)$-effects handler is regarded as a morphism from $q$ to $p$ in $\mathbb{E} f f$, a convention inherited from $\mathbb{C a t}^{\sharp}$
}

[Lei04] Tom Leinster. Higher operads, higher categories. London Mathematical Society Lecture Note Series 298. Cambridge University Press, Cambridge, 2004 (cit. on pp. 7, 9).

[Lei14] Daan Leijen. "Koka: Programming with Row Polymorphic Effect Types". In: Electronic Proceedings in Theoretical Computer Science 153 (June 5, 2014), pp. 100-126. issN: 2075-2180. DoI: 10.4204/EPTCS.153.8. arXiv: 1406.2061[cs].urL: http://arxiv.org/abs/1406. 2061 (visited on 05/02/2023) (cit. on p. 11).

[Lyn22] Owen Lynch. Imperative Programming with Poly. URL: https://topos.site/blog/2023/ 04/imperative-programming-with-poly/ (visited on 04/05/2023) (cit. on p. 2).

[Mac98] Saunders Mac Lane. Categories for the working mathematician. 2nd ed. Graduate Texts in Mathematics 5. New York: Springer-Verlag, 1998 (cit. on p. 6).

[Ode22] Martin Odersky. Capabilities for Resources and Effects. 2022. URL: https://www.slideshare. net / Odersky / capabilities-for-resources-and-effects-252161040 (visited on 05/02/2023) (cit. on p. 11).

[Pro22] OCaml Project. OCaml 5.0.0 Release Notes. OCaml. Dec. 16, 2022. urL: https://ocaml . org/releases/5.0.0 (visited on 05/02/2023) (cit. on p.11).

[Sch+17] Patrick Schultz, David I. Spivak, Christina Vasilakopoulou, and Ryan Wisnesky. "Algebraic Databases". In: Theory and Applications of Categories 32 (2017), Paper No. 16, 547-619 (cit. on p. 2).

[Sha22] Brandon T. Shapiro. "Shape Independent Category Theory". PhD thesis. Cornell University, 2022. URL:https://pi .math.cornell.edu/ bts82/research/papers/thesis. $\mathrm{pd} f$ (cit. on pp. 1, 9, 10,16).

[Shu08] Michael Shulman. "Framed bicategories and monoidal fibrations". In: Theory and Applications of Categories 20 (2008), Paper No. 18, 650-738 (cit. on pp. 4, 20).

[Spi12] David I. Spivak. "Functorial data migration". In: Information and Computation 217 (2012), pp. $31-51$ (cit. on pp. 1, 4).

[Spi21a] David I. Spivak. Functorial aggregation. 2021. arXiv: 2111.10968 [math.CT] (cit. on pp.1, $3-7,9,10,20$ ).

[Spi21b] David I. Spivak. "Learners' languages". In: Proceedings of the 4th Annual Conference on Applied Category Theory. ACT. Cambridge, UK: EPTCS, 2021 (cit. on pp. 1, 2, 13).

[SS22] Brandon T. Shapiro and David I. Spivak. "Dynamic categories, dynamic operads: From deep learning to prediction markets". In: Electronic Proceedings in Theoretical Computer Science (2022) (cit. on pp. 1, 2, 13).

[SS23] Brandon T. Shapiro and David I. Spivak. "Structures on Categories of Polynomials". In: arXiv (2023). eprint: 2305.00167 (cit. on pp. 1, 2, 8,9,14-16, 18).

[Web07] Mark Weber. "Familial 2-Functors and Parametric Right Adjoints". In: Theory and Applications of Categories 18 (2007), Paper No. 22, 665-732 (cit. on pp. 1, 2, 9-11, 20, 21).

[Web15a] Mark Weber. "Operads as polynomial 2-monads".In: (2015).arXiv: 1412.7599 [math.CT] (cit. on p. 1).

[Web15b] Mark Weber. "Polynomials in categories with pullbacks". In: Theory Appl. Categ 30.16 (2015), pp. 533-598 (cit. on pp. 1,8).

\section*{A Functoriality of $\mathbb{P o l y ~}_{\mathscr{E}} \rightarrow \mathbb{C a t}^{\sharp}$}

Throughout this appendix, let $\mathscr{E}$ be a category with pullbacks.

Definition A.1 (Based on [GK12, Section 3] and [SS23, Section 5.3]). The double category $\mathbb{P o l y ~}_{\mathscr{E}}$ of typed polynomials in $\mathscr{E}$ has
- as objects, objects of $\mathscr{E}$;
- as vertical morphisms, morphisms of $\mathscr{E}$;
- as horizontal morphisms from $D$ to $C$, typed polynomials from $D$ to $C$;
- as squares between morphisms $f, g$ and types polynomials $P_{*} \rightarrow P$ and $P_{*}^{\prime} \rightarrow P^{\prime}$, isomorphism classes of commuting diagrams as in (7), where the isomorphisms are between choices of pullbacks;

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-15.jpg?height=295&width=520&top_left_y=411&top_left_x=843)
- as horizontal identities, typed polynomials of the form $C=C=C=C$; and
- composition of typed polynomials $P_{*} \rightarrow P$ and $Q_{*} \rightarrow Q$ given by the composite of the top row of morphisms of (8),

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-15.jpg?height=417&width=1025&top_left_y=881&top_left_x=585)

where $\Pi_{p}\left(Q \times_{D} P_{*}\right)$ is defined by the universal property that morphisms into it from an object $A$ correspond to pairs ( $f_{1}: A \rightarrow P, f_{2}: f_{1}^{*} P_{*} \rightarrow Q$ ) with $f_{2}$ commuting with $f_{1}^{*} P_{*} \rightarrow P_{*}$ over $D$. As we discuss in the proof of Theorem A.2, as we are constructing a fully faithful strong double functor out of $\mathbb{P o l y ~}_{8}$ there is no need to define horizontal composition of squares. Vertical composition of squares is as given for morphisms of untyped polynomials in [SS23, Definition 3.13], though similarly by fully faithfulness of the double functor constructed out of $\mathbb{P o l y}_{\mathcal{E}}$ it is not strictly necessary to define this composition as it can be deduced from the vertical composition of squares in $\mathbb{C a t}{ }^{\#}$.

$$
\diamond
$$

Before proving that this double category maps into $\mathbf{C a t}^{\sharp}$, we first describe how the identities and composition of bicomodules given in Definition 2.5 behaves under the correspondence with prafunctors from Definition 2.8. For a $(c, d)$-bicomodule $p$ and a $(d, e)$-bicomodule $q$ of the forms

$$
p=\sum_{C \in c(1)} \sum_{I \in p_{C}(1)} y^{p[I]} \quad \text { and } \quad q=\sum_{D \in d(1)} \sum_{J \in q_{D}(1)} y^{q[]]}
$$

the equalizer of $p \triangleleft q \rightrightarrows p \triangleleft d \triangleleft q$ has as positions the subset of functions $p[I] \rightarrow q(1)$ which are morphisms between the associated $d$-copresheaf structures; this is because the two maps to $p \triangleleft d \triangleleft q$ each append such a map with the data of either the restrictions of elements of $p[I]$ under maps in $d$ or those of elements in $q(1)$, which in the equalizer must agree. The directions for a position given by $f: p[I] \rightarrow q(1)$ is the coequalizer of the disjoint union

$$
(p \triangleleft q)[I, f]=\sum_{i \in p[I]} q[f(i)]
$$

under the maps respectively sending $i$ to its restrictions along maps in $d$ within the $d$-copresheaf $p[I]$ and mapping $q[f(i)]$ to the arities of the restriction of $f(i)$ along maps in $d$ according to the left $d$-module structure of $q$ on directions. These identifications turn the disjoint union $(p \triangleleft q)[I, f]$ into the corresponding colimit

$$
\left(p \triangle_{d} q\right)[I, f]=\underset{i \in p[1]}{\operatorname{colim}} q[f(i)]
$$
indexed by the category of elements of $p[I]$ as a $d$-copresheaf. It is easily checked (as stated in [Sha22, Proposition 1.8] and a consequence of the proofs of [GH18, Propositions 3.11, 3.12]) that these positions and directions agree with those of the composite of the corresponding parametric right adjoint functors.

The identity bicomodule $c \triangleleft \frac{c}{\sim} \triangleleft$ has the form $\sum_{C \in c(1)} y^{c[C]}$, so it has a single operation for each object of $c$ with arity the corepresentable copresheaf $c[C]$.

Theorem A.2. For a fully faithful dense functor $F: a^{\mathrm{op}} \rightarrow \mathcal{E}$, there is a locally fully faithful pseudo-double functor from $\mathbb{P o l y}_{8}$ to $\mathbb{C a t}^{\sharp}$. It sends an object $C$ to the slice category $F / C \cong \int F^{*}(C)$, and a typed polynomial $D \leftarrow P_{*} \rightarrow P \rightarrow C$ to the $(F / C, F / D)$-bicomodule

$$
\sum_{\substack{A \in a(1) \\ F(A) \rightarrow C}} \sum_{\substack{\searrow_{C}}} y^{F^{*}\left(x^{*} P_{*}\right)}
$$

Here "locally fully faithful" means that for any fixed square boundary in $\mathbb{P o l y ~}_{8}$, the function from its square fillers to squares with the corresponding boundary in $\mathbb{C a t}^{\sharp}$ is a bijection. In particular this implies that the category of typed polynomials in $£$ from $D$ to $C$ maps fully faithfully to the category of $(F / C, F / D)$-bicomodules. In the case when $\mathscr{E}$ has finite limits, the first statement of Theorem 4.2 follows from setting $C$ and $D$ to be the terminal object, resulting in a fully faithful strong monoidal functor from $\mathrm{Poly}_{8}$ to $(a, a)$-bicomodules.

Note that $F^{*}\left(x^{*} P_{*}\right)$, as an $a$-copresheaf over $F^{*}(D)$, is equivalently regarded as a copresheaf on $F / D$.

Proof. Following the approach of [SS23, Section 3.2], as the assignment $C \mapsto F / C$ is clearly functorial on the vertical categories, it suffices to show that the assignment on horizontal morphisms preserves identities and composition up to coherent isomorphism and that the given assignments are indeed locally fully faithful. The remaining structure and properties of a pseudo-double functor can then be deduced using local fully faithfulness, in the style of [SS23, Proposition 3.25], as can the composition of squares in Poly. ${ }^{8}$

The identity polynomial $C=C=C=C$ is sent to the $(F / C, F / C)$-bicomodule

$$
\sum_{\substack{A \in a(1) \\ F(A) \rightarrow C}} \sum_{x \in \operatorname{Hom}_{\mathcal{E} / C}(F(A), C)} y^{F^{*}\left(x^{*} C\right)} \cong \sum_{\substack{A \in a(1) \\ F(A) \rightarrow C}} y^{F^{*}(F(A))} \cong \sum_{\substack{A \in a(1) \\ F(A) \rightarrow C}} y^{a[A]}
$$

as since $F$ is fully faithful $F^{*}(F(A)) \cong a[A]$. As an $F / C$-copresheaf, thiscopy of $a[A]$ corresponds to the copresheaf corepresented by the map $F(A) \rightarrow C$, whose elements are in bijection with the set $a[A]$. This is precisely the form of the identity $(F / C, F / C)$-bicomodule, so our desired double functor preserves horizontal identities.

For typed polynomials $D \leftarrow P_{*} \xrightarrow{p} P \rightarrow C$ and $E \leftarrow Q_{*} \xrightarrow{q} Q \rightarrow D$, their composite in $\mathbb{P o l y ~}_{\varepsilon}$ is sent to the $(F / C, F / E)$-bicomodule

$$
\sum_{\substack{A \in a(1) \\ F(A) \rightarrow C}} \sum_{x \in \operatorname{Hom}_{\mathscr{E} / C}\left(F(A), \Pi_{p}\left(Q \times_{D} P_{*}\right)\right)} y^{F^{*}\left(x^{*} \bullet 2\right)}
$$
\footnotetext{
${ }^{8}$ The specific analogue of that proposition would proceed by: 1) defining a tentative pseudo-double category as a pair of categories with the same objects and sets of squares filling boundaries of the appropriate type; 2) defining a tentative pseudo-double functor as an assignment on the categories and squares preserving vertical composition strictly and horizontal composition up to bidirectional squares; and 3) concluding that a tentative pseudo-double category with a locally fully faithful tentative pseudo-double functor to an established pseudo-double category endows the domain with the structure of a pseudo-double category such that the tentative pseudo-double functor is in fact a pseudo-double functor.
}
where $\bullet_{2}$ is defined via pullbacks in (8), and the composite of the associated bicomodule in $\mathbb{C a t}^{\sharp}$ is the $(F / C, F / E)$-bicomodule

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-17.jpg?height=173&width=836&top_left_y=347&top_left_x=639)

By the universal property of $\Pi_{p}\left(Q \times_{D} P_{*}\right)$, a morphism $x: F(A) \rightarrow \Pi_{p}\left(Q \times_{D} P_{*}\right)$ commuting over $C$ corresponds to a morphism $x_{1}: F(A) \rightarrow P$ commuting over $C$ along with a map $\bar{x}_{2}: x_{1}^{*} P_{*} \rightarrow Q$ commuting over $D$. As the functor $F^{*}$ is fully faithful, maps of the form $x_{2}$ and $\bar{x}_{2}$ are is bijective correspondence, so these bicomodules agree on positions.

To compute the pullback $x^{*} \bullet 2$ in terms of the maps $x_{1}, x_{2}$, consider the extension of (8) given in (9).

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-17.jpg?height=550&width=1055&top_left_y=793&top_left_x=535)

The pullback $x^{*} \bullet_{1}$ agrees with $x_{1}^{*} P_{*}$ by the cancellation property of pullbacks, as $x_{1}$ factors through $x$. Similarly, as $x_{2}$ factors through the projection $x_{1}^{*} P_{*} \rightarrow \bullet_{1}$, the pullback of the latter to $\bullet 2$ agrees with $x_{2}^{*} Q_{*}$. By composition of pullbacks then, we have that $x^{*} \bullet_{2} \cong x_{2}^{*} Q_{*}$, so to show that our desired double functor indeed preserves horizontal composition it suffices to show that

$$
\begin{equation*}
F^{*}\left(x_{2}^{*} Q_{*}\right) \cong \underset{y: a\left[A^{\prime}\right] \rightarrow F^{*}\left(x_{1}^{*} P_{*}\right)}{ } y^{*} F^{*}\left(x_{2}^{*} Q_{*}\right) \tag{10}
\end{equation*}
$$

To see this, recall the canonical colimit decomposition

$$
\begin{equation*}
F^{*}\left(x_{1}^{*} P_{*}\right) \cong \operatorname{colim}_{y: a\left[A^{\prime}\right] \rightarrow F^{*}\left(x_{1}^{*} P_{*}\right)} a\left[A^{\prime}\right] \tag{11}
\end{equation*}
$$

of an object in a copresheaf category. As $a$-Set is locally cartesian closed, the pullback functor

$$
a-\operatorname{Set} / F^{*}\left(x_{1}^{*} P_{*}\right) \rightarrow a-\operatorname{Set} / F^{*}\left(x_{2}^{*} Q_{*}\right)
$$

is a left adjoint and therefore preserves colimits. In the case of the colimit in (11), this colimit preservation shows that (10) holds, as the left side is the pullback of the identity on $F^{*}\left(x_{1}^{*} P_{*}\right)$ to $F^{*}\left(x_{2}^{*} Q_{*}\right)$ and the right side is the colimit of the pullbacks $y^{*} F^{*}\left(x_{2}^{*} Q_{*}\right)$ of each map $a\left[A^{\prime}\right] \rightarrow F^{*}\left(x_{1}^{*} P_{*}\right)$ along the same map. This completes the proof that our desired double functor preserves horizontal composition up to isomorphism.

It then remains to show local fully faithfulness. Consider an arrangement of typed polynomials as in (12).

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-17.jpg?height=174&width=517&top_left_y=2293&top_left_x=804)

A square filling in the associated diagram in $\mathbb{C a t}{ }^{\sharp}$ has the form of a polynomial morphism

$$
\sum_{\substack{A \in a(1) \\ z: F(A) \rightarrow C}} \sum_{x \in \operatorname{Hom}_{\mathcal{E} / C}(F(A), P)} y^{F^{*}\left(x^{*} P_{*}\right)} \xrightarrow{\phi} \sum_{\substack{A \in a(1) \\ z^{\prime}: F(A) \rightarrow C^{\prime}}} \sum_{\substack{ \\x^{\prime} \in \operatorname{Hom}_{8 / C^{\prime}}\left(F(A), P^{\prime}\right)}} y^{F^{*}\left(x^{\prime *} P_{*}^{\prime}\right)}
$$

where $(A, z: F(A) \rightarrow C)$ is sent to the composite $\left(A, g \circ z: F(A) \rightarrow C \rightarrow C^{\prime}\right)$, the maps

$$
\phi_{1}^{A, z}: \operatorname{Hom}_{\mathscr{E} / C}(F(A), P) \rightarrow \operatorname{Hom}_{\mathscr{E} / C^{\prime}}\left(F(A), P^{\prime}\right)
$$

are natural in $A$ and $z: F(A) \rightarrow C$, and the maps of $a$-copresheaves on directions

$$
\phi_{x}^{\#}: F^{*}\left(\phi_{1}^{A, z}(x)^{*} P_{*}^{\prime}\right) \rightarrow F^{*}\left(x^{*} P_{*}\right)
$$

are natural in $x$ (as an object in the category of elements of $F^{*}(P)$ ) and commute with $F^{*}(f): F^{*}(D) \rightarrow$ $F^{*}\left(D^{\prime}\right)$. The maps $\phi_{1}^{A, z}$ assemble into a map $F^{*}(P) \rightarrow F^{*}\left(P^{\prime}\right)$ commuting with $F^{*}(g): F^{*}(C) \rightarrow F^{*}(D)$. As $F^{*}$ is fully faithful, this map arises uniquely from a map $\psi_{1}: P \rightarrow P^{\prime}$ commuting with $g$ as in (7).

Using the observations that $\phi_{1}^{A, z}(x)=\psi_{1} \circ x$ and $F^{*}$ preserves pullbacks, we can equivalently express $\phi_{x}^{\#}$ as a map of the form $\bar{x}^{*} F^{*}\left(\psi_{1}^{*} P_{*}^{\prime}\right) \rightarrow \bar{x}^{*} F^{*}\left(P_{*}\right)$, natural in $\bar{x}=F^{*}(x): a[A] \rightarrow F^{*}(P)$. By the canonical colimit decomposition of $F^{*}(P)$ in $a$-Set and preservation of colimits by pullbacks, such a $F / P$-indexed natural transformation is uniquely determined by a morphism $F^{*}\left(\psi_{1}^{*} P_{*}^{\prime}\right) \rightarrow F^{*}\left(P_{*}\right)$ which commutes over $F^{*}(P)$ and, by previous assumption on $\phi_{x}^{\#}$, over $F^{*}\left(D^{\prime}\right)$ as well. As $F^{*}$ is fully faithful, this is equivalently a morphism $\psi_{1}^{*} P_{*}^{\prime} \rightarrow P_{*}$ over $P$ in $\mathscr{E}$ which also commutes over $D^{\prime}$.

In conclusion, we have shown that squares in $\mathbb{C a t}^{\sharp}$ filling in the boundary associated to that of (12) from $\mathbb{P o l y ~}_{\varepsilon}$ correspond bijectively with squares of this form in $\mathbb{P o l y}_{\varepsilon}$, completing the proof that the desired double functor is locally fully faithful, and thereby a pseudo-double functor.

In [SS23, Section 4.1], when $\mathscr{E}$ has finite limits the Dirichlet tensor product on Poly ${ }_{\mathscr{E}}$ is defined as the product of morphisms (though this is not a product in the category Poly $\mathbf{E}_{\varepsilon}$ ), and is shown to form a duoidal category with the composition product. The unit of both monoidal structures is $y$, the identity morphism on the terminal object.

Corollary A.3. The monoidal functor of Theorem 4.2 is lax monoidal with respect to $\otimes$ and ${ }_{a} \otimes_{a}$.

Proof. After unwinding the definitions we can see that for polynomials $P_{*} \rightarrow P$ and $Q_{*} \rightarrow Q$ in $\mathcal{E}$,

$$
\begin{aligned}
& \sum_{A \in a(1)} \sum_{x: F(A) \rightarrow P \times Q} y^{F^{*}\left(x^{*}\left(P_{*} \times Q_{*}\right)\right)} \\
\cong & \sum_{A \in a(1)} \sum_{\substack{x_{1}: F(A) \rightarrow P \\
x_{2}: F(A) \rightarrow Q}} y^{F^{*}\left(x_{1}^{*}\left(P_{*}\right) x_{F(A)} x_{2}^{*}\left(Q_{*}\right)\right)} \\
\cong & \sum_{A \in a(1)} \sum_{\substack{x_{1}: F(A) \rightarrow P \\
x_{2}: F(A) \rightarrow Q}} y^{F^{*}\left(x_{1}^{*}\left(P_{*}\right)\right) \times_{a[A]} F^{*}\left(x_{2}^{*}\left(Q_{*}\right)\right)}
\end{aligned}
$$

by the fact that the pullback of a morphism into a product is the pullback of the pullbacks of the component morphisms, and the functor $F^{*}: \mathscr{E} \rightarrow a$-Set preserves pullbacks. Here $a[A]$ denotes the corepresentable $a$-copresheaf, which agrees with $F^{*} F(A)$ as $F$ is fully faithful.

This $(a, a)$-bicomodule has a morphism from the corresponding tensor product of $(a, a)$-bicomodules

$$
\begin{aligned}
& \left(\sum_{A \in a(1)} \sum_{x_{1}: F(A) \rightarrow P} y^{F^{*}\left(x_{1}^{*} P_{*}\right)}\right) a \otimes_{a}\left(\sum_{A \in a(1)} \sum_{x_{2}: F(A) \rightarrow Q} y^{F^{*}\left(x_{2}^{*} Q_{*}\right)}\right)
\end{aligned}
$$

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-18.jpg?height=125&width=585&top_left_y=2407&top_left_x=762)
induced by the inclusion from a fiber product into a product of $a$-copresheaves on the directions. The functor sends the unit $y: 1=1$ to the $(a, a)$-bicomodule

$$
\sum_{A \in a(1)} \sum_{F(A) \rightarrow 1} y^{F^{*} F(A)} \cong \sum_{A \in a(1)} \sum_{F(A) \rightarrow 1} y^{a[A]}
$$

which likewise admits a map from the unit $a(1) y^{a(1)}$ of the monoidal structure on $(a, a)$-bicomodules, induced by the unique map $a[A] \rightarrow a(1)$ to the terminal $a$-copresheaf on directions.

The unit and associativity equations are then straightforward to deduce from the universal property of products.

The remaining claim of Corollary 4.3 then follows immediately from fully faithfulness and strong monoidality for $\triangleleft$, as the universal property of the coclosure is then preserved and reflected.

Corollary A.4. The monoidal functor of Theorem 4.2 preserves the $₫$-closures up to coherent natural isomorphisms whenever they exist.

\section*{B Structure of Theories and Nerves}

Lemma B.1. For $m$ a monad on a comonoid $c$ in $\mathbf{C a} \mathbf{t}^{\sharp}$ and $p$ any $(d, c)$-bicomodule, $\left[\begin{array}{c}p p_{c} m \\ p\end{array}\right]$ is a comonad on d.

Proof. In the interest of space we construct only the counit and comultiplication transformations, but as they are derived directly from the unit and multiplication transformations of the monad $m$ it is straightforward to check that their counitality and coassociativity follow directly from unitality and associativity for $m$, respectively.

The strategy here is to use the universal property of the coclosure that morphisms of $(d, d)$ bicomodules from $\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right]$ to $q$ are in bijective correspondence with morphisms from $p$ to $q \triangleleft_{d} p \triangleleft_{c} m$. The counit transformation $\left[\begin{array}{c}p_{\star} m \\ p\end{array}\right] \rightarrow d$ then corresponds to the transformation $p \rightarrow p \triangleleft_{c} m \cong$ $d \triangleleft_{d} p \triangleleft_{c} m$ given by the unit of $m$.

Similarly, the comultiplication $\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right] \rightarrow\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}p ₫_{c} m \\ p\end{array}\right]$ corresponds to the composite

$$
p \rightarrow\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} m \rightarrow\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left(\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} m\right) \triangleleft_{c} m \rightarrow\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}
p_{\iota_{c}} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} m
$$

consisting of two applications of the unit of the adjunction $\left[\stackrel{p \triangleleft_{c} m}{-}\right] \dashv-\triangleleft_{d} p \triangleleft_{c} m$ followed by the multiplication of $m$.

Lemma B.2. For a comonad e on an object c of $\mathbf{C a t}^{\sharp}$ and $d$ another object of $\mathbb{C} \mathbf{t}^{\sharp}$, there is a carrier-preserving equivalence between $(e, d)$-bicomodules and $(c, d)$-bicomodules with the structure of a left e-comodule.

Proof. Given a $(c, d)$-bicomodule $p$, the structure of a left $e$-comodule amounts to a morphism of polynomials $p \rightarrow e \triangleleft_{c} p$, which by the definition of bicomodule composition induces a morphism $p \rightarrow e \triangleleft p$, where the left $e$-comodule equations in $\mathbf{C a t}^{\sharp}$ imply the left $e$-comodule equations in Poly. Similarly, as $p \rightarrow e \triangleleft_{c} p$ is a morphism of $(c, d)$-bicomodules, this $e$-coaction on $p$ in Poly is compatible with the right $d$-coaction on $p$, so that $p$ has the structure of a $(e, d)$-bicomodule.

By Lemma 5.3, $e$ has a homomorphism to $c$, and as such there is a square in $\mathrm{Cat}^{\sharp}$ as on the left in (13) from $e$ as the identity ( $e, e)$-bicomodule to $e$ as a ( $c, c)$-bicomodule given by the identity morphism on $e$. The $(e, d)$-bicomodule structure on $p$ induces a $(c, d)$-bicomodule structure where the left coaction is given by the composite $c \triangleleft p \leftarrow e \triangleleft p \leftarrow p$ and the $(c, d)$-bicomodule equations are
guaranteed from the $(e, d)$-bicomodule equations as the map $c \leftarrow e$ is a comonoid homomorphism. The identity morphism on $p$ therefore provides a morphism of bicomodules as on the left in (13).

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-20.jpg?height=184&width=309&top_left_y=366&top_left_x=905)

Note that both of these squares are cocartesian fillers (in the sense of equipments, see [Spi21a, Lemma 2.3.13] and [Shu08]) of their respective vertical arrows and source horizontal arrows. This means that the cocartesian filler of the outer frame of the composite agrees with the square on the right, so by the universal property of cocartesian fillers the composite square induces a morphism of $(c, d)$-bicomodules from $p$ to $e \triangleleft_{c} p$, providing the coaction of a left $e$-comodule structure on $e$ in $\mathbb{C a t}^{\#}$. The comodule equations are then straightforward to deduce from the left $e$-comodule structure of $p$ in Poly and cofunctoriality of $e$ over $c$.

We can now proceed to prove Theorem 5.7.

Theorem B.3. For a monad $m$ on $c$ in Cat $^{\sharp}, A a(c, b)$-bicomodule with the structure of a left m-module, and $p$ a $(d, c)$-bicomodule, $p \triangleleft_{c} A$ is a left $\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right]$-comodule with coaction as in (5) (also pictured below). When $d=0$ A therefore has the structure of $a \Theta_{m}^{p}$-presheaf, which when $p=m$ agrees with the nerve given by Weber in [Web07, Definition 4.4].

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-20.jpg?height=201&width=589&top_left_y=1233&top_left_x=757)

Proof. Let a $(c, b)$-bicomodule $A$ have an $m$-action morphism $\psi: m \triangleleft_{c} A \rightarrow A$, and consider the coaction morphism $p \triangleleft_{c} A \rightarrow\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right] \triangleleft_{d} p \triangleleft_{c} A$ of $(d, 0)$-bicomodules from (5).

We first show that $p \triangleleft_{c} A$ is a comodule, namely that the coaction commutes with counit and comultiplication. To do so, we use the universal property of the coclosure, namely that the composition of the coaction with a morphism $\phi:\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right] \rightarrow q$ agrees with the composite map

$$
p \triangleleft_{c} A \xrightarrow{\bar{\phi}_{c} A} q \triangleleft_{d} p \triangleleft_{c} m \triangleleft_{c} A \xrightarrow{q \triangleleft_{d} p \triangleleft_{c} \psi} q \triangleleft_{d} p \triangleleft_{c} A,
$$

where $\bar{\phi}$ is the map $p \rightarrow q \triangleleft_{d} p \triangleleft_{c} m$ corresponding to $\phi$ under the adjunction $\left[\begin{array}{c}p \triangleleft_{c} m \\ -\end{array}\right] \dashv-\triangleleft_{d} p \triangleleft_{c} m$.

For the counit, the composite $p \triangleleft_{c} A \rightarrow p \triangleleft_{c} m \triangleleft_{c} A \rightarrow p \triangleleft_{c} A$ of the unit of $m$ with the $m$-action map of $A$ is the identity by the unit law for $m$-modules, so the composite of the coaction with the counit of $\left[\begin{array}{c}p_{\triangleleft} m \\ p\end{array}\right]$ as defined in Lemma B. 1 is the identity as desired.

For the comultiplication, the composite

$$
\begin{gathered}
p \triangleleft_{c} A \rightarrow\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c}\left(m \triangleleft_{c} m\right) \triangleleft_{c} A \\
\xrightarrow{\cdots \triangleleft_{c} \mu \triangleleft_{c} A}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} m \triangleleft_{c} A \xrightarrow{\cdots \triangleleft_{c} \psi}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} A
\end{gathered}
$$

agrees with the composite

$$
p \triangleleft_{c} A \rightarrow\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} m \triangleleft_{c}\left(m \triangleleft_{c} A\right)
$$

$$
\xrightarrow{\cdots \triangleleft_{c} m \triangleleft_{c} \psi}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} m \triangleleft_{c} A \xrightarrow{\cdots \triangleleft_{c} \psi}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d}\left[\begin{array}{c}
p \triangleleft_{c} m \\
p
\end{array}\right] \triangleleft_{d} p \triangleleft_{c} A
$$

by the multiplication law for $m$-modules, so the composite of the coaction with the comultiplication of $\left[\begin{array}{c}p{ }_{c} m \\ p\end{array}\right]$ agrees with the repeated application of the coaction as desired.

It remains to show that when $p=m$ this $\Theta_{m}$-presheaf agrees with Weber's nerve of [Web07, Definition 4.4]. In fact we show that for general $p$ the copresheaf $p \triangleleft_{c} A$ has $I$-cells given by maps $m \triangleleft_{c} p[I] \rightarrow A$ of $m$-algebras and for a morphism $f: m \triangleleft_{c} p\left[I^{\prime}\right] \rightarrow m \triangleleft_{c} p[I]$ of $m$-algebras, the corresponding function from $I$-cells to $I^{\prime}$-cells is given by precomposition with $f$.

Observe that on positions, the unit morphism $p \rightarrow\left[\begin{array}{c}p \triangleleft_{c} m \\ p\end{array}\right] \triangleleft_{d} p \triangleleft_{c} m$ sends $I \in p(1)$ to the tuple

$$
\left(I \in p(1),\left(I^{\prime} \in p(1)\right)_{f: p\left[I^{\prime}\right] \rightarrow m \triangleleft_{c} p[I]}, \pi \circ f: p\left[I^{\prime}\right] \rightarrow m \triangleleft_{c} p[I] \rightarrow m(1)\right)
$$

where $f$ is a morphism of $c$-copresheaves, and on directions sends

$$
\left(I^{\prime}, x \in p\left[I^{\prime}\right], y \in m[\pi \circ f(x)]\right)
$$

to $f(x, y)$. The coaction thus sends the pair $(I, p[I] \rightarrow A)$ to

$$
\left(I,\left(I^{\prime}\right)_{f},\left(p\left[I^{\prime}\right] \rightarrow m \triangleleft_{c} p[I] \rightarrow m \triangleleft_{c} A \rightarrow A\right)_{f}\right)
$$

As a $\left[\begin{array}{c}p_{\triangleleft} m \\ p\end{array}\right]$-copresheaf then its $I$-cells are the maps $p[I] \rightarrow A$ of $c$-copresheaves, equivalently maps $m \triangleleft_{c} p[I] \rightarrow A$ of $m$-algebras, and the application of a morphism $p\left[I^{\prime}\right] \rightarrow m \triangleleft_{c} p[I]$ to $p[I] \rightarrow A$ is the Kleisli composite, equivalently the composite of maps

$$
m \triangleleft_{c} p\left[I^{\prime}\right] \rightarrow m \triangleleft_{c} p[I] \rightarrow A
$$

of $m$-algebras as desired.

\section*{C Functoriality of $\mathbb{O} \mathbf{r g} \rightarrow \mathbb{E f f} \rightarrow$ Cat $^{\sharp}$}

We first make explicit the requisite commutative diagrams from Definition 6.1:

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-21.jpg?height=200&width=1065&top_left_y=1640&top_left_x=519)

Proposition C.1. There is a functor $c_{-}:$Poly $\rightarrow$ Poly such that $c_{p}$ has the structure of a $\triangleleft$-comonoid for each $p$ : Poly,

$$
\mathfrak{c}_{p} \rightarrow y \quad \text { and } \quad \mathfrak{c}_{p} \rightarrow \mathfrak{c}_{p} \triangleleft \mathfrak{c}_{p}
$$

Proof. Given a polynomial $p$, define polynomials $p^{(i)}$ for $i \in \mathbb{N}$ by

$$
p^{(0)}:=y \quad \text { and } \quad p^{(1+i)}:=y \times\left(p \triangleleft p^{(i)}\right)
$$

There is a projection map $\pi^{(0)}: p^{(1)} \rightarrow p^{(0)}$, and if $\pi^{(i)}: p^{(1+i)} \rightarrow p^{(i)}$ has been defined, then we can define $\pi^{(1+i)}:=y \times\left(p \triangleleft \pi^{(i)}\right)$. Now define the polynomial

$$
\begin{equation*}
\mathfrak{c}_{p}:=\lim \left(\cdots \xrightarrow{\pi^{(2)}} p^{(2)} \xrightarrow{\pi^{(1)}} p^{(1)} \xrightarrow{\pi^{(0)}} p^{(0)}\right) \tag{15}
\end{equation*}
$$

and we note that this construction $p \mapsto \mathfrak{c}_{p}$ is natural in $p$ : Poly.

This polynomial comes equipped with a counit $\epsilon: c_{p} \rightarrow y=p^{(0)}$ given by the projection. We next construct the comultiplication $\delta: \mathfrak{c}_{p} \rightarrow \mathfrak{c}_{p} \triangleleft \mathfrak{c}_{p}$. Since $\triangle$ commutes with connected limits, we have

$$
\mathfrak{c}_{p} \triangleleft \mathfrak{c}_{p}=\left(\lim _{i_{1}} p^{\left(i_{1}\right)}\right) \triangleleft\left(\lim _{i_{2}} p^{\left(i_{2}\right)}\right) \cong \lim _{i_{1}, i_{2}}\left(p^{\left(i_{1}\right)} \triangleleft p^{\left(i_{2}\right)}\right)
$$

To obtain the comultiplication $\lim _{i} p^{(i)} \rightarrow \lim _{i_{1}, i_{2}}\left(p^{\left(i_{1}\right)} \triangleleft p^{\left(i_{2}\right)}\right)$, it suffices to produce a natural choice of polynomial map $\varphi_{i_{1}, i_{2}}: p^{\left(i_{1}+i_{2}\right)} \rightarrow p^{\left(i_{1}\right)} \triangleleft p^{\left(i_{2}\right)}$ for any $i_{1}, i_{2}: \mathbb{N}$. When $i_{1}=0$ or $i_{2}=0$, we use the unit identity for $\triangleleft$. By induction, assume given $\varphi_{i_{1}, 1+i_{2}}$; we construct $\varphi_{1+i_{1}, 1+i_{2}}$ as follows:

$$
\begin{align*}
p^{\left(1+i_{1}+1+i_{2}\right)} & =y \times\left(p \triangleleft p^{\left(i_{1}+1+i_{2}\right)}\right) \\
& \rightarrow y \times\left(p \triangleleft p^{\left(i_{1}\right)} \triangleleft p^{\left(1+i_{2}\right)}\right)  \tag{16}\\
& \rightarrow\left(y \times p \triangleleft p^{\left(i_{1}\right)}\right) \triangleleft p^{\left(1+i_{2}\right)}  \tag{17}\\
& =p^{\left(1+i_{1}\right)} \triangleleft p^{\left(1+i_{2}\right)}
\end{align*}
$$

where (16) is $\varphi_{i_{1}, 1+i_{2}}$ and it remains to construct (17). Recall that $-\triangleleft q$ preserves products for any $q$, so constructing (17) is equivalent to constructing two maps

$$
y \times\left(p \triangleleft p^{\left(i_{1}\right)} \triangleleft p^{\left(1+i_{2}\right)}\right) \xrightarrow{\phi^{\left(i_{1}, i_{2}\right)}} p^{\left(1+i_{2}\right)} \quad \text { and } \quad y \times\left(p \triangleleft p^{\left(i_{1}\right)} \triangleleft p^{\left(1+i_{2}\right)}\right) \rightarrow p \triangleleft p^{\left(i_{1}\right)} \triangleleft p^{\left(1+i_{2}\right)} \text {. }
$$

For the latter we use the second projection. The former, $\phi^{\left(i_{1}, i_{2}\right)}: p^{\left(1+i_{1}+1+i_{2}\right)} \rightarrow p^{\left(1+i_{2}\right)}$, is the more interesting one; for it we also use projections $p^{\left(i_{1}\right)} \rightarrow p^{(0)}=y$ and $\pi^{\left(i_{2}\right)}: p^{\left(i_{2}+1\right)} \rightarrow p^{\left(i_{2}\right)}$ to obtain:

$$
y \times\left(p \triangleleft p^{\left(i_{1}\right)} \triangleleft p^{\left(1+i_{2}\right)}\right) \rightarrow y \times\left(p \triangleleft y \triangleleft p^{\left(i_{2}\right)}\right) \cong p^{\left(1+i_{2}\right)}
$$

We leave the naturality of this to the reader.

It remains to check that $\epsilon$ and $\delta$ satisfy unitality and coassociativity. The base cases above imply unitality. Proving coassociativity amounts to proving that the following diagram commutes:

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-22.jpg?height=217&width=637&top_left_y=1556&top_left_x=733)

This can be shown by induction on $i_{3}$.

Theorem C.2. There is an adjunction

$$
\operatorname{Cat}^{\sharp} \underset{c_{-}}{\underset{\rightleftarrows}{\rightleftarrows}} \text { Poly }
$$

where $U:$ Cat ${ }^{\sharp} \rightarrow$ Poly is the forgetful functor $U(c, \epsilon, \delta):=c$.

Proof. We will abuse notation and denote the comonoid $(c, \epsilon, \delta)$ : $\mathbf{C a t}^{\sharp}$ simply by its carrier $c$. We first provide the counit and unit of the desired adjunction. The counit

$$
\epsilon_{p}: c_{p} \rightarrow p
$$

is given by composing the projection map $c_{p} \rightarrow p^{(1)}$ from construction (15) with the projection $p^{(1)} \cong y \times p \rightarrow p$. Since $c_{c}$ is defined as a limit, the unit

$$
\eta_{c}: c \nrightarrow \mathfrak{c}_{c}
$$
will be given by defining maps $\eta^{(i)}: c \rightarrow c^{(i)}$ commuting with the projections $\pi^{(i)}: c^{(1+i)} \rightarrow c^{(i)}$, for each $i: \mathbb{N}$, and then showing that the resulting polynomial map $\eta_{c}$ is indeed a cofunctor. Noting that $c^{(0)}=y$, we define

$$
\eta^{(0)}:=\epsilon
$$

Given $\eta^{(i)}: c \rightarrow c^{(i)}$, we define $\eta^{(1+i)}$ as the composite

$$
c \xrightarrow{(\epsilon, S)} y \times(c \triangleleft c) \xrightarrow{y \times\left(c \triangleleft \eta^{(i)}\right)} y \times\left(c \triangleleft c^{(i)}\right)=c^{(1+i)} .
$$

Clearly, we have $\eta^{(0)}=\pi^{(0)} \circ \eta^{(1)}$. It is easy to check that if $\eta^{(i)}=\pi^{(i)} \circ \eta^{(1+i)}$ then $\eta^{(1+i)}=\pi^{(1+i)} \circ \eta^{(2+i)}$. Thus we have constructed a polynomial map $\eta: c \rightarrow c_{c}$. It clearly commutes with the counit, so it suffices to show that $\eta$ commutes with the comultiplication, which amounts to showing that the following diagram commutes

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-23.jpg?height=228&width=1271&top_left_y=802&top_left_x=427)

for all $i_{1}, i_{2}: \mathbb{N}$, where $\varphi_{1+i_{1}, 1+i_{2}}$ is the map constructed in Eqs. (16) and (17). Commutativity follows from the counitality and coassociativity of the comonoid $c$.

The triangle identities are straightforward as well. Indeed, for any comonoid $c: \mathbf{C a t}^{\sharp}$, the composite $c \xrightarrow{U_{0} \eta_{c}} c_{c} \xrightarrow{\varepsilon_{U c}} c$ is equal to the composite of $c \xrightarrow{(\epsilon, c)} c^{(1)}=y \times c$, with the projection $c^{(1)} \rightarrow c$, the result of which is the identity. Finally, for any polynomial $p$ : Poly, the composite $c_{p} \xrightarrow{\eta_{c_{p}}} \mathfrak{c}_{c_{p}} \xrightarrow{c_{e p}} \mathfrak{c}_{p}$ is given by taking a limit of maps of the form

$$
\mathfrak{c}_{p} \xrightarrow{(\epsilon, \delta)} y \times\left(c_{p} \triangleleft c_{p}\right) \xrightarrow{y \times\left(c_{p} \triangleleft \eta^{(i)}\right)} y \times\left(c_{p} \triangleleft c_{p}^{(i)}\right) \xrightarrow{y \times\left(\epsilon_{p} \triangleleft \epsilon_{p}^{(i)}\right)} y \times\left(p \triangleleft p^{(i)}\right)
$$

Each one is in fact the projection $c_{p} \rightarrow p^{(i+1)}$, so the resulting map is the identity on $c_{p}$, completing the proof.

Lemma C.3. For a polynomial $p$ : Poly and comonoid $(c, \epsilon, \delta)$, we can identify $\left(\mathfrak{c}_{p}, c\right)$-effects handlers with elementary $(p, c)$-effects handlers.

Proof. Given a $\left(c_{p}, c\right)$-effects handler $c_{p} \triangleleft s \leftarrow s \triangleleft c$, one composes with the projection $c_{p} \rightarrow p$ to obtain an elementary $(p, c)$-effects handler.

Going the other way, suppose given an elementary effects handler $p \triangleleft s \stackrel{\varphi}{\leftarrow} s \triangleleft c$. Recall from (15) that $c_{p}$ is constructed as a limit, and that $(-\triangleleft s)$ preserves all limits; hence we have

$$
\mathfrak{c}_{p} \triangleleft s \cong \lim _{i}\left(p^{(i)} \triangleleft s\right) .
$$

We construct a map $c_{p} \triangleleft S \stackrel{\Phi}{\leftarrow} s \subset$ by induction on $i: \mathbb{N}$.

When $i=0$, we have $p^{(0)} \triangleleft s \cong s \stackrel{\Phi^{(0)}}{\longleftarrow} s \triangleleft c$ given by $\Phi^{(0)}:=s \triangleleft \epsilon$. Suppose given $p^{(i)} \triangleleft s \stackrel{\Phi^{(i)}}{\leftrightarrows} s \triangleleft c$ for some $i: \mathbb{N}$. We obtain

$$
\begin{align*}
& s \triangleleft c \xrightarrow{(s \triangleleft \delta, s \triangleleft \epsilon)}(s \triangleleft c \triangleleft c) \times s \\
& \xrightarrow{(\varphi \triangleleft c) \times s}(p \triangleleft S \triangleleft c) \times s \\
& \xrightarrow{\left(p \triangleleft \Phi^{(i)}\right) \times s}\left(p \triangleleft p^{(i)} \triangleleft s\right) \times s  \tag{18}\\
& \xrightarrow{\cong}\left(\left(p \triangleleft p^{(i)}\right) \times y\right) \triangleleft s \\
& \xrightarrow{\cong} p^{(i+1)} \triangleleft S
\end{align*}
$$

We have now constructed $\Phi$, and one easily observes that its underlying elementary effects handler is again $\varphi$. To conclude, one must check that $\Phi$ satisfies the two equations from (14) and that the round trip on $\left(c_{p}, c\right)$-effects handlers is the identity.

The counit equation from (14) is clear: it follows from the use of $\varphi$ with $i=0$ in the second arrow of (18). The comultiplication equation from (14) amounts to checking that two maps of the form $s \triangleleft c \rightrightarrows \lim _{i_{1}, i_{2}} p^{\left(i_{1}\right)} \triangleleft p^{\left(i_{2}\right)} \triangleleft s$ agree, and this is straightforward.

Finally, suppose given an effects handler $c_{p} \triangleleft s \stackrel{\Psi}{\leftarrow} s c$. Let $\varphi:=(\pi \triangleleft s) \circ \Psi$ be the underlying elementary effects handler, where $\pi: c_{p} \rightarrow p$ is the projection, and construct $\Phi$ from $\varphi$ as above; we want to show that $\Phi=\Psi$. For each $i: \mathbb{N}$, let $\Psi^{(i)}: s \triangleleft c \rightarrow p^{(i)} \triangleleft s$ be the composite of $\Psi$ with the projection $c_{p} \rightarrow p^{(i)}$; it suffices to show that $\Phi^{(i)}=\Psi^{(i)}$. This follows from (14) and induction on $i$.

Proposition C.4. For $p, q$ : Poly, any elementary ( $p, q$ )-effects handler gives rise to a $\left(\mathfrak{c}_{p}, \mathfrak{c}_{q}\right)$-effects handler.

Proof. Given a $(p, q)$-effects handler $p \triangleleft s \stackrel{\varphi}{\leftarrow} s \triangleleft q$, we compose with the projection $s \triangleleft q \leftarrow s \triangleleft \mathfrak{c}_{q}$ to obtain an elementary $\left(p, c_{q}\right)$-effects handler. Then by Lemma C.3, we can identify it with a $\left(\mathfrak{c}_{p}, \mathfrak{c}_{q}\right)$-effects handler, completing the proof.

Theorem C.5. [See Theorem 6.2] The pseudo-double category of effects handlers admits a pseudo-double functor $\mathbb{E} \mathbf{f f} \rightarrow \mathbf{C a t}^{\sharp}$ which is the identity on objects and vertical morphisms and which is faithful on the category of horizontal morphisms between nonempty categories and squares between them. Moreover, every $(c, 0)-$ and $(c, y)$-bicomodule is in the essential image.

Proof. We first show that for any $(c, d)$-effects handler $(s, \varphi)$, the structure maps from (6) do in fact form a bicomodule $c \triangleleft \Delta \triangle d$. It is easy to check that $s \triangleleft d \xrightarrow{s \triangleleft \delta} s \triangleleft d \triangleleft d$ is a right comodule. To check that the left structure maps commutes with counit, we have the following

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-24.jpg?height=179&width=569&top_left_y=1361&top_left_x=778)

where the triangle commutes because $d$ is a comonad, and the square commutes by (14). Checking that the left structure commutes with comultiplication is similar, and the compatibility between left and right structures is even easier.

A square in the double category $\mathbb{E} f f$ is a map $\gamma: s \rightarrow s^{\prime}$ and a commuting square

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-24.jpg?height=192&width=314&top_left_y=1758&top_left_x=903)

for cofunctors (comonoid homomorphisms) $\alpha: c \rightarrow c^{\prime}$ and $\beta: d \rightarrow d^{\prime}$. This gives rise to a square in Cat ${ }^{\#}$ :

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-24.jpg?height=196&width=227&top_left_y=2054&top_left_x=949)

Indeed, squares of this form are in bijection with $\left(c^{\prime}, d^{\prime}\right)$-bicomodule maps $s \triangleleft d \rightarrow s^{\prime} \triangleleft d^{\prime}$, and we obtain one from $\gamma$ as follows:

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-24.jpg?height=162&width=889&top_left_y=2372&top_left_x=610)

To see that this map is faithful for $d \neq 0$, suppose given maps $\gamma_{1}, \gamma_{2}: s \rightarrow s^{\prime}$ which induce the same map $\left(\gamma_{1} \triangleleft \beta\right)=\left(\gamma_{2} \triangleleft \beta\right): s \triangleleft d \rightarrow s^{\prime} \triangleleft d^{\prime}$. Then both squares below commute

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-25.jpg?height=189&width=273&top_left_y=350&top_left_x=926)

so it suffices to show that $s \triangleleft \epsilon$ is an epimorphism. The operation $s \triangleleft-$ preserves epimorphisms, and $p \rightarrow y$ is an epimorphism for any polynomial $p \neq 0$.

The identity effects handler on $c$ is $(y, c)$, which is sent to the identity bicomodule. We next check that horizontal composition is preserved by our functor. That is, we need to show that for any $c \triangleleft s \stackrel{\varphi}{\leftarrow} s \triangleleft d$ and $d \triangleleft t \stackrel{\psi}{\leftarrow} \Delta e$, there is a natural isomorphism

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-25.jpg?height=161&width=305&top_left_y=806&top_left_x=907)

The composite bicomodule is given by the following equalizer

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-25.jpg?height=195&width=1176&top_left_y=1041&top_left_x=472)

and it suffices to find a map $s \triangleleft t \triangleleft e \rightarrow s \triangleleft d \triangleleft t \triangleleft e$ that is also an equalizer of the right-hand triangle. Since ( $s \triangleleft-$ ) preserves equalizers, it suffices to find a map $t \triangleleft e \rightarrow d \triangleleft t \triangleleft e$ that is an equalizer of the two maps $d \triangleleft t \triangleleft e \rightrightarrows d \triangleleft d \triangleleft t \triangleleft e$. We propose the following:

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-25.jpg?height=176&width=1084&top_left_y=1408&top_left_x=518)

To prove the two required maps agree, consider the following diagram:

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-25.jpg?height=208&width=1027&top_left_y=1674&top_left_x=538)

By (14), the inner rectangle commutes: $(\varphi \triangleleft e) q\left(\delta_{d} \triangleleft t \triangleleft e\right)=\left(t \triangleleft \delta_{e} \triangleleft e\right) \nsubseteq(\varphi \triangleleft e \triangleleft e) \nsubseteq(d \triangleleft \varphi \triangleleft e)$. By

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-25.jpg?height=43&width=1512&top_left_y=1949&top_left_x=304)
And finally, we have $\left(t \triangleleft e \triangleleft \delta_{e}\right) \circ(\varphi \triangleleft e \triangleleft e)=(\varphi \triangleleft e) \circ\left(d \triangleleft t \triangleleft \delta_{e}\right)$. Together these give us the required equation:

$$
\begin{aligned}
\left(t \triangleleft \delta_{e}\right) \circ(\varphi \triangleleft e) \circ\left(\delta_{d} \triangleleft t \triangleleft e\right) & =\left(t \triangleleft \delta_{e}\right) \circ\left(t \triangleleft \delta_{e} \triangleleft e\right) \circ(\varphi \triangleleft e \triangleleft e) \circ(d \triangleleft \varphi \triangleleft e) \\
& =\left(t \triangleleft \delta_{e}\right) \circ\left(t \triangleleft e \triangleleft \delta_{e}\right) \circ(\varphi \triangleleft e \triangleleft e) \circ(d \triangleleft \varphi \triangleleft e) \\
& =\left(t \triangleleft \delta_{e}\right) \circ(\varphi \triangleleft e) \circ\left(d \triangleleft t \triangleleft \delta_{e}\right) \circ(d \triangleleft \varphi \triangleleft e)
\end{aligned}
$$

Thus we have proved that the two maps from (19) agree. To prove that $t \triangleleft e$ is actually the equalizer, one can perform a lengthy but routine set-theoretic calculation on positions and directions; we leave this to the reader.

Finally, every bicomodule $c \triangleleft S \Delta \int 0$ gives rise to an effects handler, $c \triangleleft S \leftarrow S=S \triangleleft 0$. Similarly, every bicomodule $c \triangleleft s \_y$ gives rise to a an effects handler $c \triangleleft s \leftarrow s=s \triangleleft y$. In both cases, the required commutativity (14) follows from that of the bicomodules.

Lemma C.6. For any sets $S, T$ : Set and polynomial $p$ : Poly, the maps

$$
S y \otimes p \xrightarrow{\cong} S y \triangleleft p \quad \text { and } \quad p \otimes y^{T} \xrightarrow{\cong} p \triangleleft y^{T}
$$

induced by the duoidal structure (3) are isomorphisms.

Proof. One checks that both maps are bijective on positions and directions.

Lemma C.7. For any sets $S, T$ : Set and polynomial $p$ there is a natural bijection between hom-sets

$$
\operatorname{Poly}(S y, p \triangleleft T y) \cong \operatorname{Set}(S, p \triangleleft T)
$$

Proof. The functor $(S \mapsto S y):$ Set $\rightarrow$ Poly is left adjoint to $(-\triangleleft 1)$ : Poly $\rightarrow$ Set.

Lemma C.8. For a set $S$ : Set and polynomials $p, q$ : Poly, there is a natural bijection between hom-sets

$$
\operatorname{Poly}(p, q \triangleleft S y) \cong \operatorname{Poly}\left(p \triangleleft y^{S}, q\right)
$$

Proof. For any $S$, the polynomial functor $S y$ is left adjoint to $y^{S}$, i.e. there is a unit $y \rightarrow y^{S} \triangleleft S y$ and a counit $S y \triangleleft y^{S} \rightarrow y$ satisfying the triangle equations. Given a map $p \rightarrow q \triangleleft S y$ one applies $\left(-\triangleleft y^{S}\right)$ to both sides and composes with the counit to obtain a map $p \triangleleft y^{S} \rightarrow q$, and given a map of the latter form, one applies $(-\triangleleft S y)$ to both sides and precomposes with the unit to obtain a map $p \rightarrow q \triangleleft S y$. The round-trips are identities by the triangle equations.

Theorem C. 9 (See Theorem 6.4). There is a pseudo-double functor $O \mathbf{r g} \rightarrow \mathbb{E f f}^{\mathrm{el}}$ which is the identity on objects and vertical morphisms and fully faithful on the category of horizontal morphisms and squares, with essential image given by the linear elementary effects handlers.

Proof. The vertical categories of both $\mathbb{O}$ rg and $\mathbb{E} f{ }^{\text {el }}$ are defined to be Poly. A horizontal morphism in $\mathbb{O} \mathbf{r g}$ from $q$ to $p$ is a $[q, p]$-coalgebra; we want to show that these can be identified with linear elementary $(p, q)$-effects handlers. Define $\mathbb{E} \mathrm{ff}_{\text {lin }}^{\mathrm{el}}(p, q)_{S}$ to be the category of linear elementary effects handlers with carrier $S y$ and define $x$-Coalg ${ }_{S}$ to be the category of $x$-coalgebras with carrier $S$. By Lemmas C. 6 to C. 8 and the adjunction $(-\otimes q) \dashv[q,-]$, we have the following isomorphisms, natural in $S$ :

$$
\begin{aligned}
& {[q, p]-\operatorname{Coalg}_{S} \cong \operatorname{Poly}(S,[q, p] \triangleleft S)} \\
& \cong \operatorname{Poly}(S y,[q, p] \triangleleft S y) \\
& \cong \operatorname{Poly}\left(S y \triangleleft y^{S},[q, p]\right) \\
& \cong \operatorname{Poly}\left(S y \otimes y^{S},[q, p]\right) \\
& \cong \operatorname{Poly}\left(S y \otimes q \otimes y^{S}, p\right) \\
& \cong \operatorname{Poly}\left((S y \otimes q) \triangleleft y^{S}, p\right) \\
& \cong \operatorname{Poly}\left(S y \triangleleft q, p \triangleleft y^{S}\right) \\
& \cong \mathbb{E f f}_{\text {lin }}^{\mathrm{el}}(p, q)_{S}
\end{aligned}
$$

It is straightforward to check that horizontal composition is preserved.

Squares in $O$ rg of the form

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-26.jpg?height=198&width=220&top_left_y=2183&top_left_x=947)
consist of maps $f: S \rightarrow S^{\prime}$ such that the following diagram commutes:

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-27.jpg?height=216&width=757&top_left_y=323&top_left_x=684)

This condition is equivalent to that for squares in $\mathbb{E} f f$, , which demand that the following diagram commutes:

![](https://cdn.mathpix.com/cropped/2024_06_19_20a7c0c6fb74b8dbb3ecg-27.jpg?height=204&width=358&top_left_y=646&top_left_x=881)

Thus the squares agree, as do compositions of squares, completing the proof.