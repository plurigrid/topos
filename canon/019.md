\title{
Copy-composition for probabilistic graphical models*
}

\author{
Toby St Clere Smithe \\ VERSES Research Lab \\ Topos Institute \\ act@tsmithe.net
}

\begin{abstract}
In probabilistic modelling, joint distributions are often of more interest than their marginals, but the standard composition of stochastic channels is defined by marginalization. Recently, the notion of 'copy-composition' was introduced in order to circumvent this problem and express the chain rule of the relative entropy fibrationally, but while that goal was achieved, copy-composition lacked a satisfactory origin story. Here, we supply such a story for two standard probabilistic tools: directed and undirected graphical models. We explain that (directed) Bayesian networks may be understood as "stochastic terms" of product type, in which context copy-composition amounts to a pull-push operation. Likewise, we show that (undirected) factor graphs compose by copy-composition. In each case, our construction yields a double fibration of decorated (co)spans. Along the way, we introduce a useful bifibration of measure kernels, to provide semantics for the notion of stochastic term, which allows us to generalize probabilistic modelling from product to dependent types.
\end{abstract}

\section*{1 Introduction}

Recent work has formalized the "chain rule" of the relative entropy (a.k.a. Kullback-Leibler divergence) as a section of a fibration of statistical games over Bayesian lenses [18]. Curiously, however, the base category of this fibration was not a category of stochastic channels (measure kernels), as one might expect, but instead a bicategory of copy-composite channels. The need for this stemmed from the Chapman-Kolmogorov rule for the composition of kernels, which involves marginalization; and marginalization does not commute with the logarithm defining the relative entropy. Copy-composition defers this marginalization (indeed, the Chapman-Kolmogorov rule is precisely the marginalization of the intermediate copy), so there is no problem of commutativity, and the chain rule thus obtains.

Although this yields an elegant fibrational structure, copy-composition is not strictly unital, owing to the extra copy produced when copy-composing with the identity. This means that the base of the fibration is necessarily a bicategory. Moreover, the construction of this bicategory [18, §2] was largely ad hoc, based on the similarity to a CoPara construction 【1, Remark 4]. This was despite the evident importance of copy-composition to the statistical problems of interest there: copy-composition constructs joint distributions, which are often of more interest in applications than the composite channels that would yield their marginals. This can be seen not only via the relative entropy, but also in the context of Bayesian networks, which describe the factorization of a joint distribution according to a graphical structure. Fong [7] studied Bayesian networks from a categorical perspective, making extensive use of comonoid ('copy-discard' [2]) structure to construct the corresponding joint distributions; see for example the proof of his Theorem 4.5.

In the present submission, we show how copy-composition emerges naturally (but distinctly) from the compositional structure of directed and undirected probabilistic graphical models, thereby replacing
\footnotetext{
*Some of this content appeared first on the author's website, such as at https://tsmithe.net/p/factor-graphs.html however, none has appeared elsewhere.
}
the earlier arbitrariness with something structurally meaningful. In the directed case, the key observation is that a Bayesian network may be understood as a "stochastic term" of some displayed type (which is invariably a product), equipped with a distribution (the 'prior') over its context. Identifying types with bundles and terms with sections, this means understanding the factors of a Bayesian network as stochastic sections; copy-composition then emerges via a pull-push operation. In the undirected case, one observes that the 'factors' of a factor graph are costate 1 in a copy-discard category, and that copy-composition amounts to a kind of gluing. In both cases, copy-composition appears as the horizontal composition operation of a pseudo double category, thereby extending the earlier bicategorical story. These double categorie $\sqrt{2}$ are in fact double fibrations, following the generalized decorated (co)span construction of Patterson [15]: in the directed case, one decorates spans of display maps with sections; in the undirected case, one decorates cospans with factors.

\section*{2 Directed models: pull-push stochastic sections}

A Bayesian network is a distribution (or measure) on a product space that factorizes into a product of conditional distributions (or measure kernels) that matches the structure of a directed acyclic graph $\llbracket 7$, Definition 3.7]. Interpreting this idea in a category of stochastic channels (such as measure kernels between measurable spaces), Fong [7, Theorem 4.5] showed that any Bayesian network can be written as a state $1 \rightarrow \otimes_{j} X_{j}$ that factorizes as the sequential composition of morphisms of the form

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-02.jpg?height=415&width=873&top_left_y=1191&top_left_x=623)

where $\mathrm{pa}(i)$ denotes the set of parents of the vertex $i$, and where $j<i$ iff there is no directed path from $i$ to $j$ (Fong calls this the 'ancestral' order on the vertices).

Each factor $X_{i} \mid \mathrm{pa}(i)$ only appears in the composite diagram as precomposed by a copier applied to its parents, and tensored with the identities of its grandparents. Interpreting the analogous string diagram

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-02.jpg?height=208&width=355&top_left_y=1891&top_left_x=885)

in Set, we see that it corresponds to the graph of the function $f: X \rightarrow Y$, which is a section of the product projection $X \times Y \rightarrow X$; in other words, a term of $X \times Y$ over the context $X$. Moreover, 'tensoring' this diagram with extra objects $W$ corresponds to pulling back the section along the projection $W \times X \rightarrow X$;
\footnotetext{
${ }^{1}$ A state in a monoidal category is a morphism out of the monoidal unit; a costate is a morphism into the monoidal unit.

${ }^{2}$ We take "double category" henceforth to mean pseudo double category, oriented such that composition is strict in the vertical category and weak in the horizontal.
}
in other words, extending the context by $W$. Thus, whereas Fong [7] constructed the preceding diagram by hand, with the right categorical setting we will be able to interpret it as resulting from standard type-theoretic operations. Our first task will therefore be to establish a bifibration of measure kernels in which these operations may be interpreted. Then, we will construct a double category whose horizontal composition implements these operations (and thus copy-composition) via 'pull-push' in the bifibration.

\subsection*{2.1 A bifibration of measure kernels}

The classic categorical semantics for dependent type theory is in fibrations [11, 14]: the base category is interpreted as a category of 'contexts'; the fibre over an object interprets the types in the corresponding context; elements in a fibre interpret terms; and pullback (base change) interprets substitution. The classic example is the codomain fibration of a finitely complete category, in which bundles 'display' types, and their sections are corresponding terms. The category Meas of measurable spaces and measurable functions between them is a finitely complete category, and so this story may be told there. But measurable functions are still deterministic; they are not kernels. However, we may replace the functions in the fibres by kernels and still obtain a fibration, which is the purpose of this section. In fact, we will obtain a bifibration. We begin by making the notion of kernel more precise.

Definition 2.1 (Measure kernel). Suppose $X$ and $Y$ are measurable spaces; we write $\Sigma_{X}$ and $\Sigma_{Y}$ for their $\sigma$-algebra structures. A (measure) kernel $k: X \rightsquigarrow Y$ is a function $k: X \times \Sigma_{Y} \rightarrow[0, \infty]$ that is measurable in its first argument and a measure in its second; i.e. such that $k(-, B): X \rightarrow[0, \infty]$ is measurable for all $B \in \Sigma_{Y}$ and $k(x,-): \Sigma_{Y} \rightarrow[0, \infty]$ is a (positive) measure for all $x \in X$.

General kernels are too ill-behaved to yield a well-defined category $\sqrt[3]{3}$, but for the purposes of $\$ 3$, we will want more than just probability kernels (those that measure 1 on the whole codomain). Staton [19] showed that $s$-finite kernels (countable sums of finite kernels) are expressive enough for statistical modelling while also yielding a well-defined category, and it is these that we shall employ.

Proposition 2.2 (Sums of kernels; $\llbracket 19$, Proposition 1]). Suppose $k_{1}, \ldots, k_{n}, \ldots$ is a countable sequence of kernels $X \rightsquigarrow Y$. Then there is a kernel $\sum_{i} k_{i}: X \rightsquigarrow Y$ given by their sum, $\left(\sum_{i} k_{i}\right)(x, B):=\sum_{i} k_{i}(x, B)$. Definition 2.3 (Finite and s-finite kernels). Suppose $k: X \rightsquigarrow Y$ is a kernel. Then:
1. $k$ is finite if there is some $r<\infty$ such that, for all $x \in X, k(x, Y)<r$;
2. $k$ is $s$-finite if there is a countable sequence of finite kernels $k_{1}, \ldots$ such that $k=\sum_{i} k_{i}$.

Staton [19, Theorem 4] tells us that s-finite kernels satisfy Fubini's theorem and thus yield a welldefined category. Composition of kernels $X \leadsto Y$ and $Y \leadsto Z$ is by Chapman-Kolmogorov; that is, by integrating over $Y$.

Definition 2.4 (The category sfKrn). The objects of sfKrn are measurable spaces. Morphisms from $X$ to $Y$ are s-finite kernels $X \leadsto Y$. Given kernels $X \stackrel{g}{\leadsto} Y \stackrel{h}{\leadsto} Z$, their composite $h \circ g: X \leadsto Z$ is defined by

$$
h \circ g:(x, C) \mapsto \int_{y: Y} g(x, \mathrm{~d} y) h(y, C)
$$

for $x \in X$ and $C \in \Sigma_{Z}$. The identity kernel id ${ }_{X}: X \leadsto X$ is given by Dirac delta: id $_{X}(x,-):=\delta_{x}(-)$. Equivalently, let $[x \in A]$ denote the indicator function

$$
[x \in A]= \begin{cases}1 & \text { if } x \in A \\ 0 & \text { otherwise }\end{cases}
$$
\footnotetext{
${ }^{3}$ They may not satisfy a "Fubini theorem", meaning that repeated integrals do not commute: consequently, ChapmanKolmogorov composition (introduced below) would not be associative.
}

Then $\operatorname{id}_{X}(x, A)=[x \in A]$.

We will use sfKrn to define a bifibration $\mathscr{K}$ over Meas, such that the objects of each fibre $\mathscr{K}_{B}$ will be (deterministic, measurable) functions into $B$, and the morphisms $(E, \pi) \rightsquigarrow\left(E^{\prime}, \pi^{\prime}\right)$ in $\mathscr{K}_{B}$ will be kernels $E \leadsto E^{\prime}$ "fibrewise over $B$ ". To form this idea into a precise definition, we need to be able to compose (or push forward) a kernel with (or along) a deterministic function.

Proposition 2.5 (Functions as kernels). Suppose $f: Y \rightarrow Z$ is a measurable function. Then there is a kernel $\delta_{f}: Y \rightsquigarrow Z$ defined by $\delta_{f}(y, C)=[f(y) \in C]$. This yields a functor $\delta_{(-)}:$Meas $\rightarrow$ sfKrn.

Definition 2.6 (The fibres of $\mathscr{K}$ ). Let $B$ be a measurable space; we define a corresponding category $\mathscr{K}_{B}$. Its objects are pairs $(E, p)$ of a measurable space $E$ and a measurable function $p: E \rightarrow B$. A morphism $k:(E, p) \rightarrow\left(E^{\prime}, p^{\prime}\right)$ is a kernel $k: E \leadsto E^{\prime}$ such that $\delta_{p^{\prime}} \circ k=\delta_{p}$; we call these morphisms kernels over $B$. Composition of morphisms is given by the composition of the corresponding kernels; identities are given by identity kernels. (It is easy to see that this yields a well-defined category.)

To see that the morphisms of $\mathscr{K}_{B}$ really are kernels fibrewise over $B$, let us introduce some notation.

Notation 2.7 (Fibre notation). Suppose $p: E \rightarrow B$ is a function and $b: J \rightarrow B$ is a generalized element of $B$ (another function). The fibre of $p$ over $b$ is given by the pullback of $p$ along $b$ :

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-04.jpg?height=190&width=247&top_left_y=1060&top_left_x=928)

We denote the fibre by $p[b] \xrightarrow{b^{*} p} J$.

Proposition 2.8 (Morphisms in $\mathscr{K}_{B}$ are fibrewise kernels). Suppose $k:(E, p) \rightsquigarrow\left(E, p^{\prime}\right)$ is a kernel over $B$, and $b: J \rightarrow B$ is a generalized element of $B$. Then $k$ restricts to a kernel $k[b]: p[b] \leadsto p^{\prime}[b]$.

Proof. Let $\pi_{E}: p[b] \rightarrow E$ be the projection as in the preceding pullback square; and let $\pi_{E^{\prime}}: p^{\prime}[b] \rightarrow$ $E^{\prime}$ be likewise for $p^{\prime}$. Then we have a kernel $k[b]: p[b] \times \Sigma_{p^{\prime}[b]} \rightarrow[0, \infty]$ by setting $k[b]\left(e_{b}, U_{b}\right):=$ $k\left(\pi_{E}\left(e_{b}\right), \pi_{E^{\prime}}\left(U_{b}\right)\right)$, where $\pi_{E^{\prime}}\left(U_{b}\right)$ denotes the image of $U_{b}$ under $\pi_{E^{\prime}}$.

It will be very useful to extend this fibrewise-restriction to composite kernels; fortunately, it commutes with composition. For the proof, see $\mathrm{A} .1$.

Proposition 2.9 (Fibrewise restriction commutes with composition). $(k \circ h)[b]=k[b] \circ h[b]$, whenever $k \circ h$ exists.

It is moreover easy to check that fibrewise restriction preserves identity kernels, which, together with the preceding proposition, means that it is functorial. In particular, given $b: J \rightarrow B$ in Meas, fibrewise restriction yields a reindexing functor $\Delta_{b}: \mathscr{K}_{B} \rightarrow \mathscr{K}_{J}$.

Corollary 2.10 (Substitution). Suppose $b: J \rightarrow B$ in Meas. Then we have a functor $\Delta_{b}: \mathscr{K}_{B} \rightarrow \mathscr{K}_{J}$ as follows. On objects, $\Delta_{b}$ acts to map $E \xrightarrow{p} B$ to $p[b] \xrightarrow{b^{*} p} J$. On morphisms, it maps $k$ to $k[b]$.

Proposition 2.11 (The stochastic self-indexing, and resulting fibration). Together with the substitution functors $\Delta$, the mapping $\mathscr{K}: B \mapsto \mathscr{K}_{B}$ defines a pseudo functor Meas ${ }^{\mathrm{op}} \rightarrow$ Cat. Pseudo functoriality follows from the (pseudo) functoriality of pullback and the functoriality of composition. Applying the Grothendieck construction to this indexed category yields a fibration $\int \mathscr{K} \rightarrow$ Meas.

It remains to exhibit left adjoints to the substitution functors $\Delta_{b}$.

Proposition 2.12 (Dependent sum functor). Suppose $f: C \rightarrow B$ is a morphism in Meas. Then there is a functor $\Sigma_{f}: \mathscr{K}_{C} \rightarrow \mathscr{K}_{B}$ defined on objects $E \xrightarrow{p} C$ by post-composition, $\Sigma_{f}(p):=E \xrightarrow{p} C \xrightarrow{f} B$ and on kernels as the identity.

Note that, fibrewise, we have $\Sigma_{f}(p)[b] \cong p\left[f^{*} b\right]$. Since $f^{*}$ is pullback in Meas and $\Delta$ is defined by pullback, this is the first sign of the adjointness of $\Sigma$ and $\Delta$. See A. for the proof of the proposition:

Proposition $2.13(\Sigma \dashv \Delta)$. Suppose $f: B \rightarrow C$ in Meas. Then $\Sigma_{f}$ is left adjoint to $\Delta_{f}$.

Thus $\mathscr{K}$ yields a bifibration. But this is not all we need: for copy-composition to be well-defined via pull-push, we need the functors $\Sigma$ and $\Delta$ to satisfy the Beck-Chevalley condition. This result follows because the self-indexing of Meas satisfies Beck-Chevalley; but an explicit proof may be found in A. 1

Proposition 2.14 ( $\mathscr{K}$ satisfies Beck-Chevalley). Suppose we have a pullback square in Meas of the form

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-05.jpg?height=230&width=288&top_left_y=823&top_left_x=924)

Then there is a natural isomorphism $\Sigma_{\rho} \Delta_{\pi} \cong \Delta_{q} \Sigma_{p}$.

Remark 2.15. In fact, the bifibration $\int \mathscr{K}$ has more structure than we have space to explore in the present study: each fibre has a tensor product that makes it into a monoidal fibration; each fibre additionally has biproducts (and, with an inconsequential modification, a zero object); and thus the subcategory of probability kernels in each fibre is a commutative effectus [3]. Moreover, these structures interact nicely with the base change functors. We leave the exposition of all this to future work.

\subsection*{2.2 Decorating spans with sections}

Our task now is to define a categorical structure in which morphisms include graphs (in the functional sense) and compose by copy-composition. That is, given the 'graphs' of $f: X \rightarrow Y$ and $g: Y \rightarrow Z$ in some underlying monoidal category, we wish to be able to compose them to yield

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-05.jpg?height=263&width=634&top_left_y=1652&top_left_x=751)

This composite is a section of the composite projection $X \times Y \times Z \rightarrow X \times Y \rightarrow X$. In turn, we may observe that this projection is the left leg of the composite span

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-05.jpg?height=249&width=765&top_left_y=2049&top_left_x=672)

and that the graphs of $f$ and $g$ are sections of the left legs of the constituent spans, respectively. Thus, if we can interpret graph $(f)$ and graph $(g)$ bifibrationally, we could write their composite (depicted above)
as $\Sigma_{\pi_{X}^{X Y}} \Delta_{\pi_{Y}^{X Y}}(\operatorname{graph}(g)) \circ \operatorname{graph}(f)$. The operation $\Sigma_{\pi_{X}^{X Y}} \Delta_{\pi_{Y}^{X Y}}$ is known as a "pull-push" operation [16], because one first pulls back along $\pi_{Y}^{X Y}$ and then pushes forward along $\pi_{X}^{X Y}$.

When $f$ and $g$ are morphisms in a finitely complete category, we can immediately make sense of this pull-push composition in the codomain fibration. Likewise, when they are s-finite kernels, we can interpret this story in $\mathscr{K}$, and this is the situation that allows us to construct Bayesian networks and recover the chain rule of the relative entropy. Nonetheless, all we require is a bifibration satisfying Beck-Chevalley (and a section of it). The idea is then to decorate spans in the base of the bifibration with sections of the left leg, and then to compose them by pullback on the spans and pull-push on the decorations. Thus we have a "decorated span" construction, in the sense of Fong [8] and Patterson [15].

Patterson [15] observed that adding compositional decorations to categorical constructions often signals a Grothendieck fibration. Since spans (and cospans) collect into double categories, the decorated (co)span construction can be reconceived as a double Grothendieck construction, giving an extra dimension of composition to that originally proposed by Fong [8], and newly allowing the decorations to depend on whole (co)spans (rather than merely their apices), a freedom we will need. Following Cruttwell et al. [5, Theorem 3.51], the double Grothendieck construction produces a double fibration from an indexed double category, i.e. a lax double pseudo functor whose codomain is the double 2-category $\mathbb{S p a n}($ Cat) of spans of categories; see Patterson $[15, \S 3.1]$ for a summary.

Definition 2.16. A lax double pseudo functor $F: \mathbb{C} \rightarrow \mathbb{D}$ consists of a pair of pseudo functors $F_{0}: \mathbb{C}_{0} \rightarrow$ $\mathbb{D}_{0}$ (from the vertical category of $\mathbb{C}$ to that of $\mathbb{D}$ ) and $F_{1}: \mathbb{C}_{1} \rightarrow \mathbb{D}_{1}$ (from the horizontal category of $\mathbb{C}$ to that of $\mathbb{D}$ ), along with pseudo natural transformations $\mu$ and $\eta$ witnessing the compatibility of $F_{1}$ and $F_{0}$ with the double category structures of $\mathbb{C}$ and $\mathbb{D}$, as in the diagrams
![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-06.jpg?height=276&width=954&top_left_y=1280&top_left_x=584)

such that four standard coherence axioms [5, Def. 3.12] are satisfied. ( $\diamond$ denotes the 'external' (2-cell) composition of a double category structure and $I$ its unit, so that, in the context of indexed double categories, $\mu$ implements the indexed external composition, and $\eta$ implements its unit.)

An indexed double category is a lax double pseudo functor with codomain $\mathbb{S p a n}($ Cat $)$.

Suppose now that $\mathscr{E} \xrightarrow{\pi} \mathscr{B}$ is a bifibration satisfying Beck-Chevalley, equipped with a section $l$ : $\mathscr{B} \rightarrow \mathscr{E}$, where $\mathscr{B}$ has all pullbacks; we will continue to write $\mathscr{E}_{B}$ for the fibre over $B: \mathscr{B}$, and $\Sigma \dashv \Delta$ for the base change functors, and assume that $\Delta$ preserves $\imath$. Our model for $\mathscr{E}$ will be either $\int \mathscr{K}$ or the codomain fibration of a finitely complete category; and for $\imath$ the mapping $B \mapsto\left(\mathrm{id}_{B}: B \rightarrow B\right)$, so that morphisms out of $l$ are understood as sections (and thus models for terms). We will construct an indexed double category $S: \mathbb{S p a n}(\mathscr{B})_{p b}^{\mathrm{op}} \rightarrow \mathbb{S p a n}($ Cat $)$, where $\mathbb{S p a n}(\mathscr{B})_{p b}$ is the sub-double category of $\operatorname{Span}(\mathscr{B})$ whose 2-cells are Cartesian morphisms of spans (a restriction necessary for morphisms of decorations to be well-defined), and the ${ }^{\mathrm{op}}$ is taken vertically.

The vertical category of $\operatorname{Span}(\mathscr{B})_{p b}$ is $\mathscr{B}$, and the vertical 2-category of $\operatorname{Span}($ Cat $)$ is Cat; but the vertical decorations will be trivial: $S_{0}$ is simply the constant functor on the terminal category $\mathbf{1}$.

There is a simplification in the horizontal direction, too. The horizontal category of $\operatorname{Span}(\mathscr{B})_{p b}$

is $\mathscr{B}_{p b}^{\{\bullet \leftarrow \bullet \bullet\}}$, the category of diagrams in $\mathscr{B}$ of shape $\bullet \leftarrow \bullet \rightarrow \bullet$, with morphisms restricted to those natural transformations that are Cartesian (i.e., constituting pullback squares). $S_{1}$ must map a span $m=$
$(A \stackrel{a}{\leftarrow} E \xrightarrow{b} B)$ in $\mathscr{B}$ to a span $\mathbf{1} \leftarrow S_{1}(m) \rightarrow \mathbf{1}$ of categories. Because $\mathbf{1}$ is terminal in Cat, the legs of the latter span are accordingly determined. There is a further simplification: $S_{1}(m)$ will be a discrete category (a set). Indeed, we define $S_{1}(m)$ to be the set of sections of the left leg of $m$ in $\mathscr{E}$. That is, $S_{1}(m):=\mathscr{E}_{A}\left(l A, \Sigma_{a} l E\right)$.

Given a morphism $f: m \rightarrow m^{\prime}$ in $\mathbb{S p a n}(\mathscr{B})_{p b}$ as in the diagram

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-07.jpg?height=174&width=393&top_left_y=501&top_left_x=866)

$S_{1}(f)$ must be a function $\mathscr{E}_{A^{\prime}}\left(l A^{\prime}, \Sigma_{a^{\prime}} l E^{\prime}\right) \rightarrow \mathscr{E}_{A}\left(l A, \Sigma_{a} l E\right)$, which we take to be given by $\Delta_{f_{l}}$. This is well defined because $\Delta_{f_{l}} \imath A^{\prime}=\imath_{A}$ ex hypothesi, $\Delta_{f_{l}} \Sigma_{a^{\prime}} \imath E^{\prime} \cong \Sigma_{a} \Delta_{f} \imath E^{\prime}$ by Beck-Chevalley, and $\Delta_{f} \imath E^{\prime}=\imath E$ ex hypothesi. Moreover, since $\Delta_{f_{l}}$ is functorial, so is $S_{1}(f)$.

The copy-composition of sections is implemented by the transformation $\mu$, whose component at a pair of composable spans $m=(A \stackrel{a}{\leftarrow} E \xrightarrow{b} B)$ and $n=\left(B \stackrel{b^{\prime}}{\leftarrow} F \xrightarrow{c} C\right)$ must be a function $\mu_{m, n}$ : $S_{1}(m) \times S_{1}(n) \rightarrow S_{1}(n \diamond m)$, which we take to be defined by pull-push. That is, $\mu_{m, n}(\sigma, \tau):=\Sigma_{a} \Delta_{b}(\tau) \circ \sigma$. Associativity of $\mu$ follows by Beck-Chevalley; the explicit proof is in Appendix A.2. The unit $\eta$ is defined over each identity span $E=E=E$ by the function $\eta_{E}: \mathbf{1} \rightarrow \mathscr{E}_{E}(\imath E, \imath E)$ determined by the identity on $\imath_{E}$. Note that this makes pull-push copy-composition strictly unital, unlike in St Clere Smithe [18].

Applying the double Grothendieck construction [5, Theorem 3.51] to $S$ yields a double category $\mathbb{S}$, doubly fibred over $\operatorname{Span}(\mathscr{B})_{p b}$, which has the following structure:

1. The objects of $\mathbb{S}$ are the objects of $\mathscr{B}$.

2. A vertical 1-cell is a morphism of $\mathscr{B}$, and vertical composition is as in $\mathscr{B}$.

3. A horizontal 1-cell $A \nrightarrow B$ is a quadruple $(E, a, b, \sigma)$ where $(A \stackrel{a}{\leftarrow} E \xrightarrow{b} B)$ is a span with $\sigma$ being a section of the left leg in $\mathscr{E}_{A}$; i.e., $\sigma \in \mathscr{E}_{A}\left(\imath A, \Sigma_{a} \iota E\right)$.

4. A 2 cell from $(E, a, b, \sigma): A \nrightarrow B$ to $\left(E^{\prime}, a^{\prime}, b^{\prime}, \sigma^{\prime}\right): A^{\prime} \nrightarrow B^{\prime}$ is a Cartesian morphism of spans $\left(f_{l}, f, f_{r}\right):(A \stackrel{a}{\leftarrow} E \xrightarrow{b} B) \Rightarrow\left(A^{\prime} \stackrel{a^{\prime}}{\leftarrow} E^{\prime} \xrightarrow{b^{\prime}} B^{\prime}\right)$ such that $\sigma=\Delta_{f_{l}} \sigma^{\prime}$.

5. Horizontal composition is by pullback on the spans (and their morphisms) and by pull-push on the sections, as described above.

That is to say, we have the following theorem (given the details in Appendix A.2).

Theorem 2.17 (Copy-composition of sections). Given a bifibration $\mathscr{E} \rightarrow \mathscr{B}$ over a finitely complete base, satisfying Beck-Chevalley, and equipped with a section $t: \mathscr{B} \rightarrow \mathscr{E}$ preserved by pullback, the foregoing data define a pseudo double category $\mathbb{S}$ doubly fibred over $\mathbb{S p a n}(\mathscr{B})_{p b}$.

By instantiating $\mathbb{S}$ in $\int \mathscr{K}$, we can formally recover the factors of a Bayesian network described by Fong [7] and introduced at the beginning of this section. There is a lax embedding of sfKrn horizontally into $\mathbb{S}$ (so instantiated), which maps a kernel to its graph. Let $\sigma$ denote the image of the kernel $X_{i} \mid \mathrm{pa}(i)$ under this embedding, which has the effect of precomposing it with copiers. Then, to tensor with the identity wires $\otimes_{j \notin \mathrm{pa}(i)} X_{j}$, we can pull $\sigma$ back along the projection $\prod_{j<i} X_{j} \rightarrow \prod_{j \in \mathrm{pa}(i)} X_{j}$, as in the diagram

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-07.jpg?height=259&width=790&top_left_y=2169&top_left_x=665)

The upper decorated span is the horizontal morphism corresponding to Fong's factor. Finally, note that whereas traditional statistical modelling is restricted to sections of product types (as above), using $\mathscr{K}$ and $\mathbb{S}$ means we can build probabilistic models involving general dependent types.

\section*{3 Undirected models: open factor graphs}

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-08.jpg?height=388&width=743&top_left_y=608&top_left_x=688)

Figure 1: A factor graph, in the style of Wainwright and Jordan [20, §2.1.3].

The preceding section explained how copy-composition is central to Bayesian networks: directed probabilistic graphical models. In this section, we shall see that it is also central to the construction of undirected models known as factor graphs [6, 20]. A factor graph is a graphical representation of the factorization of a function, which is often but not necessarily interpreted as the density of a probability distribution. Thus Figure 1 represents a function $f$ of the form

$$
f(a, b, c, d, e)=f_{0}(a, b) f_{1}(a, c) f_{2}(b, c, d) f_{3}(d, e) f_{4}(e) f_{5}(d)
$$

where the variables have the types $a: A, b: B, c: C, d: D$. Note that we could see $f$ as composed of 'factors' $f_{i}$; it is this composition that we explore here.

Typically, the factors of a factor graph are functions into some object of scalars; for example, we might interpret $f_{2}$ (above) to have the type $B \times C \times D \rightarrow \mathbb{R}_{+}$, for some spaces $B, C, D$. Should these spaces be $\mathbb{R}_{+}$-modules, then we might suppose $f_{2}$ to be a linear functional or covector on their product. $\mathbb{R}_{+}$-modules form a category $\operatorname{Mod}_{\mathbb{R}_{+}}$which is equipped with a tensor product $\otimes$, whose unit is the 1-dimensional space of scalars $\mathbb{R}_{+}$, often denoted $I$. Covectors on $X$ then correspond to costates morphisms $X \rightarrow I$. This suggests that we may internalize the notion of factor in a monoidal category $(\mathscr{C}, \otimes, I)$ simply as the costates in $\mathscr{C}$.

This first step towards an abstract treatment should be taken with care, as any semicartesian monoidal category, such as Set or any Markov category (in the sense of Fritz [10]), will only have trivial costates, the monoidal unit there being by definition terminal. The composition of factors then proceeds by copycomposition; notice for example the duplication of the variable $b: B$ in the expression for $f$ above, or in the following string-diagrammatic representation of its $f_{0}, f_{2}$ factor:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-08.jpg?height=217&width=290&top_left_y=2209&top_left_x=912)

This suggests that an appropriate categorical setting for factor graphs is that of copy-discard categories 4 , of which sfKrn (or any fibre of $\mathscr{K}$ ) is an example.

Because factor graphs are a form of undirected graphical model, it is natural to expect them to fit into the framework of undirected wiring diagrams [17] [21, Chapter 7]. Undirected wiring diagrams are algebras for an operad of cospans [9], and one way to obtain such algebras is through the decorated cospans construction, originally due to Fong [8]. (But note that the decorated spans of the previous section are not undirected in the same way, because the decorations there are asymmetric.) The main result of this section is to show that 'open' factor graphs may be obtained and composed precisely through the double-categorical generalization of this construction due to Patterson [15].

Remark 3.1. Fong and Spivak [9] show that cospan-algebras are equivalent to hypergraph categories, in which each morphism has the form of a hypergraph. Consequently, this is also the case for factor graphs.

The remainder of this section is dedicated to constructing a double category indexed by cospans, i.e. a double pseudo functor $F$, and instantiating its double Grothendieck construction, the double category $\mathbb{F} \mathbb{G}$. The domain of $F$ is the double category of cospans of finite sets, whose vertical category Cospan(FinSet $)_{0}$ is simply FinSet, and whose horizontal category $\operatorname{Cospan}(\text { FinSet })_{1}$ is the category of diagrams in FinSet of shape $\bullet \rightarrow \bullet \leftarrow \bullet$, i.e. the functor category FinSet ${ }^{\{\bullet \rightarrow \bullet \leftarrow \bullet\}}$. The codomain of $F$ is

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-09.jpg?height=51&width=1453&top_left_y=1037&top_left_x=263)

Henceforth, we will assume an ambient copy-discard category $(\mathscr{C}, I, \otimes)$. Because finite sets are not ordered and we plan to define factors over accordingly indexed monoidal products, we must additionally assume that the monoidal structure $(I, \otimes)$ on $\mathscr{C}$ is symmetric.

There will be fewer simplifications involved in the definition of $F$ (versus $S$ ), and so we split the construction into four subsections.

\subsection*{3.1 Vertical decoration: factors' interfaces}

The pseudo functor $F_{0}:$ FinSet $\rightarrow$ Cat assigns categories of decorations to finite sets. For us, these decorations will be the exposed interfaces of factors, given by a discrete diagram in $\mathscr{C}$ : a functor disc $X \rightarrow$ $\mathscr{C}$, for some finite set $X$, where disc $X$ is the discrete category on $X$. However, were we just to define $F_{0} X$ to be the functor category $\operatorname{Cat}(\operatorname{disc} X, \mathscr{C})$, we would run into problems later with the composition of 2-cells. This is because vertical morphisms - decorated by morphisms in the image of $F_{0}$ - may be used to transform the interface types, but the composition of factors proceeds by copying. For this to be compatible with morphisms of interfaces, we must restrict the latter to be comonoid homomorphisms, which (in probabilistic contexts) we can often understand as deterministic functions.

Therefore, on objects $X:$ FinSet, let $F_{0} X$ be the functor category $\operatorname{Cat}(\operatorname{disc} X, \operatorname{Comon}(\mathscr{C}, I, \otimes))$ where $\operatorname{Comon}(\mathscr{C}, I, \otimes)$ denotes the (wide) monoidal subcategory of $\mathscr{C}$ whose morphisms are the comonoid homomorphisms. Note that, because the objects $\chi$ of $F_{0} X$ are functors on a discrete category, a morphism $\varphi: \chi \rightarrow \chi^{\prime}$ (hence a natural transformation) is simply given by an $X$-indexed family of comonoid homomorphisms $\varphi_{x}: \chi(x) \rightarrow \chi^{\prime}(x)$ in $\mathscr{C}$.

Given a morphism $f: X \rightarrow Y$ in FinSet, we let $F_{0}$ return a functor $F_{0} X \rightarrow F_{0} Y$ which we denote by $f_{*}$ and define as follows. If $\chi$ is an object of $F_{0} X$ then we define $f_{*} \chi$ by the mapping $y \mapsto \otimes_{x: f^{-1}(y)} \chi(x)$ (for $y: Y$ ). Then, if $\varphi: \chi \rightarrow \chi^{\prime}$ is a morphism of $F_{0} X$, we define each $y$-component $\left(f_{*} \varphi\right)_{y}$ of $f_{*} \varphi$ to be
\footnotetext{
${ }^{4}$ A copy-discard category is a monoidal category in which every object is equipped with a comonoid structure (with respect to the ambient monoidal structure) [2]. A Markov category is a semicartesian copy-discard category [10]. Precisely because of the existence of non-trivial costates, copy-discard categories often end up being more useful in modelling practice than Markov categories, despite the utility of the latter for synthetic probability theory.
}
$\otimes_{x: f^{-1}(y)} \varphi_{x}$. Note that this definition yields components of the correct type

$$
\left(f_{*} \varphi\right)_{y}:\left(f_{*} \chi\right)(y)=\otimes_{x: f^{-1}(y)} \chi(x) \xrightarrow{\otimes_{x: f^{-1}(y)} \varphi_{x}} \otimes_{x: f^{-1}(y)} \chi^{\prime}(x)=\left(f_{*} \chi^{\prime}\right)(y)
$$

Naturality is trivially satisfied, because $\chi$ and $\chi^{\prime}$ are discrete functors, and the functoriality of the reindexing $f_{*}$ follows from the functoriality of $\otimes$. Likewise, the pseudofunctoriality of $F_{0}$ itself follows from the functoriality of inverse images and the functoriality and symmetry of $\otimes$, so that $\otimes_{y: g^{-1}(z)} \otimes_{x: f^{-1}(y)} \cong \otimes_{x:(g \circ f)^{-1}(z)}$.

\subsection*{3.2 Horizontal decoration: 'open' factors}

The pseudo functor $F_{1}: \operatorname{FinSet}^{\{\bullet \bullet \bullet \leftarrow \bullet\}} \rightarrow \mathbf{C a t}^{\{\bullet \leftarrow \bullet \bullet\}}$ assigns spans of categories to cospans of finite sets, compatibly with $F_{0}$. We interpret a cospan $A \xrightarrow{a} X \stackrel{b}{\leftarrow} B$ as follows. The apex set $X$ will be decorated with two kinds of data: first, a category of interfaces suited to factors in $\mathscr{C}$; and second, for each suitable interface, a category of factors on that interface (compatibly with morphisms of interfaces). The legs of the cospan $a$ and $b$ will be used to expose those parts of the interface which are open to composition, and in this way the objects $A$ and $B$ will be decorated by $F_{0} A$ and $F_{0} B$ respectively; this is one of the indexed-double-categorical coherence axioms ('well-definition').

Thus, given a cospan $m=(A \xrightarrow{a} X \stackrel{b}{\leftarrow} B)$, we let $F_{1}$ return a span of categories $F_{0} A \stackrel{\pi_{a}}{\leftarrow} \int \underline{F_{1} m} \xrightarrow{\pi_{b}} F_{0} B$. The apex category $\int \underline{F_{1}} m$ has for objects pairs $(\chi, f)$ where $\chi: \operatorname{disc} X \rightarrow \mathscr{C}$ is an interface and $\bar{f}: \chi^{\otimes} \rightarrow I$ is a factor on that interface. $\chi^{\otimes}$ denotes the monoidal product $\otimes_{x: X} \chi(x)$ in $\mathscr{C}$. The morphisms of $\int \underline{F_{1} m}$ are factorizations of factors through transformations of interfaces; that is to say, a morphism $(\chi, f) \rightarrow\left(\chi^{\prime}, f^{\prime}\right)$ in $\int \underline{F_{1}} m$ is a morphism of interfaces $\varphi: \chi \rightarrow \chi^{\prime}$ such that $f=\varphi^{*} f^{\prime}$, where $\varphi^{*}$ denotes precomposition by $\varphi^{\otimes}:=\otimes_{x: X} \varphi_{x}$. The functors $\pi_{a}$ and $\pi_{b}$ forget the factors and project out those parts of the interfaces over $X$ that are exposed by $a$ and $b$ respectively. ( $\int \underline{F_{1}} m$ and the functors $\pi_{a}, \pi_{b}$ are in fact obtained through universal constructions - a limit and a Grothendieck construction - as we explain in Appendix B. 1 . Universality then yields the functorial action of $F_{1}$ on morphisms of cospans.)

\subsection*{3.3 Factor composition}

The functors $F_{0}$ and $F_{1}$ describe how to attach factors to interfaces, and how these interfaces (and the factors on them) may be transformed by morphisms in $\mathscr{C}$. But they do not tell us about the operation at the heart of the open factor graph construction: the horizontal (copy-)composition of factors, or the horizontal composition of their morphisms. These operations are formalized by the external composition structure $(\mu, \eta)$ with which we now equip $F$.

Let us begin with $\mu$, a pseudo natural transformation whose component $\mu_{m, n}$ at a pair of composable

cospans $m=(A \xrightarrow{a} X \stackrel{b}{\leftarrow} B)$ and $n=\left(B \xrightarrow{b^{\prime}} Y \stackrel{c}{\leftarrow} C\right)$ must be a functor $\int \underline{F_{1}} m \times{ }_{F_{0} B} \int \underline{F_{1}} n \rightarrow \int \underline{F_{1}}(n \diamond m)$. Given factors $(\chi, f),(\gamma, g)$ in its domain, $\mu_{m, n}$ must return an interface over $X+{ }_{B} Y$ and a factor on that interface. The former is given by the copairing $[\chi, \gamma]_{B}$ of $\chi$ and $\gamma$ over $B$, while the latter is given by copy-composition. For each $j: X{ }_{B} Y$, copying induces a morphism

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-10.jpg?height=117&width=614&top_left_y=2164&top_left_x=753)

in $\mathscr{C}$ which is unique up to coassociativity. We then define $\delta_{\chi, \gamma}:=\otimes_{j: X+{ }_{B} Y} \delta_{\chi, \gamma}^{j}$, which has the type $[\chi, \gamma]_{B}^{\otimes} \rightarrow[\chi, \gamma]^{\otimes}$. We can compose $f \otimes g$ after this higher-arity copier to yield a factor on the interface
$[\chi, \gamma]_{B}$. Thus $\mu_{m, n}((\chi, f),(\gamma, g)):=\left([\chi, \gamma]_{B},(f \otimes g) \circ \delta_{\chi, \gamma}\right)$. (For a more detailed construction and proof that this yields a pseudo natural transformation, see Appendix B.2.)

To see $\mu$ in action, suppose $A$ has $l$-many elements, $C$ has $n$-many elements, and the coupled interface $B$ has $m$-many elements, with $B_{1}$ shared once between $f$ and $g$ but $B_{m}$ shared an arbitrary number of times. Then $\mu((\chi, f),(\gamma, g))$ yields the factor

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-11.jpg?height=214&width=564&top_left_y=506&top_left_x=778)

The naturality of $\mu_{m, n}$ means that if we were to have $f^{\prime}$ and $g^{\prime}$ defined by transforming the interface $B$ along $\beta$ like so

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-11.jpg?height=244&width=721&top_left_y=816&top_left_x=694)

then copy-composing $f^{\prime}$ and $g^{\prime}$ along $B^{\prime}$ yields the same as copy-composing $f$ and $g$ along $B$ and then transforming the $B$ interface of the result accordingly:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-11.jpg?height=271&width=1006&top_left_y=1174&top_left_x=557)

However, this only works for 'determinsitic' transformations $\beta$ : although the rules of open factor graphs do allow us to transform factors using arbitrary morphisms, we can only pull these transformations 'outside' the composites when the transformations are comonoid homomorphisms.

It remains to define the unit $\eta$, a pseudo natural transformation whose component $\eta_{X}$ at each finite set $X$ is given by a functor $\eta_{X}: F_{0} X \rightarrow \int F_{1}\left(\right.$ id $\left._{X}\right)$. We define $\eta_{X}$ using the counits of the comonoid structures on the interfaces on $X$. That is to say, $\eta_{X}$ maps an interface $\chi: \operatorname{disc} X \rightarrow \operatorname{Comon}(\mathscr{C})$ to the pair $\left(\chi, \varepsilon_{\chi}\right)$, where here $\varepsilon_{\chi}$ denotes the canonical discarding map $\chi^{\otimes} \rightarrow I$. The functorial action of $\eta_{X}$ is obtained from the fact that all morphisms in $F_{0} X$ are comonoid homomorphisms, so if $\varphi$ is a morphism $\chi \rightarrow \chi^{\prime}$ then $\varepsilon_{\chi}=\varphi^{*} \varepsilon_{\chi^{\prime}}$. Pseudo naturality of $\eta$ obtains likewise, and its unitality with respect to $\mu$ follows from the counitality of the comonoid counits.

\subsection*{3.4 Putting it all together}

We have defined a double pseudo functor $F: \mathbb{C o s p a n}($ FinSet $) \rightarrow \mathbb{S p a n}($ Cat $)$, from which we obtain a double category of open factor graphs $\mathbb{F} \mathbb{G}$, doubly opfibred over $\mathbb{C o s p a n}($ FinSet), by applying the double Grothendieck construction. This gives $\mathbb{F} \mathbb{G}$ the following structure:

1. Its objects ( 0 -cells) are pairs $(A, \alpha)$ where $A$ is a finite set and $\alpha$ is an object of $F_{0} A$ - i.e., an interface in $\mathscr{C}$ on $A$.

2. A vertical 1-cell $(A, \alpha) \rightarrow\left(A^{\prime}, \alpha^{\prime}\right)$ is a pair $(f, \varphi)$ of a map $f: A \rightarrow A^{\prime}$ and a deterministic transformation of interfaces $\varphi: f_{*} \alpha \rightarrow \alpha^{\prime}$ - where $f_{*}=F_{0}(f)$ so that $\varphi$ is a morphism in $F_{0} A^{\prime}$.

3. A horizontal 1-cell $(A, \alpha) \nrightarrow(B, \beta)$ is a quintuple $(X, a, b, \chi, p)$ where $(A \xrightarrow{a} X \stackrel{b}{\leftarrow} B)$ is a cospan of finite sets, $\chi$ is an interface on $X$, and $p$ is a factor on $\chi$ - i.e., $(\chi, p)$ is an object of $\int \underline{F_{1}}(X, a, b)$ $—$ such that $\pi_{a}(\chi, p)=\alpha$ and $\pi_{b}(\chi, p)=\beta$.

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-12.jpg?height=257&width=1558&top_left_y=408&top_left_x=305)

is a map of finite sets and $\varphi$ is a transformation of interfaces $f_{*} \chi \rightarrow \chi^{\prime}$, such that $f_{*} p=\varphi^{*} p^{\prime}$, $\pi_{a^{\prime}}(\varphi)=\varphi^{l}, \pi_{b^{\prime}}(\varphi)=\varphi^{r}$ (with $\varphi^{l}$ and $\varphi^{r}$ deterministic), and such that $\left(f, f^{l}, f^{r}\right)$ constitutes a morphism of cospans, meaning that $a^{\prime} \circ f^{l}=f \circ a$ and $b^{\prime} \circ f^{r}=f \circ b$.

5. Vertical 1-cells $(f, \varphi):(A, \alpha) \rightarrow\left(A^{\prime}, \alpha^{\prime}\right)$ and $\left(f^{\prime}, \varphi^{\prime}\right):\left(A^{\prime}, \varphi^{\prime}\right) \rightarrow\left(A^{\prime \prime}, \varphi^{\prime \prime}\right)$ compose to yield $\left(f^{\prime} \circ\right.$ $\left.f, \varphi^{\prime} \circ f_{*}^{\prime} \varphi\right):(A, \alpha) \rightarrow\left(A^{\prime \prime}, \alpha^{\prime \prime}\right)$; the vertical composition of 2-cells is similar. The vertical identity 1-cell on $(A, \alpha)$ is the pair $\left(\mathrm{id}_{A}, \mathrm{id}_{\alpha}\right.$ ) of identity morphisms $\mathrm{id}_{A}: A \rightarrow A$ and $\mathrm{id}_{\alpha}: \alpha \rightarrow \alpha$. We denote vertical composition by $\circ$.

6. Finally, horizontal 1-cells (and 2-cells, horizontally) compose by cospan- and copy-composition, as described in $\$ 3.3$. Horizontal identities are given by the external unit $\eta$. We denote horizontal composition by $\diamond$.

All told, this (plus the details in Appendix B) yields the following theorem.

Theorem 3.2 (Open factor graphs). Given a symmetric monoidal copy discard category $(\mathscr{C}, I, \otimes)$, the foregoing data define a pseudo double category $\mathbb{F} \mathbb{G}$ doubly opfibred over $\mathbb{C o s p a n}($ FinSet $)$.

Remark 3.3. Since each of the elements of the construction of $\mathbb{F} \mathbb{G}$ are functorial, we expect the construction itself to be functorial, so that a functor $\mathscr{C} \rightarrow \mathscr{C}^{\prime}$ yields a double functor $\mathbb{F} \mathbb{G}_{\mathscr{C}} \rightarrow \mathbb{F} \mathbb{G}_{\mathscr{C}}$. But we have not established this, and leave it to future work.

In other future work, we hope to make use of $\mathbb{F} \mathbb{G}$ to study the compositionality of inference on factor graphs, and to study the formal relationships between directed and undirected models.

\subsection*{3.5 On a graphical calculus}

We motivated the construction of $\mathbb{F} \mathbb{G}$ with the graphic Figure 1, Decorated cospan categories as originally formulated inherit a graphical calculus from their status as hypergraph categories or undirected wiring diagram algebras. Lacking a formal theory of double operads and their graphical calculi, we do not have a similarly formal graphical calculus for $\mathbb{F} \mathbb{G}$; still, we expect that its horizontal bicategory (appropriately quotiented) would fit the undirected wiring diagram pattern, at the cost of the transformations of interfaces. Inspired by this, and in an attempt not to pay that cost, in Appendix B. 3 we (informally) propose a graphical calculus that matches and extends the non-compositional depictions in the statistics literature.

\section*{4 References}

[1] Matteo Capucci, Bruno Gavranović, Jules Hedges, and Eigil Fjeldgren Rischel. "Towards Foundations of Categorical Cybernetics". In: Electronic Proceedings in Theoretical Computer Science. Applied Category Theory 2021. Vol. 372. Cambridge, UK: Open Publishing Association, 11/03/2022, pp. 235-248. DOI: 10.4204/EPTCS.372.17, URL: http://arxiv.org/abs/2105. $06332 \mathrm{v} 2$ (visited on 09/29/2023).

[2] Kenta Cho and Bart Jacobs. "Disintegration and Bayesian Inversion via String Diagrams". In: Math. Struct. Comp. Sci. 29 (2019) 938-971 (08/29/2017). DOI: 10.1017/S0960129518000488. arXiv: $1709.00322 \mathrm{v} 3[\mathrm{cs.AI}]$

[3] Kenta Cho, Bart Jacobs, Bas Westerbaan, and Abraham Westerbaan. "An Introduction to Effectus Theory". 2015. arXiv: 1512.05813 [cs.LO].

[4] Bob Coecke and Aleks Kissinger. "Categorical Quantum Mechanics II: Classical-Quantum Interaction". 05/27/2016. arXiv: 1605.08617v1 [quant-ph].

[5] Geoffrey Cruttwell, Michael Lambert, Dorette Pronk, and Martin Szyld. Double Fibrations. 05/30/2022. arXiv: 2205.15240 [math], URL: http://arxiv.org/abs/2205.15240 (visited on $03 / 20 / 2023$ ). preprint.

[6] Justin Dauwels. "On Variational Message Passing on Factor Graphs". In: 2007 IEEE International Symposium on Information Theory. 2007 IEEE International Symposium on Information Theory. Nice: IEEE, 06/2007, pp. 2546-2550. ISBN: 978-1-4244-1397-3. DOI: 10.1109/ISIT.2007.4557602, URL: http://ieeexplore.ieee.org/document/4557602/ (visited on 11/14/2023).

[7] Brendan Fong. "Causal Theories: A Categorical Perspective on Bayesian Networks". University of Oxford, 2013-01-26, 2013. arXiv: 1301.6201v1 [math.PR]. URL: http://arxiv.org/abs/ 1301.6201 .

[8] Brendan Fong. "Decorated Cospans". In: Theory and Applications of Categories 30.33 (2015), pp. 1096-1120. arXiv: 1502.00872. URL: http://www.tac.mta.ca/tac/volumes/30/33/ 30-33abs.html.

[9] Brendan Fong and David I. Spivak. "Hypergraph Categories". In: Journal of Pure and Applied Algebra 223.11 (11/2019), pp. 4746-4777. ISSN: 00224049. DOI: 10.1016/j.jpaa.2019.02.014. arXiv: 1806.08304v3 [math.CT], URL: https://linkinghub.elsevier.com/retrieve/ pii/S0022404919300489 (visited on 12/17/2022).

[10] Tobias Fritz. "A Synthetic Approach to Markov Kernels, Conditional Independence and Theorems on Sufficient Statistics". In: Advances in Mathematics 370.107239 (08/19/2019). DOI: 10.1016/j.aim.2020.107239. arXiv: 1908.07021v3 [math.ST].

[11] Bart Jacobs. Categorical Logic and Type Theory. Vol. 141. Studies in Logic and the Foundations of Mathematics. North-Holland Publishing Co., Amsterdam, 1999, pp. xviii+760. ISBN: 0-44450170-3.

[12] Magnus Koudahl, Thijs van de Laar, and Bert de Vries. Realising Synthetic Active Inference Agents, Part I: Epistemic Objectives and Graphical Specification Language. 06/13/2023. arXiv: 2306.08014 [cs], URL: http://arxiv.org/abs/2306.08014 (visited on 07/28/2023). preprint.

[13] Joe Moeller and Christina Vasilakopoulou. "Monoidal Grothendieck Construction". In: Theory and Applications of Categories 35.31 (2020), pp. 1159-1207. arXiv: 1809.00727v2 [math.CT]

[14] nLab authors. Categorical Semantics of Dependent Type Theory. 06/2024. URL: https:// ncatlab.org/nlab/show/categorical+semantics+of+dependent+type+theory.

[15] Evan Patterson. Structured and Decorated Cospans from the Viewpoint of Double Category Theory. 04/02/2023. arXiv: 2304.00447 [math], URL: http://arxiv.org/abs/2304.00447 (visited on 04/20/2023). preprint.

[16] Urs Schreiber. "Quantization via Linear Homotopy Types". 02/27/2014. arXiv: 1402.7041 [math-ph].

[17] David I. Spivak. The Operad of Wiring Diagrams: Formalizing a Graphical Language for Databases, Recursion, and Plug-and-Play Circuits. 05/01/2013. arXiv: 1305.0297 [cs, math]. URL: http://arxiv.org/abs/1305.0297(visited on 12/23/2022). preprint.

[18] Toby St Clere Smithe. "Approximate Inference via Fibrations of Statistical Games". In: Electronic Proceedings in Theoretical Computer Science. Applied Category Theory 2023. Vol. 397. College Park, MD: Open Publishing Association, 06/29/2023, pp. 279-298. DOI: 10.4204/EPTCS.397.17, arXiv: 2306.17009 [math, stat], URL: http://arxiv.org/abs/ 2306.17009 (visited on 09/11/2023).

[19] Sam Staton. "Commutative Semantics for Probabilistic Programming". In: Programming Languages and Systems. Springer Berlin Heidelberg, 2017, pp. 855-879. DOI: 10.1007/978-3-662-54434-1_32

[20] Martin J. Wainwright and Michael I. Jordan. "Graphical Models, Exponential Families, and Variational Inference". In: Foundations and Trends $®$ in Machine Learning 1.1-2 (2007), pp. 1-305. ISSN: 1935-8245. DOI:10.1561/2200000001, URL: http://dx.doi.org/10.1561/ 2200000001 .

[21] Donald Yau. Operads of Wiring Diagrams. Vol. 2192. Lecture Notes in Mathematics. Cham: Springer International Publishing, 2018. ISBN: 978-3-319-95000-6 978-3-319-95001-3. DOI: 10.1007/978-3-319-95001-3, arXiv: 1512.01602 [math]. URL: http://link.springer. com/10.1007/978-3-319-95001-3 (visited on 09/11/2023).

\section*{A Directed models}

\section*{A. 1 Kernels bifibration}

Proof of Proposition 2.9 Suppose $(E, p) \stackrel{h}{h}(F, q) \stackrel{k}{\leadsto}(G, r)$ over B. Then, by the definitions of fibrewise restriction and of kernel composition,

$$
(k \circ h)[b]:\left(x_{b}, V_{b}\right) \mapsto \int_{y: F} k\left(y, \pi_{G}\left(V_{b}\right)\right) h\left(\pi_{E}\left(x_{b}\right), \mathrm{d} y\right)
$$

Now, by the condition on kernels over $B$, the measure $h\left(\pi_{E}\left(x_{b}\right),-\right)$ is only supported over $b$, so we can write the integral as

$$
\int_{y_{b}: q[b]} k\left(\pi_{F}\left(y_{b}\right), \pi_{G}\left(V_{b}\right)\right) h\left(\pi_{E}\left(x_{b}\right), \pi_{F}(\mathrm{~d} y)\right)
$$

But, again by their definition, this is equal to

$$
\int_{y_{b}: q[b]} k[b]\left(y_{b}, V_{b}\right) h[b]\left(x_{b}, \mathrm{~d} y_{b}\right)
$$

and hence to $(k[b] \circ h[b])\left(x_{b}, V_{b}\right)$. So $(k \circ h)[b]=k[b] \circ h[b]$.

Definition A. 1 (Pushforward). Suppose $k: X \rightsquigarrow Y$ is a kernel and $f: Y \rightarrow Z$ is a measurable function. Then the pushforward of $k$ along $f$, sometimes denoted $f_{*} k$, is the kernel $X \leadsto Z$ defined by the composite $\delta_{f} \circ k$ in sfKrn. Note that this composite satisfies $\left(\delta_{f} \circ k\right)(x, C)=k\left(x, f^{-1}(C)\right)$ where $f^{-1}(C)$ is the preimage of $C$ through $f$.

Proof of Proposition [2.13] We need to exhibit an isomorphism

$$
\begin{aligned}
\mathscr{K}_{B}\left(p, \Delta_{f} q\right) & -(-)^{b} \longrightarrow \mathscr{K}_{C}\left(\Sigma_{f} p, q\right) \\
& \longleftarrow(-)^{\sharp}-{ }^{2}
\end{aligned}
$$

natural in $p$ and $q$.

Suppose then that we have $\beta: p \rightsquigarrow \Delta_{f} q$ in $\mathscr{K}_{B}$ and $\gamma: \Sigma_{f} p \rightsquigarrow q$ in $\mathscr{K}_{C}$ as in the following diagrams:
![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-15.jpg?height=320&width=952&top_left_y=1713&top_left_x=585)

Define $\beta^{b}: \Sigma_{f} p \rightsquigarrow q$ by the kernel

$$
E \times \Sigma_{F} \rightarrow[0, \infty]:(x, V) \mapsto \beta\left(x, \pi_{F}^{-1}(V)\right)
$$

where $\pi_{F}^{-1}(V)$ is the preimage of $V$ through the projection $\pi_{F}: f^{*} F \rightarrow F$ out of the pullback $f^{*} F$.

Dually, define $\gamma^{\sharp}: p \rightsquigarrow \Delta_{f} q$ by the kernel

$$
E \times \Sigma_{f^{*} F} \rightarrow[0, \infty]:(x, U) \mapsto \gamma\left(x, \pi_{F}(U)\right)
$$

Our first task is to check that these yield well-defined morphisms: that $\beta^{b}$ and $\gamma^{\sharp}$ satisfy the triangle conditions in $\mathscr{K}_{C}$ and $\mathscr{K}_{B}$ respectively, that $\delta_{q} \circ \beta^{b}=\delta_{f \circ p}$ and $\delta_{f} *_{q} \circ \gamma^{\sharp}=\delta_{p}$. For the former, we have the following chain of equalities:

$$
\begin{aligned}
\left(\delta_{q} \circ \beta^{b}\right)(x, V) & =\beta^{b}\left(x, q^{-1}(V)\right) & & \text { by pushforward (Def. A.1) } \\
& =\beta\left(x, \pi_{F}^{-1} q^{-1}(V)\right) & & \text { by definition of } b \\
& =\beta\left(x,\left(f^{*} q\right)^{-1} f^{-1}(V)\right) & & \text { by pullback of } q \text { along } f \\
& =\left(\delta_{f * *} \circ \beta\right)\left(x, f^{-1}(V)\right) & & \text { by pushforward } \\
& =\left[p(x) \in f^{-1}(V)\right] & & \text { since } \delta_{p}=\delta_{f^{*} q} \circ \beta \text { in } \mathscr{K}_{B} \\
& =[(f \circ p)(x) \in V] & & \text { by preimage } \\
& =\delta_{f \circ p}(x, V) & & \text { by definition of } \delta
\end{aligned}
$$

Similarly, for the latter, we have the following:

$$
\begin{aligned}
\left(\delta_{f^{*} q} \circ \gamma^{\sharp}\right)(x, U) & =\gamma^{\sharp}\left(x,\left(f^{*} q\right)^{-1}(U)\right) & & \text { by pushforward } \\
& =\gamma\left(x, \pi_{F}\left(\left(f^{*} q\right)^{-1}(U)\right)\right) & & \text { by definition of } \sharp \\
& =\gamma\left(x, q^{-1}(f(U))\right) & & \text { by pullback of } q \text { along } f \\
& =\left(\delta_{q} \circ \gamma\right)\left(x, q^{-1}(f(U))\right) & & \text { by pushforward } \\
& =\left[p(x) \in f^{-1}(f(U))\right] & & \text { since } \delta_{f \circ p}=\delta_{q} \circ \gamma \text { in } \mathscr{K}_{C} \\
& =[p(x) \in U] & & \text { by preimage } \\
& =\delta_{p}(x, U) & & \text { by definition of } \delta
\end{aligned}
$$

This establishes that $\beta^{b}$ and $\gamma^{\sharp}$ are well-defined morphisms in their respective fibre categories. That the maps $(-)^{b}$ and $(-)^{\sharp}$ constitute an isomorphism of hom sets is immediate from the fact that images and preimages are mutually inverse: $\pi_{F}^{-1}\left(\pi_{F}(U)\right)=U$ and $\pi_{F}\left(\pi_{F}^{-1}(V)\right)=V$.

It therefore only remains to demonstrate naturality. Since $(-)^{b}$ and $(-)^{\sharp}$ are mutually inverse, we need only demonstrate naturality for one; we choose $(-)^{\sharp}$. This means showing that the following square commutes for all kernels $\varphi, \psi$ of appropriate type:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-16.jpg?height=293&width=708&top_left_y=1786&top_left_x=706)

Since the hom functors $\mathscr{K}_{C}$ and $\mathscr{K}_{B}$ act by pre- and post-composition, this requires establishing that

$$
o \stackrel{\varphi}{\leadsto} p \stackrel{\gamma_{\sharp}^{\sharp}}{\sim} \Delta_{f} q \stackrel{\Delta_{f} \psi}{\sim} \Delta_{f} r=\left(\Sigma_{f} o \stackrel{\Sigma_{f} \varphi}{\rightsquigarrow} \Sigma_{f} p \stackrel{\gamma}{\sim} q \stackrel{\psi}{\rightsquigarrow} r\right)^{\sharp} .
$$

We noted above that $\Sigma_{f} p[b] \cong p\left[f^{*} b\right]$; likewise, we have $\Delta_{f} q[b] \cong q[f \circ b]$, since the pasting of two
pullback squares is again a pullback square:

$$
\begin{aligned}
& \left(\Delta_{f} q\right)[b] \cong q[f \circ b] \xrightarrow{\pi_{f}^{* *}} f^{*} F \xrightarrow{\pi_{F}} F
\end{aligned}
$$

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-17.jpg?height=127&width=618&top_left_y=392&top_left_x=775)

Thus, working fibrewise, we have

$$
\gamma^{\sharp}[b](x, U)=\gamma^{\sharp}\left(\pi_{E}(x), \pi_{f^{*} F}(U)\right)=\gamma\left(\pi_{E}(x),\left(\pi_{F} \circ \pi_{f^{*} F}\right)(U)\right)=\gamma[f \circ b](x, U)
$$

i.e. $\gamma_{b}^{\sharp}=\gamma[f \circ b]$, and so

$$
\begin{aligned}
\left(\psi \circ \gamma \circ \Sigma_{f} \varphi\right)^{\sharp}[b](w, V)= & \left(\psi \circ \gamma \circ \Sigma_{f} \varphi\right)[f \circ b](w, V) \\
& \left(\text { since } \gamma^{\sharp}[b]=\gamma[f \circ b]\right) \\
= & \int_{y: q[f \circ b]} \psi[f \circ b](y, V) \int_{x: \Sigma_{f} p[f \circ b]} \gamma[f \circ b](x, \mathrm{~d} y)\left(\Sigma_{f} \varphi\right)[f \circ b](w, \mathrm{~d} x) \\
& (\text { by fibrewise composition }) \\
= & \int_{y: q[f \circ b]} \psi[f \circ b](y, V) \int_{x: p[b]} \gamma[f \circ b](x, \mathrm{~d} y) \varphi[b](w, \mathrm{~d} x) \\
\quad & \left(\text { since } \Sigma_{f} p[f \circ b] \cong p\left[f^{*}(f \circ b)\right] \cong p[b]\right) \\
= & \int_{y: q[f \circ b]} \psi[f \circ b](y, V) \int_{x: p[b]} \gamma^{\sharp}[b](x, \mathrm{~d} y) \varphi[b](w, \mathrm{~d} x) \\
\quad & \text { (since } \left.\gamma^{\sharp}[b]=\gamma[f \circ b]\right) \\
= & \int_{y: \Delta_{f} q[b]}\left(\Delta_{f} \psi\right)[b](y, V) \int_{x: p[b]} \gamma^{\sharp}[b](x, \mathrm{~d} y) \varphi[b](w, \mathrm{~d} x) \\
= & \left(\Delta_{f} \psi \circ \gamma^{\sharp} \circ \varphi\right)[b](w, V)
\end{aligned}
$$

(by fibrewise composition).

This establishes that $\Sigma_{f} \dashv \Delta_{f}$.

Proof of Proposition 2.14 The functor $\Sigma_{\rho} \Delta_{\pi}: \mathscr{K}_{E} \rightarrow \mathscr{K}_{F}$ sends $X \xrightarrow{\alpha} E$ to $\pi^{*} X \xrightarrow{\Delta_{\pi} \alpha} P \xrightarrow{\rho} F$; fibrewise, by adjointness, we have $\Sigma_{\rho} \Delta_{\pi}(\alpha)[i] \cong \alpha\left[\pi \circ \rho^{*} i\right]$ and, on morphisms $f$, we have $\Sigma_{\rho} \Delta_{\pi}(f)[i]=$ $f\left[\pi \circ \rho^{*} i\right]$. On the other side, the functor $\Delta_{q} \Sigma_{p}$ sends $\alpha$ to $q^{*} X \xrightarrow{\Delta_{q} \alpha} q^{*} E \xrightarrow{\Delta_{q} p} F$; fibrewise, we have $\Delta_{q} \Sigma_{p}(\alpha)[i] \cong \alpha\left[p^{*}(q \circ i)\right]$ on objects and $\Delta_{q} \Sigma_{p}(f)[i]=f\left[p^{*}(q \circ i)\right]$ on morphisms. It therefore suffices to show that $p^{*}(q \circ i)=\pi \circ \rho^{*} i$ in Meas. This follows from the universal property of the pullback, which implies that the pasting of two pullback squares is again a pullback square:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-17.jpg?height=252&width=353&top_left_y=2167&top_left_x=886)

The outer and inner squares are thus both pullbacks of $p$ along $q \circ i$, and hence we must have $p^{*}(q \circ i)=$ $\pi \circ \rho^{*} i$. This yields an isomorphism $\Sigma_{\rho} \Delta_{\pi}(\alpha) \cong \Delta_{q} \Sigma_{p}(\alpha)$ rather than an equality because universal constructions are only unique up to natural isomorphism; and thus the naturality of this isomorphism follows similarly from universality.

\section*{A. 2 Pull-push sections}

Proof of Theorem 2.17 Much of the structure is simplified, owing to the trivial vertical decorations and the decoration of the apices by sets. Thus, for example, each component $\mu_{m, n}$ or $\eta_{E}$ of the pseudo natural transformations $\mu$ or $\eta$ is only a function (discrete functor). In the main text, the functoriality of $S_{0}$ and $S_{1}$ is justified. So here we will only justify the (pseudo) naturality of $\mu$ and $\eta$ and their (pseudo) associativity and unitality.

Suppose then that $f: m \rightarrow m^{\prime}$ and $g: n \rightarrow n^{\prime}$ are horizontally composable morphisms of spans (i.e., such that $g_{l}=f_{r}$ ) from $m=(A \stackrel{a}{\leftarrow} E \xrightarrow{b} B)$ and $n=(B \stackrel{\bar{b}}{\leftarrow} F \xrightarrow{c} C)$ to $m^{\prime}=\left(A^{\prime} \stackrel{a^{\prime}}{\leftarrow} E^{\prime} \xrightarrow{b^{\prime}} B^{\prime}\right)$ and $n^{\prime}=$ $\left(B^{\prime} \stackrel{\bar{b}^{\prime}}{\leftarrow} F \xrightarrow{c^{\prime}} C^{\prime}\right)$. To validate the pseudo naturality of $\mu$ is to confirm the commutativity of the square

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-18.jpg?height=214&width=613&top_left_y=996&top_left_x=756)

up to natural isomorphism. The top-right composite evaluates to

$$
\begin{array}{rlr}
S_{1}(g \diamond f)\left(\Sigma_{a^{\prime}} \Delta_{b^{\prime}}\left(\tau^{\prime}\right) \circ \sigma^{\prime}\right) & =\Delta_{f_{l}}\left(\Sigma_{a^{\prime}} \Delta_{b^{\prime}}\left(\tau^{\prime}\right) \circ \sigma^{\prime}\right) & \text { (by definition) } \\
& =\Delta_{f_{l}} \Sigma_{a^{\prime}} \Delta_{b^{\prime}}\left(\tau^{\prime}\right) \circ \Delta_{f_{l}}\left(\sigma^{\prime}\right) & \text { (by functoriality) }
\end{array}
$$

while the left-bottom composite evaluates to

$$
\begin{aligned}
& \Sigma_{a} \Delta_{b}\left(S_{1}(g)\left(\tau^{\prime}\right)\right) \circ S_{1}(f)\left(\sigma^{\prime}\right)=\Sigma_{a} \Delta_{b} \Delta_{g_{l}}\left(\tau^{\prime}\right) \circ \Delta_{f_{l}}\left(\sigma^{\prime}\right) \\
& =\Sigma_{a} \Delta_{f} \Delta_{b^{\prime}}\left(\tau^{\prime}\right) \circ \Delta_{f_{l}}\left(\sigma^{\prime}\right) \\
& \cong \Delta_{f_{l}} \Sigma_{a^{\prime}} \Delta_{b^{\prime}}\left(\tau^{\prime}\right) \circ \Delta_{f_{i}}\left(\sigma^{\prime}\right)
\end{aligned}
$$

and so $S_{1}(g \diamond f) \circ \mu_{m^{\prime}, n^{\prime}} \cong \mu_{m, n} \circ\left(S_{1}(f) \times S_{1}(g)\right)$ as required.

Validating the pseudo naturality of $\eta$ means, for any $f: E \rightarrow F$ in $\mathscr{B}$, validating that $\eta_{F} \cong S_{1}(f) \circ \eta_{E}$, i.e., $\eta_{F} \cong \Delta_{f} \eta_{E}$. Since $\eta_{E}$ is the identity on $l E$ and $\Delta_{f}$ is a functor, it must preserve identities. So in fact $\eta$ is strictly natural (just as pull-push copy-composition is strictly unital, as we confirm below).

To validate pseudo associativity, suppose $m$ and $n$ are spans as before and $o=(C \stackrel{\bar{c}}{\leftarrow} \xrightarrow{d} D)$. We need to show that $\mu_{n \triangleleft m, o}\left(\mu_{m, n}(\sigma, \tau), \rho\right) \cong \mu_{m, o \circ n}\left(\sigma, \mu_{n, o}(\tau, \rho)\right)$ for all appropriately typed sections $\sigma, \tau, \rho$. This obtains as follows:

$$
\begin{aligned}
\mu_{n \triangleleft m, o}\left(\mu_{m, n}(\sigma, \tau), \rho\right) & =\mu_{n \triangleleft m, o}\left(\Sigma_{a} \Delta_{b}(\tau) \circ \sigma, \rho\right) \\
& =\Sigma_{a} \Sigma_{\pi_{E}} \Delta_{\pi_{F}} \Delta_{c}(\rho) \circ \Sigma_{a} \Delta_{b}(\tau) \circ \sigma \\
& \cong \Sigma_{a} \Delta_{b} \Sigma_{\bar{b}} \Delta_{c}(\rho) \circ \Sigma_{a} \Delta_{b}(\tau) \circ \sigma \\
& =\Sigma_{a} \Delta_{b}\left(\Sigma_{\bar{b}} \Delta_{c}(\rho) \circ \tau\right) \circ \sigma \\
& =\mu_{m, \circ \circ n}\left(\sigma, \Sigma_{\bar{b}} \Delta_{c}(\rho) \circ \tau\right) \\
& =\mu_{m, o \circ n}\left(\sigma, \mu_{n, o}(\tau, \rho)\right)
\end{aligned}
$$

(by definition)

(by definition)

(by Beck-Chevalley)

(by functoriality)

(by definition)

(by definition)
where $\pi_{E}$ and $\pi_{F}$ are the projections out of the pullback of $\bar{b}$ along $b$.

Finally, strict unitality demands that $\mu_{\mathrm{id}_{B}, n}\left(\eta_{B}, \tau\right)=\tau$ and $\mu_{m, \mathrm{id}_{B}}\left(\sigma, \eta_{B}\right)=\sigma$. We have

$$
\mu_{\mathrm{id}_{B}, n}\left(\eta_{B}, \tau\right)=\Sigma_{\mathrm{id}_{B}} \Delta_{\mathrm{id}_{B}}(\tau) \circ \eta_{B}=\tau \circ \mathrm{id}_{I_{B}}=\tau
$$

and

$$
\mu_{m, \mathrm{id}_{B}}\left(\sigma, \eta_{B}\right)=\Sigma_{a} \Delta_{b}\left(\eta_{B}\right) \circ \sigma=\Sigma_{a} \Delta_{b}\left(\mathrm{id}_{l_{B}}\right) \circ \sigma=\Sigma_{a}\left(\mathrm{id}_{l_{E}}\right) \circ \sigma=\mathrm{id}_{\Sigma_{a} l_{E}} \circ \sigma=\sigma
$$

as required.

\section*{B Factor graphs}

\section*{B. 1 Constructing the horizontal decorations}

The apex decoration has a peculiar form, with one category of decorating data (the interfaces) further decorated by a family of others (the factors). This is because the apex decorations are themselves obtained by a Grothendieck construction, defined functorially for each finite set. The first step in this construction is to define the interface categories. Since we have the cospans determining which parts of the interfaces are exposed for factor composition, there may now be some parts which remain 'latent', and transformations of these parts are not constrained to be comonoid homomorphisms. That is, we can allow the transformations of the latent parts of the interfaces to be arbitrary morphisms in $\mathscr{C}$, as long as the exposed parts remain constrained as before5.

This line of thought formalizes as follows. Given a cospan $m:(A \xrightarrow{a} X \stackrel{b}{\leftarrow} B)$, we first define an enlarged version of $F_{0} X$, not totally restricted to comonoid homomorphisms. We denote this enlargement by $\tilde{F}_{0} m$ and construct it as the following limit of categories, so that we do still have comonoid homomorphisms over the legs:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-19.jpg?height=293&width=1431&top_left_y=1458&top_left_x=344)

Note that, because the left and right vertical functors in this diagram are embeddings, so is the induced functor $\tilde{F}_{0} m \rightarrow \operatorname{Cat}(\operatorname{disc} X, \mathscr{C})$. We can therefore understand $\tilde{F}_{0} m$ as the wide subcategory of $\operatorname{Cat}(\operatorname{disc} X, \mathscr{C})$ whose morphisms are those $X$-indexed families of morphisms of $\mathscr{C}$ whose $A$ - and $B$-components are comonoid homomorphisms.

The next step is to decorate $\tilde{F}_{0} m$ with factors. Since $\mathscr{C}$ is a category, factors on an interface $\chi$ : $\operatorname{disc} X \rightarrow \mathscr{C}$ form a set $\mathscr{C}\left(\chi^{\otimes}, I\right)$. We thus define a presheaf $\underline{F_{1}} m: \tilde{F}_{0} m^{\mathrm{op}} \rightarrow$ Set as follows. On objects (interfaces) $\chi$, we define $\underline{F_{1}} m(\chi)$ to be $\mathscr{C}\left(\chi^{\otimes}, I\right)$. On morphisms of interfaces $\varphi: \chi \rightarrow \chi^{\prime}$, we set $\underline{F_{1}} m(\varphi)$ : $\underline{F_{1}} m\left(\chi^{\prime}\right) \rightarrow \underline{F_{1}} m(\chi)$ to be the precomposition functor $\mathscr{C}\left(\varphi^{\otimes}, I\right): \mathscr{C}\left(\chi^{\prime \otimes}, I\right) \rightarrow \mathscr{C}\left(\chi^{\otimes}, I\right)$ and denote it by $\overline{\varphi^{*}}$. This yields a well-defined presheaf by the functoriality of $\otimes$ and of precomposition. The apex decoration returned by $F_{1}$ on $m$ is then given by the 1-categorical Grothendieck construction of $\underline{F_{1}} m$ (its category of elements), denoted $\int \underline{F_{1}} m$, whose objects and morphisms are as described in the main text.
\footnotetext{
${ }^{5}$ It is this part of the construction that means we cannot use Fong's original decorated cospans: here, the decoration on the apex necessarily depends on the legs, in order that we have comonoid homomorphisms in the right places.
}

This tells us how to decorate the apices of cospans - but, given the cospan $m, F_{1}$ needs to return a whole span of categories $F_{0} A \stackrel{\pi_{a}}{\longleftrightarrow} \int \underline{F_{1}} m \xrightarrow{\pi_{b}} F_{0} B$. We obtain the legs of this span through the universal properties of the construction of $\int \underline{F_{1}} m$. First, because $\int \underline{F_{1}} m$ is obtained by a Grothendieck construction, it is equipped with a projection functor $\pi_{m}: \int \underline{F_{1}} m \rightarrow \tilde{F}_{0} m$ which acts by 'forgetting' the factors; i.e. $\pi_{m}(\chi, f)=\chi$. Next, the construction of $\tilde{F}_{0} m$ as a limit means that it is equipped with canonical projection functors to $F_{0} A$ and $F_{0} B$ :

$$
F_{0} A=\operatorname{Cat}(\operatorname{disc} A, \operatorname{Comon}(\mathscr{C})) \prec-\cdots \tilde{F}_{0} m \cdots-->\operatorname{Cat}(\operatorname{disc} B, \operatorname{Comon}(\mathscr{C}))=F_{0} B
$$

Therefore, we obtain the requisite span of categories $F_{1} m:=\left(F_{0} A \stackrel{\pi_{a}}{\leftarrow} \int \underline{F_{1}} m \xrightarrow{\pi_{b}} F_{0} B\right)$ as the composition of this span of limit projections with $\pi_{m}$ :

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-20.jpg?height=314&width=658&top_left_y=851&top_left_x=728)

We now need to define the action of $F_{1}$ on morphisms of cospans. Suppose that $m^{\prime}:=\left(A^{\prime} \stackrel{a^{\prime}}{\leftarrow} X^{\prime} \stackrel{B^{\prime}}{\leftrightarrows}\right)$ is another cospan. A morphism $\phi: m \rightarrow m^{\prime}$ is a triple ( $\phi_{l}, \phi, \phi_{r}$ ) of maps of finite sets making the following diagram commute:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-20.jpg?height=283&width=582&top_left_y=1379&top_left_x=769)

We know from the treatment above that $F_{0}$ is functorial, and this yields the action of $F_{1}$ on the left and right components $\phi_{l}$ and $\phi_{r}$. Moreover, the construction of $\int F_{1} m$ is functorial: first, the construction of $\tilde{F}_{0} m$ is functorial in $m$, by the functoriality of taking limits. Likewise, the Grothendieck construction is functorial, yielding a functor $\int \underline{F_{1}}:$ FinSet $^{\{\bullet \rightarrow \bullet \leftarrow \bullet\}} \rightarrow$ Cat. The following diagram then commutes by construction:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-20.jpg?height=355&width=737&top_left_y=1926&top_left_x=691)

Consequently, we define the action of $F_{1}$ on the morphism of cospans $\phi$ to return the morphism of spans $F_{1} \phi$ whose components are $\left(F_{0} \phi_{l}, \int \underline{F_{1}} \phi, F_{0} \phi_{r}\right)$, and we see that this action is functorial by construction.

\section*{B. 2 The horizontal composition}

$\mu$ must be a pseudo natural transformation filling the following diagram:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-21.jpg?height=293&width=1054&top_left_y=431&top_left_x=530)

The external composition $\diamond_{\mathbb{C o s p a n}(\text { FinSet) }}$ acts on composable cospans by pushout, taking $m:(A \xrightarrow{a} X \stackrel{b}{\leftarrow} B)$ and $n:\left(B \xrightarrow{b^{\prime}} Y \stackrel{c}{\leftarrow} C\right)$ to the outer cospan in the pushout diagram

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-21.jpg?height=301&width=766&top_left_y=961&top_left_x=685)

(Psuedo functoriality of $\diamond_{\text {Cospan(FinSet) }}$ follows from the universal properties of colimits.) The composite pseudo functor along the top and right of the above diagram therefore acts on $m$ and $n$ to yield the span of categories

$$
F_{0} A \stackrel{\pi_{X} \circ a}{\leftarrow} \int \underline{F_{1}}(n \diamond m) \xrightarrow{\pi_{\mathrm{IY} \circ c}} F_{0} C .
$$

Dually, $\diamond_{\text {Span(Cat) }}$ acts on composable spans by pullback, so that the composite pseudo functor along the left and bottom of the diagram acts to yield the outer span in the following diagram:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-21.jpg?height=414&width=1084&top_left_y=1750&top_left_x=518)

Note that, here and throughout this section, $\pi_{m}$ and $\pi_{n}$ are the projections out of the pullback, rather than the Grothendieck fibrations of the previous section.

In both cases, the feet of the span are $F_{0} A$ and $F_{0} C$ on the left and right respectively; this must be the case for $F$ to be a well-defined double functor. Consequently, the component of $\mu$ at $(m, n)$, denoted
$\mu_{m, n}$, must be a functor $\int \underline{F_{1}} m \times_{F_{0} B} \int \underline{F_{1}} n \rightarrow \int \underline{F_{1}}(n \diamond m)$ making this diagram commute:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-22.jpg?height=596&width=1090&top_left_y=336&top_left_x=515)

This means that $\mu_{m, n}$ takes a pair of factors over $X$ and $Y$, that are composable by agreeing over $B$, and returns a composite factor over $X+{ }_{B} Y$, all while preserving the exposed interfaces over $A$ and $C$. We define $\mu_{m, n}$ to act by copy-composition, as follows.

First, notice that both $\int \underline{F_{1}}(n \diamond m)$ and $\int \underline{F_{1}} m \times_{F_{0} B} \int \underline{F_{1}} n$ are (discrete) fibrations; the former over $\tilde{F}_{0}(n \diamond$ $m$ ) by definition and the latter over $\tilde{F}_{0} m \times{ }_{F_{0} B} \tilde{F}_{0} n$, by the universal property of the pullback:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-22.jpg?height=694&width=734&top_left_y=1233&top_left_x=693)

$\mu_{m, n}$ should therefore correspond to a morphism of fibrations. By the Grothendieck construction $\llbracket 13$, p.7], such a morphism is equivalent to a pair ( $\mu_{m, n}^{0}, \mu_{m, n}^{1}$ ) of a functor and a natural transformation as in the following diagram:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-22.jpg?height=285&width=753&top_left_y=2134&top_left_x=686)

To define the functor $\mu_{m, n}^{0}: \tilde{F}_{0} m \times_{F_{0} B} \tilde{F}_{0} n \rightarrow \tilde{F}_{0}(n \diamond m)$, note that the objects in its domain are pairs $(\chi, \gamma)$ of functors $\chi: \operatorname{disc} X \rightarrow \mathscr{C}$ and $\gamma:$ disc $Y \rightarrow \mathscr{C}$ that agree on $B$. By the universal properties of the coproduct $X+Y$ and the pushout $X+{ }_{B} Y$, there must be copairings $[\chi, \gamma]: \operatorname{disc}(X+Y) \rightarrow \mathscr{C}$ and $[\chi, \gamma]_{B}: \operatorname{disc}\left(X+{ }_{B} Y\right) \rightarrow \mathscr{C}$ making the following diagram commute; in particular, $[\chi, \gamma]$ must factor through $[\chi, \gamma]_{B}$ :

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-23.jpg?height=653&width=833&top_left_y=487&top_left_x=646)

Since the image of $(\chi, \gamma)$ under $\mu_{m, n}^{0}$ must be a functor $\operatorname{disc}\left(X+{ }_{B} Y\right) \rightarrow \mathscr{C}$, we make the universal definition $\mu_{m, n}^{0}(\chi, \gamma):=[\chi, \gamma]_{B}$. Functoriality follows from the functoriality of colimits.

The corresponding component of $\mu_{m, n}^{1}$ must then be a function

$$
\mu_{m, n}^{1}(\chi, \gamma): \mathscr{C}\left(\chi^{\otimes}, I\right) \times \mathscr{C}\left(\gamma^{\otimes}, I\right) \rightarrow \mathscr{C}\left([\chi, \gamma]_{B}^{\otimes}, I\right)
$$

Note that $[\chi, \gamma]^{\otimes} \cong \chi^{\otimes} \otimes \gamma^{\otimes}$. We can thus factor $\mu_{m, n}^{1}$ as

$$
\mathscr{C}\left(\chi^{\otimes}, I\right) \times \mathscr{C}\left(\gamma^{\otimes}, I\right) \xrightarrow{\otimes} \mathscr{C}\left(\chi^{\otimes} \otimes \gamma^{\otimes}, I\right) \xrightarrow{\sim} \mathscr{C}\left([\chi, \gamma]^{\otimes}, I\right) \rightarrow \mathscr{C}\left([\chi, \gamma]_{B}^{\otimes}, I\right)
$$

so that, by Yoneda, we seek a morphism $\delta_{\chi, \gamma}:[\chi, \gamma]_{B}^{\otimes} \rightarrow[\chi, \gamma]^{\otimes}$ in $\mathscr{C}$.

It is here that copying finally enters. For each $j: X+{ }_{B} Y$, copying induces a morphism

$$
\delta_{\chi, \gamma}^{j}:[\chi, \gamma]_{B}(j) \rightarrow \bigotimes_{i:\left[\left[_{B}^{X}, l_{B}^{Y}\right]-1\right.} \bigotimes^{1}[\chi, \gamma](i)
$$

in $\mathscr{C}$ which is unique up to coassociativity. Note that the codomain of this morphism is, by the pullback constraint, the monoidal product of $\left[\imath_{B}^{X}, l_{B}^{Y}\right]^{-1}(j)$-many copies of the same object $[\chi, \gamma]_{B}(j)$ so that this copying is well-defined; and when $j$ is not in the image of $B$, then this product is only unary, so that in this case, $\delta_{\chi, \gamma}^{j}$ is the corresonding identity morphism. Then

$$
\bigotimes_{j: X+{ }_{B} Y} \delta_{\chi, \gamma}^{j}: \bigotimes_{j: X+{ }_{B} Y}[\chi, \gamma]_{B}(j) \rightarrow \bigotimes_{j: X+{ }_{B} Y} \bigotimes_{i:\left[\left[l_{B}^{X}, l_{B}^{Y}\right]^{-1}(j)\right.}[\chi, \gamma](i)
$$

has the requisite type, since $\otimes_{j: X+{ }_{B} Y}[\chi, \gamma]_{B}(j)=[\chi, \gamma]_{B}^{\otimes}$ and

$$
\bigotimes_{j: X+{ }_{B} Y} \bigotimes_{\left.i:\left[l_{B}^{X}, l_{B}^{Y}\right]\right]^{-1}(j)}[\chi, \gamma](i)=\bigotimes_{i: X+Y}[\chi, \gamma](i)=[\chi, \gamma]^{\otimes}
$$
both by definition. Hence we define $\delta_{\chi, \gamma}:=\otimes_{j: X{ }_{B} Y} \delta_{\chi, \gamma}^{j}$.

We need to verify that $\delta_{\chi, \gamma}$ is natural in $\chi$ and $\gamma$. Since identity morphisms are always natural, we only need to check the case that $\left[\imath_{B}^{X}, l_{B}^{Y}\right]^{-1}(j)$ has more than one element - and this in turn only obtains for $j$ in the image of $B$. By construction, morphisms of interfaces on those components are necessarily comonoid homomorphisms, and these are the morphisms for which $\delta_{\chi, \gamma}^{j}$ is natural. Therefore, $\delta_{\chi, \gamma}$ is always natural in $\chi$ and $\gamma$, and since every factor of $\mu_{m, n}^{1}$ is accordingly natural, so is $\mu_{m, n}^{1}$ itself, as required.

This means that $\left(\mu_{m, n}^{0}, \mu_{m, n}^{1}\right)$ constitutes a well-defined morphism of indexed sets, thereby inducing a well-defined morphism $\mu_{m, n}$ of discrete fibrations. Thus, given factors $(\chi, f)$ and $(\gamma, g)$ that agree over $B$, the external composition $\mu_{m, n}$ acts to return $\left([\chi, \gamma]_{B},(f \otimes g) \circ \delta_{\chi, \gamma}\right)$.

We also need to define the unit $\eta$, a pseudo natural transformation as in the following diagram:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-24.jpg?height=285&width=572&top_left_y=806&top_left_x=771)

The component $\eta_{X}$ at each finite set $X$ is determined by a functor $\eta_{X}: F_{0} X \rightarrow \int \underline{F_{1}}\left(\right.$ id $\left._{X}\right)$ as in the diagram

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-24.jpg?height=228&width=523&top_left_y=1206&top_left_x=801)

where id ${ }_{X}$ denotes the identity cospan $X=X=X$ on $X$. Note that because $\int F_{1}\left(\right.$ id $\left._{X}\right)$ is defined over the identity span, $\tilde{F}_{0}(\mathrm{id} X) \cong F_{0} X$, and so $\pi_{X}$ simply forgets the factor decorations. Moreover, this means that all components of morphisms of interfaces in $\tilde{F}_{0}\left(\right.$ id $\left._{X}\right)$ are comonoid homomorphisms in $\mathscr{C}$.

We define $\eta_{X}$ using the counits of the comonoid structures on the interfaces on $X$. That is to say, $\eta_{X}$ maps an interface $\chi: \operatorname{disc} X \rightarrow \operatorname{Comon}(\mathscr{E})$ to the pair $\left(\chi, \varepsilon_{\chi}\right)$, where here $\varepsilon_{\chi}$ denotes the canonical discarding map $\chi^{\otimes} \rightarrow I$. The functoriality of $\eta_{X}$ follows from the fact that all morphisms in $F_{0} X$ are comonoid homomorphisms, so if $\varphi$ is a morphism $\chi \rightarrow \chi^{\prime}$ then $\varepsilon_{\chi}=\varphi^{*} \varepsilon_{\chi^{\prime}}$. Pseudo naturality of $\eta$ obtains likewise, and its unitality with respect to $\mu$ follows from the counitality of the comonoid counits.

At this final point, we should also validate the remaining laws that a lax double functor should satisfy: in particular, the associativity of $\mu$. However, we shall at this point simply assert that associativity follows from the associativity of $\otimes$, the coassociativity of the relevant comonoid structures, and the universal properties of the (co)limits involved in the constructions, leaving a detailed examination of this claim to future exposition.

\section*{B. 3 Graphical calculus}

The relationship between decorated cospans and undirected wiring diagram algebras indicates that factor graphs should be understood as composing 'operadically' (multicategorically): that is to say, by nesting; thus, within each factor of a factor graph may be hiding a whole other factor graph. This formalizes the situation sometimes encountered in the literature - e.g. Koudahl, van de Laar, and de Vries [12, Fig.20]

— in which a collection of factors is grouped into a composite factor, sometimes depicted by drawing an extra box around the collection.

To hew more closely to existing undirected wiring diagrams, as well as the standard string diagrams for monoidal categories, we will adopt a syntax in which factors are depicted with circular boxes, exposed variables by emanating wires, and transformation morphisms by rectangular boxes. We will depict comonoid homomorphisms as 'diamond' shaped boxes, both to indicate that they commute with horizontal composition $\diamond$ and also to suggest that they can pierce through the bubble enclosing a factor; this means we will attach wires to their corners. Conversely, we will depict arbitrary morphisms with standard rectangular boxes, attaching wires to their sides.

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-25.jpg?height=363&width=374&top_left_y=737&top_left_x=865)

Figure 2: A composite factor $f^{\prime}$.

Figure 2 shows a simple example of a composite factor $f^{\prime}$, constituted by another factor $f$ with three exposed variables, two of which are composed with transformations, one deterministic $(\varphi)$ and one not $(\psi)$. Thinking statistically, we can interpret exposed variables (dangling wires) as representing observed random variables. We can draw a bubble around the whole of Figure 2 to obtain a new factor with three unobserved variables; nonetheless these variables are observable, which we depict by terminating them with a black dot. As a horizontal 1-cell in $\mathbb{F} \mathbb{G}$, the resulting factor has the type $f_{0}: 0 \nrightarrow 0$, where 0 denotes the empty set.

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-25.jpg?height=437&width=501&top_left_y=1714&top_left_x=801)

The drawing of the bubble represents a 2-cell $f_{0} \Rightarrow f^{\prime}$. We can think of this 2 -cell, being directed from $f_{0}$ to $f^{\prime}$, as "reaching into $f_{0}$ ", pulling observable wires out to expose them as the wires of $f^{\prime}$.

We can compose $f$ with some factor $g$ (with a compatible interface), repurposing the black dot - or
spider, in the terminology of Coecke and Kissinger [4] - to represent the locus of composition:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-26.jpg?height=412&width=875&top_left_y=336&top_left_x=625)

(In this way, we can think of a one-legged spider, representing an observable variable, as a locus of potential composition.)

We can reach inside $g \diamond f^{\prime}$ to expose the internal wire:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-26.jpg?height=396&width=528&top_left_y=997&top_left_x=793)

And this gives us another way to understand the deterministic morphisms: as those that can slide past spiders, multiplying on the way into factors. For example, suppose have another composite factor $h^{\prime}$ involving $\varphi$, such as this:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-26.jpg?height=393&width=398&top_left_y=1560&top_left_x=861)

Then we could compose along $\varphi$ with $f^{\prime}$ to obtain $h^{\prime} \diamond f^{\prime}$ :

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-26.jpg?height=385&width=1168&top_left_y=2046&top_left_x=476)

Notice that here we have made use of the ability (but not necessity!) of copy-composition to couple multiple variables together.

If again we expose the composed variable, we can pull $\varphi$ outside, too:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-27.jpg?height=610&width=721&top_left_y=427&top_left_x=694)

Notice that, by using spiders, there would be no ambiguity if we omitted the outer bubble: observed variables are those that are not terminated in a one-legged spider; and deterministic transformations "push forward" from exposed variables to multiply through spiders in the direction of their target factors.

We can use non-deterministic morphisms to render observable variables unobservable, by 'marginalizing' them out. For instance, here we have marginalized out one of the observed variables of $h^{\prime}$ by transforming it with a state $v$ :

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-27.jpg?height=399&width=396&top_left_y=1329&top_left_x=859)

Here, we have used the standard string-diagrammatic representation of a state in $\mathscr{C}$.

Finally, let us depict the factor graph of Figure 1 in this language:

![](https://cdn.mathpix.com/cropped/2024_06_13_49e9ea75af24a1106332g-27.jpg?height=450&width=824&top_left_y=1846&top_left_x=648)

Note how similar this depiction is to the non-compositional form of Figure 11 the major change is the replacement of 'variable' nodes with (labelled) two-legged spiders, making the distinction between
observed and observable variables. Beyond this distinction, the syntax of $\mathbb{F} \mathbb{G}$ tells us precisely what kinds of compositions are allowed - including supplying notions of transformation of factors.